
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3. Scripts: Embedding script languages &#8212; GNATColl 2021 documentation</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4. Traces: Logging information" href="traces.html" />
    <link rel="prev" title="2. Building GNATColl" href="building.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="traces.html" title="4. Traces: Logging information"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="building.html" title="2. Building GNATColl"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">GNATColl 2021 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">3. </span><strong>Scripts</strong>: Embedding script languages</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="scripts-embedding-script-languages">
<span id="embedding-script-languages"></span><h1><span class="section-number">3. </span><strong>Scripts</strong>: Embedding script languages<a class="headerlink" href="#scripts-embedding-script-languages" title="Permalink to this headline">¶</a></h1>
<p>In a lot of contexts, you want to give the possibility to users to extend
your application. This can be done in several ways: define an Ada API from
which they can build dynamically loadable modules, provide the whole source
code to your application and let users recompile it, interface with a simpler
scripting languages,…</p>
<p>Dynamically loadable modules can be loaded on demand, as their name indicate.
However, they generally require a relatively complex environment to build,
and are somewhat less portable. But when your users are familiar with Ada,
they provide a programming environment in which they are comfortable.
As usual, changing the module requires recompilation, re-installation,…</p>
<p>Providing the source code to your application is generally even more
complex for users. This requires an even more complex setup, your application
is generally too big for users to dive into, and modifications done by one
users are hard to provide to other users, or will be lost when you
distribute a new version of your application.</p>
<p>The third solution is to embed one or more scripting languages in your
application, and export some functions to it. This often requires your users
to learn a new language, but these languages are generally relatively simple,
and since they are interpreted they are easier to learn in an interactive
console. The resulting scripts can easily be redistributed to other users or
even distributed with future versions of your application.</p>
<p>The module in GNATColl helps you implement the third solution. It was
used extensively in the GPS programming environment for its python interface.</p>
<p><a class="reference internal" href="_images/tip.png"><img alt="TIP:" src="_images/tip.png" style="width: 15pt;" /></a> Each of the scripting language is optional</p>
<p>This module can be compiled with any of these languages as an optional
dependency (except for the shell language, which is always built-in, but is
extremely minimal, and doesn’t have to be loaded at run time anyway).
If the necessary libraries are found on the system, GNATColl will
be build with support for the corresponding language, but your application
can chose at run time whether or not to activate the support for a specific
language.</p>
<span class="target" id="index-0"></span><p id="index-1"><a class="reference internal" href="_images/tip.png"><img alt="TIP:" src="_images/tip.png" style="width: 15pt;" /></a> Use a scripting language to provide an automatic testing framework for
your application.</p>
<p>The GPS environment uses python command for its <em>automatic test suite</em>,
including graphical tests such as pressing on a button, selecting a
menu,…</p>
<div class="section" id="supported-languages">
<span id="id1"></span><h2><span class="section-number">3.1. </span>Supported languages<a class="headerlink" href="#supported-languages" title="Permalink to this headline">¶</a></h2>
<p>The module provides built-in support for several scripting languages, and
other languages can “easily” be added. Your application does not change
when new languages are added, since the interface to export subprograms
and classes to the scripting languages is language-neutral, and will
automatically export to all known scripting languages.</p>
<p>The Core component provides support for the following language:</p>
<dl class="simple">
<dt><em>Shell</em></dt><dd><p>This is a very simple-minded scripting language, which doesn’t provide
flow-control instructions (<a class="reference internal" href="#the-shell-language"><span class="std std-ref">The Shell language</span></a>).</p>
</dd>
</dl>
<p>Optional components add support for other languages, e.g. Python. Please
refer to the corresponding component’s documentation.</p>
<div class="section" id="the-shell-language">
<span id="id2"></span><h3><span class="section-number">3.1.1. </span>The Shell language<a class="headerlink" href="#the-shell-language" title="Permalink to this headline">¶</a></h3>
<p>The shell language was initially developed in the context of the GPS
programming environment, as a way to embed scripting commands in XML
configuration files.</p>
<p>In this language, you can execute any of the commands exported by the
application, passing any number of arguments they need. Arguments to function
calls can, but need not, be quoted. Quoting is only mandatory when they
contain spaces, newline characters, or double-quotes (‘”’). To quote an
argument, surround it by double-quotes, and precede each double-quote it
contains by a backslash character. Another way of quoting is similar to
what python provides, which is to triple-quote the argument, i.e. surround it
by ‘”””’ on each side. In such a case, any special character (in particular
other double-quotes or backslashes) lose their special meaning and are just
taken as part of the argument. This is in particular useful when you do not
know in advance the contents of the argument you are quoting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Shell</span><span class="o">&gt;</span> <span class="n">function_name</span> <span class="n">arg1</span> <span class="s2">&quot;arg 2&quot;</span> <span class="s2">&quot;&quot;&quot;arg 3&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Commands are executed as if on a stack machine: the result of a command is
pushed on the stack, and later commands can reference it using <cite>%</cite>
following by a number. By default, the number of previous results that are
kept is set to 9, and this can only be changed by modifying the source code
for GNATColl. The return values are also modified by commands executed
internally by your application, and that might have no visible output from
the user’s point of view. As a result, you should never assume you know
what <cite>%1</cite>,… contain unless you just executed a command in the
same script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Shell</span><span class="o">&gt;</span> <span class="n">function_name</span> <span class="n">arg1</span>
<span class="n">Shell</span><span class="o">&gt;</span> <span class="n">function2_name</span> <span class="o">%</span><span class="mi">1</span>
</pre></div>
</div>
<p>In particular, the <cite>%1</cite> syntax is used when emulating object-oriented
programming in the shell. A method of a class is just a particular function
that contains a ‘.’ in its name, and whose first implicit argument is the
instance on which it applies. This instance is generally the result of
calling a constructor in an earlier call. Assuming, for instance, that we
have exported a class “Base” to the shell from our Ada core, we could use
the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Shell</span><span class="o">&gt;</span> <span class="n">Base</span> <span class="n">arg1</span> <span class="n">arg2</span>
<span class="n">Shell</span><span class="o">&gt;</span> <span class="n">Base</span><span class="o">.</span><span class="n">method</span> <span class="o">%</span><span class="mi">1</span> <span class="n">arg1</span> <span class="n">arg2</span>
</pre></div>
</div>
<p>to create an instance and call one of its methods.
Of course, the shell is not the best language for object-oriented programming,
and better languages should be used instead.</p>
<p>When an instance has associated properties (which you can export from Ada
using <cite>Set_Property</cite>), you access the properties by prefixing its name
with “&#64;”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Shell</span><span class="o">&gt;</span> <span class="n">Base</span> <span class="n">arg1</span> <span class="n">arg2</span>   <span class="c1"># Build new instance</span>
<span class="n">Shell</span><span class="o">&gt;</span> <span class="nd">@id</span> <span class="o">%</span><span class="mi">1</span>           <span class="c1"># Access its &quot;id&quot; field</span>
<span class="n">Shell</span><span class="o">&gt;</span> <span class="nd">@id</span> <span class="o">%</span><span class="mi">1</span> <span class="mi">5</span>         <span class="c1"># Set its &quot;id&quot; field</span>
</pre></div>
</div>
<p>Some commands are automatically added to the shell when this scripting
language is added to the application. These are</p>
<dl class="simple" id="index-2">
<dt><cite>Function load (file)</cite></dt><dd><p>Loads the content of <cite>file</cite> from the disk, and execute each of its lines as
a Shell command. This can for instance be used to load scripts when your
application is loaded</p>
</dd>
</dl>
<dl class="simple" id="index-3">
<dt><cite>Function echo (arg…)</cite></dt><dd><p>This function takes any number of argument, and prints them in the console
associated with the language. By default, when in an interactive console, the
output of commands is automatically printed to the console. But when you
execute a script through <cite>load</cite> above, you need to explicitly call
<cite>echo</cite> to make some output visible.</p>
</dd>
</dl>
<dl class="simple" id="index-4">
<dt><cite>Function clear_cache</cite></dt><dd><p>This frees the memory used to store the output of previous commands. Calling
<cite>%1</cite> afterward will not make sense until further commands are executed.</p>
</dd>
</dl>
</div>
<div class="section" id="classes-exported-to-all-languages">
<span id="id3"></span><h3><span class="section-number">3.1.2. </span>Classes exported to all languages<a class="headerlink" href="#classes-exported-to-all-languages" title="Permalink to this headline">¶</a></h3>
<p>In addition to the functions exported by each specific scripting language,
as described above, GNATColl exports the following to all the
scripting languages. These are exported when your Ada code calls the
Ada procedure <cite>GNATCOLL.Scripts.Register_Standard_Classes</cite>, which should
done after you have loaded all the scripting languages.</p>
<dl id="index-5">
<dt><cite>Class Console</cite></dt><dd><p><cite>Console</cite> is a name that you can chose yourself when you call the
above Ada procedure. It will be assumed to be <cite>Console</cite> in the rest
of this document.</p>
<p>This class provides an interface to consoles. A console is an input/output
area in your application (whether it is a text area in a graphical
application, or simply standard text I/O in text mode). In particular,
the python standard output streams <cite>sys.stdin</cite>, <cite>sys.stdout</cite>
and <cite>sys.stderr</cite> are redirected to an instance of that class. If you
want to see python’s error messages or usual output in your application,
you must register that class, and define a default console for your
scripting language through calls to
<cite>GNATCOLL.Scripts.Set_Default_Console</cite>.</p>
<p>You can later add new methods to this class, which would be specific to your
application. Or you can derive this class into a new class to achieve a
similar goal.</p>
</dd>
</dl>
<dl class="simple" id="index-6">
<dt><cite>Console.write(text)</cite></dt><dd><p>This method writes <cite>text</cite> to the console associated with the class
instance. See the examples delivered with GNATColl for examples on
how to create a graphical window and make it into a <cite>Console</cite>.</p>
</dd>
</dl>
<dl class="simple" id="index-7">
<dt><cite>Console.clear()</cite></dt><dd><p>Clears the contents of the console.</p>
</dd>
</dl>
<dl class="simple" id="index-8">
<dt><cite>Console.flush()</cite></dt><dd><p>Does nothing currently, but is needed for compatibility with python.
Output through <cite>Console</cite> instances is not buffered anyway.</p>
</dd>
</dl>
<dl class="simple" id="index-9">
<dt><cite>Console.isatty(): Boolean</cite></dt><dd><p>Whether the console is a pseudo-terminal. This is always wrong in the
case of GNATColl.</p>
</dd>
</dl>
<dl class="simple" id="index-10">
<dt><cite>Console.read([size]): string</cite></dt><dd><p>Reads at most <cite>size</cite> bytes from the console, and returns the resulting
string.</p>
</dd>
</dl>
<dl class="simple" id="index-11">
<dt><cite>Console.readline([size]): string</cite></dt><dd><p>Reads at most <cite>size</cite> lines from the console, and returns them as a single
string.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="scripts-api">
<span id="id4"></span><h2><span class="section-number">3.2. </span>Scripts API<a class="headerlink" href="#scripts-api" title="Permalink to this headline">¶</a></h2>
<p>This section will give an overview of the API used in the scripts module.
The reference documentation for this API is in the source files themselves. In
particular, each <code class="file docutils literal notranslate"><span class="pre">.ads</span></code> file fully documents all its public API.</p>
<p>As described above, GNATColl contains several levels of API. In
particular, it provides a low-level interface to python, in the packages
<cite>GNATCOLL.Python</cite>. This interface is used by the rest of GNATColl,
but is likely too low-level to really be convenient in your applications,
since you need to take care of memory management and type conversions by
yourself.</p>
<p>Instead, GNATColl provides a language-neutral Ada API. Using this
API, it is transparent for your application whether you are talking to the
Shell, to python, or to another language integrated in GNATColl.
The code remains exactly the same, and new scripting languages can be added
in later releases of GNATColl without requiring a change in your
application. This flexibility is central to the design of GNATColl.</p>
<p>In exchange for that flexibility, however, there are language-specific
features that cannot be performed through the GNATColl API. At
present, this includes for instance exporting functions that return hash
tables. But GNATColl doesn’t try to export the greatest set of
features common to all languages. On the contrary, it tries to fully
support all the languages, and provide reasonable fallback for languages
that do not support that feature. For instance, named parameters (which
are a part of the python language) are fully supported, although the
shell language doesn’t support them. But that’s an implementation detail
transparent to your own application.</p>
<p>Likewise, your application might decide to always load the python
scripting language. If GNATColl wasn’t compiled with python support,
the corresponding Ada function still exists (and thus your code still
compiles), although of course it does nothing. But since the rest of the
code is independent of python, this is totally transparent for your
application.</p>
<p><a class="reference internal" href="_images/tip.png"><img alt="TIP:" src="_images/tip.png" style="width: 15pt;" /></a> GNATColl comes with some examples, which you can use
as a reference when building your own application.
See the <code class="file docutils literal notranslate"><span class="pre">&lt;prefix&gt;/share/examples/gnatcoll</span></code> directory.</p>
<p>Interfacing your application with the scripting module is a multistep
process:</p>
<ul class="simple">
<li><p>You <em>must</em> <strong>initialize</strong> GNATColl and decide which features
to load</p></li>
<li><p>You <em>can</em> create an <strong>interactive console</strong> for the various
languages, so that users can perform experiments interactively. This
is optional, and you could decide to keep the scripting language has a
hidden implementation detail (or just for automatic testing purposes
for instance)</p></li>
<li><p>You <em>can</em> <strong>export</strong> some classes and methods.
This is optional, but it doesn’t really make sense to just embed a
scripting language and export nothing to it. In such a case, you might
as well spawn a separate executable.</p></li>
<li><p>You <em>can</em> load <strong>start up scripts</strong> or plug-ins that users have
written to extend your application.</p></li>
</ul>
<div class="section" id="initializing-the-scripting-module">
<span id="id5"></span><h3><span class="section-number">3.2.1. </span>Initializing the scripting module<a class="headerlink" href="#initializing-the-scripting-module" title="Permalink to this headline">¶</a></h3>
<p>GNATColl must be initialized properly in order to provide added
value to your application. This cannot be done automatically simply by
depending on the library, since this initialization requires multiple-step
that must be done at specific moments in the initialization of your whole
application.</p>
<p>This initialization does not depend on whether you have build support
for python in GNATColl. The same packages and subprograms
are available in all cases, and therefore you do not need conditional
compilation in your application to support the various cases.</p>
<div class="section" id="create-the-scripts-repository">
<span id="id6"></span><h4><span class="section-number">3.2.1.1. </span>Create the scripts repository<a class="headerlink" href="#create-the-scripts-repository" title="Permalink to this headline">¶</a></h4>
<p>The type <cite>GNATCOLL.Scripts.Scripts_Repository</cite> will contain various
variables common to all the scripting languages, as well as a list of the
languages that were activated. This is the starting point for all other
types, since from there you have access to everything. You will have only
one variable of this type in your application, but it should generally be
available from all the code that interfaces with the scripting language.</p>
<p>Like the rest of GNATColl, this is a tagged type, which you can
extend in your own code. For instance, the GPS programming environment is
organized as a kernel and several optional modules. The kernel provides
the core functionality of GPS, and should be available from most functions
that interface with the scripting languages. Since these functions have
very specific profiles, we cannot pass additional arguments to them. One
way to work around this limitation is to store the additional arguments
(in this case a pointer to the kernel) in a class derived from
<cite>Scripts_Repository_Data</cite>.</p>
<p>As a result, the code would look like:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kn">with</span> <span class="nn">GNATCOLL.Scripts</span><span class="p">;</span>
<span class="n">Repo</span> <span class="p">:</span> <span class="n">Scripts_Repository</span> <span class="p">:=</span> <span class="kr">new</span> <span class="n">Scripts_Repository_Record</span><span class="p">;</span>
</pre></div>
</div>
<p>or, in the more complex case of GPS described above:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="kt">Kernel_Scripts_Repository</span> <span class="kr">is</span> <span class="kr">new</span>
   <span class="n">Scripts_Repository_Data</span> <span class="kr">with</span> <span class="kr">record</span>
      <span class="n">Kernel</span> <span class="p">:</span> <span class="p">...;</span>
<span class="kr">end record</span><span class="p">;</span>
<span class="n">Repo</span> <span class="p">:</span> <span class="n">Scripts_Repository</span> <span class="p">:=</span> <span class="kr">new</span> <span class="n">Kernel_Scripts_Repository</span><span class="p">&#39;</span>
   <span class="p">(</span><span class="n">Scripts_Repository_Data</span> <span class="kn">with</span> <span class="nn">Kernel</span> <span class="p">=&gt;</span> <span class="p">...);</span>
</pre></div>
</div>
</div>
<div class="section" id="loading-the-scripting-language">
<span id="id7"></span><h4><span class="section-number">3.2.1.2. </span>Loading the scripting language<a class="headerlink" href="#loading-the-scripting-language" title="Permalink to this headline">¶</a></h4>
<p>The next step is to decide which scripting languages should be made
available to users. This must be done before any function is exported,
since only functions exported after a language has been loaded will be
made available in that language.</p>
<p><a class="reference internal" href="_images/note.png"><img alt="NOTE:" src="_images/note.png" style="width: 15pt;" /></a> If for instance python support was build into GNATColl, and
if you decide not to make it available to users, your application will
still be linked with <code class="file docutils literal notranslate"><span class="pre">libpython</span></code>. It is therefore recommended although
not mandatory to only build those languages that you will use.</p>
<p>This is done through a simple call to one or more subprograms. The following
example registers both the shell and python languages:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kn">with</span> <span class="nn">GNATCOLL.Scripts.Python</span><span class="p">;</span>
<span class="kn">with</span> <span class="nn">GNATCOLL.Scripts.Shell</span><span class="p">;</span>
<span class="n">Register_Shell_Scripting</span> <span class="p">(</span><span class="n">Repo</span><span class="p">);</span>
<span class="n">Register_Python_Scripting</span> <span class="p">(</span><span class="n">Repo</span><span class="p">,</span> <span class="s">&quot;MyModule&quot;</span><span class="p">);</span>
</pre></div>
</div>
<dl class="simple" id="index-12">
<dt><cite>Procedure Register_Shell_Scripting (Repo)</cite></dt><dd><p>This adds support for the shell language. Any class or function that is
now exported through GNATColl will be made available in the shell</p>
</dd>
</dl>
<dl class="simple" id="index-13">
<dt><cite>Procedure Register_Python_Scripting (Repo, Module_Name)</cite></dt><dd><p>This adds support for the python language. Any class or function exported
from now on will be made available in python, in the module specified
by <cite>Module_Name</cite></p>
</dd>
</dl>
</div>
<div class="section" id="exporting-standard-classes">
<span id="id8"></span><h4><span class="section-number">3.2.1.3. </span>Exporting standard classes<a class="headerlink" href="#exporting-standard-classes" title="Permalink to this headline">¶</a></h4>
<p>To be fully functional, GNATColl requires some predefined classes
to be exported to all languages (<a class="reference internal" href="#classes-exported-to-all-languages"><span class="std std-ref">Classes exported to all languages</span></a>).
For instance, the <cite>Console</cite> class is needed for proper interactive with
the consoles associated with each language.</p>
<p>These classes are created with the following code:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">Register_Standard_Classes</span> <span class="p">(</span><span class="n">Repo</span><span class="p">,</span> <span class="s">&quot;Console&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This must be done only after all the scripting languages were loaded in the
previous step, since otherwise the new classes would not be visible in the
other languages.</p>
<dl class="simple" id="index-14">
<dt><cite>Procedure Register_Standard_Classes(Repo,Console_Class)</cite></dt><dd><p>The second parameter <cite>Console_Class</cite> is the name of the class that
is bound to a console, and thus provides input/output support. You can chose
this name so that it matches the classes you intend to export later on from
your application.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="creating-interactive-consoles">
<span id="id9"></span><h3><span class="section-number">3.2.2. </span>Creating interactive consoles<a class="headerlink" href="#creating-interactive-consoles" title="Permalink to this headline">¶</a></h3>
<p>The goal of the scripting module in GNATColl is to work both in
text-only applications and graphical applications.
However, in both cases applications will need a way to capture the output
of scripting languages and display them to the user (at least for errors, to
help debugging scripts), and possibly emulate input when a script is waiting
for such input.</p>
<p>GNATColl solved this problem by using an abstract class
<cite>GNATCOLL.Scripts.Virtual_Console_Record</cite> that defines an API for these
consoles. This API is used throughout <cite>GNATCOLL.Scripts</cite> whenever input or
output has to be performed.</p>
<p><a class="reference internal" href="_images/tip.png"><img alt="TIP:" src="_images/tip.png" style="width: 15pt;" /></a> The <code class="file docutils literal notranslate"><span class="pre">examples/</span></code> directory in the GNATColl package
shows how to implement a console in text mode and in graphical mode.</p>
<p>If you want to provide feedback or interact with users, you will need to
provide an actual implementation for these <cite>Virtual_Console</cite>, specific
to your application. This could be a graphical text window, or based on
<cite>Ada.Text_IO</cite>. The full API is fully documented in
<code class="file docutils literal notranslate"><span class="pre">gnatcoll-scripts.ads</span></code>, but here is a list of the main subprograms that
need to be overriden.</p>
<p id="index-15"><cite>Virtual_Console.Insert_Text (Txt)</cite></p>
<p id="index-16"><cite>Virtual_Console.Insert_Log (Txt)</cite></p>
<dl class="simple" id="index-17">
<dt><cite>Virtual_Console.Insert_Error (Txt)</cite></dt><dd><p>These are the various methods for doing output. Error messages could for
instance be printed in a different color. Log messages should in general
be directed elsewhere, and not be made visible to users unless in special
debugging modes.</p>
</dd>
</dl>
<dl class="simple" id="index-18">
<dt><cite>Virtual_Console.Insert_Prompt (Txt)</cite></dt><dd><p>This method must display a prompt so that the user knows input is expected.
Graphical consoles will in general need to remember where the prompt ended
so that they also know where the user input starts</p>
</dd>
</dl>
<dl class="simple" id="index-19">
<dt><cite>Virtual_Console.Set_As_Default_Console (Script)</cite></dt><dd><p>This method is called when the console becomes the default console for
a scripting language. They should in general keep a pointer on that
language, so that when the user presses <kbd class="kbd docutils literal notranslate">enter</kbd> they know which language
must execute the command</p>
</dd>
</dl>
<dl class="simple" id="index-20">
<dt><cite>Virtual_Console.Read (Size, Whole_Line) : String</cite></dt><dd><p>Read either several characters or whole lines from the console. This is
called when the user scripts read from their stdin.</p>
</dd>
</dl>
<p id="index-21"><cite>Virtual_Console.Set_Data_Primitive (Instance)</cite></p>
<dl id="index-22">
<dt><cite>Virtual_Console.Get_Instance : Console</cite></dt><dd><p>These two methods are responsible for storing an instance of <cite>Console</cite>
into a <cite>GNATCOLL.Scripts.Class_Instance</cite>. Such an instance is
what the user
manipulates from his scripting language. But when he executes a method, the
Ada callback must know how to get the associated <cite>Virtual_Console</cite>
back to perform actual operations on it.</p>
<p>These methods are implemented using one of the <cite>GNATCOLL.Scripts.Set_Data</cite>
and <cite>GNATCOLL.Scripts.Get_Data</cite> operations when in text mode.</p>
</dd>
</dl>
<p>Once you have created one or more of these console, you can set them as
the default console for each of the scripting languages. This way, any
input/output done by scripts in this language will interact with that
console, instead of being discarded. This is done through code similar
to:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">Console</span> <span class="p">:=</span> <span class="n">GtkConsole</span><span class="p">.</span><span class="n">Create</span> <span class="p">(...);</span>
<span class="n">Set_Default_Console</span>
  <span class="p">(</span><span class="n">Lookup_Scripting_Language</span> <span class="p">(</span><span class="n">Repo</span><span class="p">,</span> <span class="s">&quot;python&quot;</span><span class="p">),</span>
   <span class="n">Virtual_Console</span> <span class="p">(</span><span class="n">Console</span><span class="p">));</span>
</pre></div>
</div>
<p>Creating a new instance of <cite>Console</cite>, although allowed, will by
default create an unusable console. Indeed, depending on your application,
you might want to create a new window, reuse an existing one, or do many
other things when the user does:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>
</pre></div>
</div>
<p>As a result, GNATColl does not try to guess the correct behavior,
and thus does not export a constructor for the console. So in the above
python code, the default python constructor is used. But this constructor
does not associate <cite>c</cite> with any actual <cite>Virtual_Console</cite>, and
thus any call to a method of <cite>c</cite> will result in an error.</p>
<p>To make it possible for users to create their own consoles, you need to
export a <cite>Constructor_Method</cite> (see below) for the <cite>Console</cite>
class. In addition to your own processing, this constructor needs also to
call:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">declare</span>
   <span class="no">Inst</span> <span class="p">:</span> <span class="kr">constant</span> <span class="n">Class_Instance</span> <span class="p">:=</span> <span class="n">Nth_Arg</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="kr">begin</span>
   <span class="n">C</span> <span class="p">:=</span> <span class="kr">new</span> <span class="n">My_Console_Record</span><span class="p">;</span>  <span class="c1">--  or your own type</span>
   <span class="n">GNATCOLL</span><span class="p">.</span><span class="n">Scripts</span><span class="p">.</span><span class="n">Set_Data</span> <span class="p">(</span><span class="n">Inst</span><span class="p">,</span> <span class="n">C</span><span class="p">);</span>
<span class="kr">end</span>
</pre></div>
</div>
</div>
<div class="section" id="exporting-classes-and-methods">
<span id="id10"></span><h3><span class="section-number">3.2.3. </span>Exporting classes and methods<a class="headerlink" href="#exporting-classes-and-methods" title="Permalink to this headline">¶</a></h3>
<p>Once all scripting languages have been loaded, you can start exporting
new classes and functions to all the scripting languages. It is important
to realize that through a single Ada call, they are exported to all loaded
scripting languages, without further work required on your part.</p>
<div class="section" id="classes-diagram">
<span id="id11"></span><h4><span class="section-number">3.2.3.1. </span>Classes diagram<a class="headerlink" href="#classes-diagram" title="Permalink to this headline">¶</a></h4>
<p>The following diagram shows the dependencies between the major data types
defined in <code class="file docutils literal notranslate"><span class="pre">GNATCOLL.Scripts</span></code>. Most of these are abstract classes that
are implemented by the various scripting languages. Here is a brief description
of the role of each type:</p>
<img alt="_images/classes.png" id="index-23" src="_images/classes.png" />
<dl class="simple" id="index-24">
<dt><cite>Class Scripts_Repository</cite></dt><dd><p>As we have seen before, this is a type of which there is a single instance
in your whole application, and whose main role is to give access to each
of the scripting languages (<cite>Lookup_Scripting_Language</cite> function), and
to make it possible to register each exported function only once (it then
takes care of exporting it to each scripting language).</p>
</dd>
</dl>
<dl id="index-25">
<dt><cite>Class Scripting_Language</cite></dt><dd><p>Instances of this type represent a specific language. It provides various
operations to export subprograms, execute commands, create the other types
described below,… There should exists a single instance of this class per
supported language.</p>
<p>This class interacts with the script interpreter (for instance python), and
all code executed in python goes through this type, which then executes your
Ada callbacks to perform the actual operation.</p>
<p>It is also associated with a default console, as described above, so that
all input and output of the scripts can be made visible to the user.</p>
</dd>
</dl>
<dl class="simple" id="index-26">
<dt><cite>Class Callback_Data</cite></dt><dd><p>This type is an opaque tagged type that provides a language-independent
interface to the scripting language. It gives for instance access to the
various parameters passed to your subprogram (<cite>Nth_Arg</cite> functions),
allows you to set the return value (<cite>Set_Return_Value</cite> procedure),
or raise exceptions (<cite>Set_Error_Msg</cite> procedure),…</p>
</dd>
</dl>
<dl class="simple" id="index-27">
<dt><cite>Record Class_Type</cite></dt><dd><p>This type is not tagged, and cannot be extended. It basically represents a
class in any of the scripting languages, and is used to create new instances
of that class from Ada.</p>
</dd>
</dl>
<dl id="index-28">
<dt><cite>Class Class_Instance</cite></dt><dd><p>A class instance represents a specific instance of a class. In general,
such an instance is strongly bound to an instance of an Ada type. For
instance, if you have a <cite>Foo</cite> type in your application that you wish
to export, you would create a <cite>Class_Type</cite> called “Foo”, and then the
user can create as many instances as he wants of that class, each of which
is associated with different values of <cite>Foo</cite> in Ada.</p>
<p>Another more specific example is the predefined <cite>Console</cite> class. As
we have seen before, this is a <cite>Virtual_Console</cite> in Ada. You could
for instance have two graphical windows in your application, each of which
is a <cite>Virtual_Console</cite>. In the scripting language, this is exported
as a class named <cite>Console</cite>. The user can create two
instances of those, each of which is associated with one of your graphical
windows. This way, executing <cite>Console.write</cite> on these instances would
print the string on their respective graphical window.</p>
<p>Some scripting languages, in particular python, allow you to store any
data within the class instances. In the example above, the user could for
instance store the time stamp of the last output in each of the instances.
It is therefore important that, as much as possible, you always return the
same <cite>Class_Instance</cite> for a given Ada object. See the following
python example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">myconsole</span> <span class="o">=</span> <span class="n">Console</span> <span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="c1"># Create new console</span>
<span class="n">myconsole</span><span class="o">.</span><span class="n">mydata</span> <span class="o">=</span> <span class="s2">&quot;20060619&quot;</span>  <span class="c1"># Any data, really</span>
<span class="n">myconsole</span> <span class="o">=</span> <span class="n">Console</span> <span class="p">(</span><span class="s2">&quot;title2&quot;</span><span class="p">)</span>  <span class="c1"># Create another window</span>
<span class="n">myconsole</span> <span class="o">=</span> <span class="n">Console</span> <span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="c1"># Must be same as first,</span>
<span class="nb">print</span> <span class="n">myconsole</span><span class="o">.</span><span class="n">mydata</span>  <span class="c1"># so that this prints &quot;20060619&quot;</span>
</pre></div>
</div>
</dd>
</dl>
<dl class="simple" id="index-29">
<dt><cite>Class Instance_Property</cite></dt><dd><p>As we have seen above, a <cite>Class_Instance</cite> is associated in general with
an Ada object. This <cite>Instance_Property</cite> tagged type should be extended
for each Ada type you want to be able to store in a <cite>Class_Instance</cite>.
You can then use the <cite>Set_Data</cite> and <cite>Get_Data</cite> methods of the
<cite>Class_Instance</cite> to get and retrieve that associated Ada object.</p>
</dd>
</dl>
<dl id="index-30">
<dt><cite>Class Subprogram_Record</cite></dt><dd><p>This class represents a callback in the scripting language, that is some
code that can be executed when some conditions are met.</p>
<p>The exact semantic here depends on each of the programming languages. For
instance, if you are programming in python, this is the name of a python
method to execute. If you are programming in shell, this is any shell code.</p>
<p>The idea here is to blend in as smoothly as possible with the usual constructs
of each language. For instance, in python one would prefer to write the
second line rather than the third:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">on_exit</span><span class="p">():</span>
   <span class="k">pass</span>
<span class="n">set_on_exit_callback</span><span class="p">(</span><span class="n">on_exit</span><span class="p">)</span>   <span class="c1"># Yes, python style</span>
<span class="n">set_on_exit_callback</span><span class="p">(</span><span class="s2">&quot;on_exit&quot;</span><span class="p">)</span> <span class="c1"># No</span>
</pre></div>
</div>
<p>The last line (using a string as a parameter) would be extremely unusual
in python, and would for instance force you to qualify the subprogram name
with the name of its namespace (there would be no implicit namespace
resolution).</p>
<p>To support this special type of parameters, the <cite>Subprogram_Record</cite>
type was created in Ada.</p>
</dd>
</dl>
<p>Although the exact way they are all these types are created is largely
irrelevant to your specific application in general, it might be useful for you
to override part of the types to provide more advanced features. For instance,
GPS redefines its own Shell language, that has basically the same behavior as
the Shell language described above but whose <cite>Subprogram_Record</cite> in fact
execute internal GPS actions rather than any shell code.</p>
</div>
<div class="section" id="exporting-functions">
<span id="id12"></span><h4><span class="section-number">3.2.3.2. </span>Exporting functions<a class="headerlink" href="#exporting-functions" title="Permalink to this headline">¶</a></h4>
<p>All functions that you export to the scripting languages will result in a
call to an Ada subprogram from your own application. This subprogram must
have the following profile:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kd">procedure</span> <span class="nf">Handler</span>
   <span class="p">(</span><span class="nv">Data</span>    <span class="p">: </span><span class="nv">in</span> <span class="nv">out</span> <span class="nv">Callback_Data</span><span class="p">&#39;</span><span class="na">Class</span><span class="p">;</span>
    <span class="nv">Command</span> <span class="p">: </span><span class="nv">String</span><span class="p">);</span>
</pre></div>
</div>
<p>The first parameter <cite>Data</cite> gives you access to the parameters of the
subprogram as passed from the scripting language, and the second parameter
<cite>Command</cite> is the name of the command to execute. The idea behind this
second parameter is that a single Ada procedure might handle several
different script function (for instance because they require common actions
to be performed).</p>
<dl class="simple" id="index-31">
<dt><cite>Register_Command (Repo,Command,Min_Args,Max_Args,Handler)</cite></dt><dd><p>Each of the shell functions is then exported through a call to
<cite>Register_Command</cite>. In its simplest form, this procedure takes the
following arguments. <cite>Repo</cite> is the scripts repository, so that the
command is exported to all the scripting languages. <cite>Command</cite> is the
name of the command. <cite>Min_Args</cite> and <cite>Max_Args</cite> are the minimum and
maximum number of arguments. Most language allow option parameters, and
this is how you specify them. <cite>Handler</cite> is the Ada procedure to call
to execute the command.</p>
</dd>
</dl>
<p>Here is a simple example. It implements a function called <cite>Add</cite>, which
takes two integers in parameter, and returns their sum:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">Arg1_C</span> <span class="p">:</span> <span class="kr">aliased</span> <span class="kr">constant</span> <span class="kt">String</span> <span class="p">:=</span> <span class="s">&quot;arg1&quot;</span><span class="p">;</span>
<span class="n">Arg2_C</span> <span class="p">:</span> <span class="kr">aliased</span> <span class="kr">constant</span> <span class="kt">String</span> <span class="p">:=</span> <span class="s">&quot;arg2&quot;</span><span class="p">;</span>

<span class="kd">procedure</span> <span class="nf">Sum</span>
   <span class="p">(</span><span class="nv">Data</span> <span class="p">: </span><span class="nv">in</span> <span class="nv">out</span> <span class="nv">Callback_Data</span><span class="p">&#39;</span><span class="na">Class</span><span class="p">;</span>
    <span class="nv">Command</span> <span class="p">: </span><span class="nv">String</span><span class="p">)</span>
<span class="kr">is</span>
   <span class="n">Arg1</span><span class="p">,</span> <span class="n">Arg2</span> <span class="p">:</span> <span class="kt">Integer</span><span class="p">;</span>
<span class="kr">begin</span>
   <span class="n">Name_Parameters</span> <span class="p">((</span><span class="mi">1</span> <span class="p">=&gt;</span> <span class="n">Arg1_C</span><span class="p">&#39;</span><span class="na">Access</span><span class="p">,</span> <span class="mi">2</span> <span class="p">=&gt;</span> <span class="n">Arg2_C</span><span class="p">&#39;</span><span class="na">Access</span><span class="p">));</span>
   <span class="n">Arg1</span> <span class="p">:=</span> <span class="n">Nth_Arg</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
   <span class="n">Arg2</span> <span class="p">:=</span> <span class="n">Nth_Arg</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
   <span class="n">Set_Return_Value</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">Arg1</span> <span class="o">+</span> <span class="n">Arg2</span><span class="p">);</span>
<span class="kr">end</span> <span class="nf">Sum</span><span class="p">;</span>

<span class="n">Register_Command</span> <span class="p">(</span><span class="n">Repo</span><span class="p">,</span> <span class="s">&quot;sum&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Sum</span><span class="p">&#39;</span><span class="na">Access</span><span class="p">);</span>
</pre></div>
</div>
<p>This is not the most useful function to export! Still, it illustrates a
number of important concepts.</p>
<div class="section" id="automatic-parameters-types">
<h5><span class="section-number">3.2.3.2.1. </span>Automatic parameters types<a class="headerlink" href="#automatic-parameters-types" title="Permalink to this headline">¶</a></h5>
<p>When the command is registered, the number of arguments is specified.
This means that GNATColl will check on its own whether the right
number of arguments is provided. But the type of these arguments is not
specified. Instead, your callback should proceed as if they were correct,
and try to retrieve them through one of the numerous <cite>Nth_Arg</cite>
functions. In the example above, we assume they are integer. But if one of
them was passed as a string, an exception would be raised and sent back to
the scripting language to display a proper error message to the user. You
have nothing special to do here.</p>
</div>
<div class="section" id="support-for-named-parameters">
<h5><span class="section-number">3.2.3.2.2. </span>Support for named parameters<a class="headerlink" href="#support-for-named-parameters" title="Permalink to this headline">¶</a></h5>
<p>Some languages (especially python) support named parameters, ie parameters
can be specified in any order on the command line, as long as they are
properly identified (very similar to Ada’s own capabilities). In the example
above, the call to <cite>Name_Parameters</cite> is really optional, but adds this
support for your own functions as well. You just have to specify the name
of the parameters, and GNATColl will then ensure that when you
call <cite>Nth_Arg</cite> the parameter number 1 is really “arg1”.
For scripting languages that do not support named parameters, this has no
effect.</p>
<p>Your code can then perform as complex a code as needed, and finally
return a value (or not) to the scripting language, through a call to
<cite>Set_Return_Value</cite>.</p>
<p>After the above code has been executed, your users can go to the python
console and type for instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">MyModule</span> <span class="kn">import</span> <span class="o">*</span>    <span class="c1"># MyModule is the name we declared above</span>
<span class="nb">print</span> <span class="nb">sum</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
      <span class="o">=&gt;</span> <span class="mi">3</span>
<span class="nb">print</span> <span class="nb">sum</span> <span class="p">()</span>
      <span class="o">=&gt;</span> <span class="n">Error</span><span class="p">:</span>  <span class="n">Wrong</span> <span class="n">number</span> <span class="n">of</span> <span class="n">parameters</span>
<span class="nb">print</span> <span class="nb">sum</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="o">=&gt;</span> <span class="n">Error</span><span class="p">:</span>  <span class="n">Parameter</span> <span class="mi">1</span> <span class="n">should</span> <span class="n">be</span> <span class="n">an</span> <span class="n">integer</span>
<span class="nb">print</span> <span class="nb">sum</span> <span class="p">(</span><span class="n">arg2</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">arg1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="o">=&gt;</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="exporting-classes">
<span id="id13"></span><h4><span class="section-number">3.2.3.3. </span>Exporting classes<a class="headerlink" href="#exporting-classes" title="Permalink to this headline">¶</a></h4>
<p>Whenever you want to make an Ada type accessible through the scripting
languages, you should export it as a class. For object-oriented languages,
this would map to the appropriate concept. For other languages, this provides
a namespace, so that each method of the class now takes an additional first
parameter which is the instance of the class, and the name of the method is
prefixed by the class name.</p>
<p>Creating a new class is done through a call to <cite>New_Class</cite>, as shown
in the example below:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">MyClass</span> <span class="p">:</span> <span class="n">Class_Type</span><span class="p">;</span>
<span class="n">MyClass</span> <span class="p">:=</span> <span class="n">GNATCOLL</span><span class="p">.</span><span class="n">Scripts</span><span class="p">.</span><span class="n">New_Class</span> <span class="p">(</span><span class="n">Repo</span><span class="p">,</span> <span class="s">&quot;MyClass&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>At this stage, nothing is visible in the scripting language, but all the
required setup has been done internally so that you can now add methods to
this class.</p>
<p>You can then register the class methods in the same way that you registered
functions. An additional parameter <cite>Class</cite> exists for
<cite>Register_Command</cite>. A method is really just a standard function that
has an implicit first parameter which is a <cite>Class_Instance</cite>. This
extra parameter should not be taken into account in <cite>Min_Args</cite> and
<cite>Max_Args</cite>. You can also declare the method as a static method, ie
one that doesn’t take this extra implicit parameter, and basically just
uses the class as a namespace.</p>
<p>Some special method names are available. In particular,
<cite>Constructor_Method</cite> should be used for the constructor of a class.
It is a method that receives, as its first argument, a class instance that
has just been created. It should associate that instance with the Ada
object it represents.</p>
<p>Here is a simple example that exports a class. Each instance of this class
is associated with a string, passed in parameter to the constructor. The
class has a single method <cite>print</cite>, which prints its string parameter
prefixed by the instance’s string. To start with, here is a python example
on what we want to achieve:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c1</span> <span class="o">=</span> <span class="n">MyClass</span> <span class="p">(</span><span class="s2">&quot;prefix1&quot;</span><span class="p">)</span>
<span class="n">c1</span><span class="o">.</span><span class="n">print</span> <span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
      <span class="o">=&gt;</span> <span class="s2">&quot;prefix1 foo&quot;</span>
<span class="n">c2</span> <span class="o">=</span> <span class="n">MyClass</span> <span class="p">()</span>  <span class="c1"># Using a default prefix</span>
<span class="n">c2</span><span class="o">.</span><span class="n">print</span> <span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
      <span class="o">=&gt;</span> <span class="s2">&quot;default foo&quot;</span>
</pre></div>
</div>
<p>Here is the corresponding Ada code:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kn">with</span> <span class="nn">GNATCOLL.Scripts.Impl</span><span class="p">;</span>
<span class="kd">procedure</span> <span class="nf">Handler</span>
   <span class="p">(</span><span class="nv">Data</span> <span class="p">: </span><span class="o">**</span><span class="nv">in</span> <span class="nv">out</span><span class="o">**</span> <span class="nv">Callback_Data</span><span class="p">&#39;</span><span class="na">Class</span><span class="p">;</span> <span class="nv">Command</span> <span class="p">: </span><span class="nv">String</span><span class="p">)</span>
<span class="kr">is</span>
   <span class="n">Inst</span> <span class="p">:</span> <span class="n">Class_Instance</span> <span class="p">:=</span> <span class="n">Nth_Arg</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MyClass</span><span class="p">);</span>
<span class="kr">begin</span>
   <span class="kr">if</span> <span class="n">Command</span> <span class="o">=</span> <span class="n">Constructor_Method</span> <span class="kr">then</span>
     <span class="n">Set_Data</span> <span class="p">(</span><span class="n">Inst</span><span class="p">,</span> <span class="n">MyClass</span><span class="p">,</span> <span class="n">Nth_Arg</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">));</span>
   <span class="kr">elsif</span> <span class="n">Command</span> <span class="o">=</span> <span class="s">&quot;print&quot;</span> <span class="kr">then</span>
     <span class="n">Insert_Text</span>
        <span class="p">(</span><span class="n">Get_Script</span> <span class="p">(</span><span class="n">Data</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span>
         <span class="kt">String</span><span class="p">&#39;(</span><span class="n">Get_Data</span> <span class="p">(</span><span class="n">Inst</span><span class="p">))</span> <span class="o">&amp;</span> <span class="s">&quot; &quot;</span> <span class="o">&amp;</span> <span class="n">Nth_Arg</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
   <span class="kr">end</span> <span class="kr">if</span><span class="p">;</span>
<span class="kr">end</span> <span class="nf">Handler</span><span class="p">;</span>

<span class="n">Register_Command</span>
  <span class="p">(</span><span class="n">Repo</span><span class="p">,</span> <span class="n">Constructor_Method</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Handler</span><span class="p">&#39;</span><span class="na">Access</span><span class="p">,</span> <span class="n">MyClass</span><span class="p">);</span>
<span class="n">Register_Command</span>
  <span class="p">(</span><span class="n">Repo</span><span class="p">,</span> <span class="s">&quot;print&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Handler</span><span class="p">&#39;</span><span class="na">Access</span><span class="p">,</span> <span class="n">MyClass</span><span class="p">);</span>
</pre></div>
</div>
<p>This example also demonstrates a few concepts: the constructor is declared
as a method that takes one optional argument. The default value is in
fact passed in the call to <cite>Nth_Arg</cite> and is set to “default”.
In the handler, we know there is always a first argument which is the
instance on which the method applies. The implementation for the
constructor stores the prefix in the instance itself, so that several
instances can have different prefixes (we can’t use global variables,
of course, since we don’t know in advance how many instances will exist).
The implementation for <cite>print</cite> inserts code in the default console
for the script (we could of course use <cite>Put_Line</cite> or any other way
to output data), and computes the string to output by concatenating the
instance’s prefix and the parameter to <cite>print</cite>.</p>
<p>Note that <cite>Set_Data</cite> and <cite>Get_Data</cite> take the class in parameter,
in addition to the class instance. This is needed for proper handling of
multiple inheritance: say we have a class <cite>C</cite> that extends two classes
<cite>A</cite> and <cite>B</cite>. The Ada code that deals with <cite>A</cite> associates an
integer with the class instance, whereas the code that deals with <cite>B</cite>
associates a string. Now, if you have an instance of <cite>C</cite> but call a
method inherited from <cite>A</cite>, and if <cite>Get_Data</cite> didn’t specify the
class, there would be a risk that a string would be returned instead of the
expected integer. In fact, the proper solution here is that both <cite>A</cite>
and <cite>B</cite> store their preferred data at the same time in the instances,
but only fetch the one they actually need. Therefore instances of <cite>C</cite>
are associated with two datas.</p>
<p>Here is a more advanced example that shows how to export an Ada object. Let’s
assume we have the following Ada type that we want to make available to
scripts:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="kt">MyType</span> <span class="kr">is</span> <span class="kr">record</span>
   <span class="n">Field</span> <span class="p">:</span> <span class="kt">Integer</span><span class="p">;</span>
<span class="kr">end record</span><span class="p">;</span>
</pre></div>
</div>
<p>As you can see, this is not a tagged type, but could certainly be. There is
of course no procedure <cite>Set_Data</cite> in <code class="file docutils literal notranslate"><span class="pre">GNATCOLL.Scripts</span></code> that enables
us to store <cite>MyType</cite> in a <cite>Class_Instance</cite>. This example shows how
to write such a procedure. The rest of the code would be similar to the
first example, with a constructor that calls <cite>Set_Data</cite>, and methods
that call <cite>Get_Data</cite>:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="kt">MyPropsR</span> <span class="kr">is</span> <span class="kr">new</span> <span class="n">Instance_Property_Record</span> <span class="kr">with</span> <span class="kr">record</span>
   <span class="n">Val</span> <span class="p">:</span> <span class="n">MyType</span><span class="p">;</span>
<span class="kr">end record</span><span class="p">;</span>
<span class="kd">type</span> <span class="kt">MyProps</span> <span class="kr">is</span> <span class="kr">access</span> <span class="kr">all</span> <span class="n">MyPropsR</span><span class="p">&#39;</span><span class="na">Class</span><span class="p">;</span>

<span class="kd">procedure</span> <span class="nf">Set_Data</span>
  <span class="p">(</span><span class="nv">Inst</span> <span class="p">: </span><span class="nv">Class_Instance</span><span class="p">;</span> <span class="nv">Val</span> <span class="p">: </span><span class="nv">MyType</span><span class="p">)</span>
<span class="kr">is</span>
<span class="kr">begin</span>
  <span class="n">Set_Data</span> <span class="p">(</span><span class="n">Inst</span><span class="p">,</span> <span class="n">Get_Name</span> <span class="p">(</span><span class="n">MyClass</span><span class="p">),</span> <span class="n">MyPropsR</span><span class="p">&#39;(</span><span class="n">Val</span> <span class="p">=&gt;</span> <span class="n">Val</span><span class="p">));</span>
<span class="kr">end</span> <span class="nf">Set_Data</span><span class="p">;</span>

<span class="kd">function</span> <span class="nf">Get_Data</span> <span class="p">(</span><span class="nv">Inst</span> <span class="p">: </span><span class="nv">Class_Instance</span><span class="p">)</span> <span class="kr">return</span> <span class="n">MyType</span> <span class="kr">is</span>
   <span class="n">Data</span> <span class="p">:</span> <span class="n">MyProps</span> <span class="p">:=</span> <span class="n">MyProps</span> <span class="p">(</span><span class="n">Instance_Property</span><span class="p">&#39;</span>
      <span class="p">(</span><span class="n">Get_Data</span> <span class="p">(</span><span class="n">Inst</span><span class="p">,</span> <span class="n">Get_Name</span> <span class="p">(</span><span class="n">MyClass</span><span class="p">))));</span>
<span class="kr">begin</span>
   <span class="kr">return</span> <span class="n">Data</span><span class="p">.</span><span class="n">Val</span><span class="p">;</span>
<span class="kr">end</span> <span class="nf">Get_Data</span><span class="p">;</span>
</pre></div>
</div>
<p>Several aspects worth noting in this example. Each data is associated with
a name, not a class as in the previous example. That’s in fact the same
thing, and mostly for historical reasons. We have to create our own
instance of <cite>Instance_Property_Record</cite> to store the data, but the
implementation presents no special difficulty. In fact, we don’t absolutely
need to create <cite>Set_Data</cite> and <cite>Get_Data</cite> and could do everything
inline in the method implementation, but it is cleaner this way and easier
to reuse.</p>
<p>GNATColl is fully responsible for managing the lifetime of the
data associated with the class instances and you can override the procedure
<cite>Destroy</cite> if you need special memory management.</p>
</div>
<div class="section" id="reusing-class-instances">
<span id="id14"></span><h4><span class="section-number">3.2.3.4. </span>Reusing class instances<a class="headerlink" href="#reusing-class-instances" title="Permalink to this headline">¶</a></h4>
<p>We mentioned above that it is more convenient for users of your exported
classes if you always return the same class instance for the same Ada
object (for instance a graphical window should always be associated with
the same class instance), so that users can associate their own internal
data with them.</p>
<p>GNATColl provides a few types to facilitate this. In passing, it
is worth noting that in fact the Ada objects will be associated with a
single instance <em>per scripting language</em>, but each language has its
own instance. Data is not magically transferred from python to shell!</p>
<p>You should store the list of associated instances with
your object. The type <cite>GNATCOLL.Scripts.Instance_List_Access</cite> is meant for
that purpose, and provides two <cite>Set</cite> and <cite>Get</cite> primitives
to retrieve existing instances.</p>
<p>The final aspect to consider here is how to return existing instances.
This cannot be done from the constructor method, since when it is called
it has already received the created instance (this is forced by python, and
was done the same for other languages for compatibility reasons).
There are two ways to work around that limitation:</p>
<ul>
<li><p>Static <cite>get</cite> methods</p>
<p>With each of your classes, you can export a static method generally called
<cite>get</cite> that takes in parameter a way to identify an existing instance,
and either return it or create a new one. It is also recommended to disable
the constructor, ie force it to raise an error. Let’s examine the python
code as it would be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ed</span> <span class="o">=</span> <span class="n">Editor</span> <span class="p">(</span><span class="s2">&quot;file.adb&quot;</span><span class="p">)</span>  <span class="c1"># constructor</span>
    <span class="o">=&gt;</span> <span class="n">Error</span><span class="p">,</span> <span class="n">cannot</span> <span class="n">construct</span> <span class="n">instances</span>
<span class="n">ed</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;file.adb&quot;</span><span class="p">)</span>
    <span class="o">=&gt;</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">new</span> <span class="n">instance</span>
<span class="n">ed2</span> <span class="o">=</span> <span class="n">Editor</span><span class="o">.</span><span class="n">get</span> <span class="p">(</span><span class="s2">&quot;file.adb&quot;</span><span class="p">)</span>
    <span class="o">=&gt;</span> <span class="n">Return</span> <span class="n">existing</span> <span class="n">instance</span>
<span class="n">ed</span> <span class="o">==</span> <span class="n">ed2</span>
    <span class="o">=&gt;</span> <span class="kc">True</span>
</pre></div>
</div>
<p>The corresponding Ada code would be something like:</p>
<div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="kt">MyType</span> <span class="kr">is</span> <span class="kr">record</span>
   <span class="n">Val</span> <span class="p">:</span> <span class="kt">Integer</span><span class="p">;</span>
   <span class="n">Inst</span> <span class="p">:</span> <span class="n">Instance_List_Access</span><span class="p">;</span>
<span class="kr">end record</span><span class="p">;</span>
<span class="kd">type</span> <span class="kt">MyTypeAccess</span> <span class="kr">is</span> <span class="kr">access</span> <span class="kr">all</span> <span class="n">MyType</span><span class="p">;</span>
<span class="kd">procedure</span> <span class="nf">Handler</span>
  <span class="p">(</span><span class="nv">Data</span> <span class="p">: </span><span class="nv">in</span> <span class="nv">out</span> <span class="nv">Callback_Data</span><span class="p">&#39;</span><span class="na">Class</span><span class="p">;</span> <span class="nv">Cmd</span> <span class="p">: </span><span class="nv">String</span><span class="p">)</span>
<span class="kr">is</span>
   <span class="n">Inst</span> <span class="p">:</span> <span class="n">Class_Instance</span><span class="p">;</span>
   <span class="n">Tmp</span>  <span class="p">:</span> <span class="n">MyTypeAccess</span><span class="p">;</span>
<span class="kr">begin</span>
   <span class="kr">if</span> <span class="n">Cmd</span> <span class="o">=</span> <span class="n">Constructor_Method</span> <span class="kr">then</span>
     <span class="n">Set_Error_Msg</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="s">&quot;cannot construct instances&quot;</span><span class="p">);</span>
   <span class="kr">elsif</span> <span class="n">Cmd</span> <span class="o">=</span> <span class="s">&quot;get&quot;</span> <span class="kr">then</span>
     <span class="n">Tmp</span> <span class="p">:=</span> <span class="n">check_if_exists</span> <span class="p">(</span><span class="n">Nth_Arg</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
     <span class="kr">if</span> <span class="n">Tmp</span> <span class="o">=</span> <span class="kc">null</span> <span class="kr">then</span>
        <span class="n">Tmp</span> <span class="p">:=</span> <span class="n">create_new_mytype</span> <span class="p">(</span><span class="n">Nth_Arg</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
        <span class="n">Tmp</span><span class="p">.</span><span class="n">Inst</span> <span class="p">:=</span> <span class="kr">new</span> <span class="n">Instance_List</span><span class="p">;</span>
     <span class="kr">end</span> <span class="kr">if</span><span class="p">;</span>
     <span class="n">Inst</span> <span class="p">:=</span> <span class="n">Get</span> <span class="p">(</span><span class="n">Tmp</span><span class="p">.</span><span class="n">Inst</span><span class="p">.</span><span class="kr">all</span><span class="p">,</span> <span class="n">Get_Script</span> <span class="p">(</span><span class="n">Data</span><span class="p">));</span>
     <span class="kr">if</span> <span class="n">Inst</span> <span class="o">=</span> <span class="n">No_Class_Instance</span> <span class="kr">then</span>
        <span class="n">Inst</span> <span class="p">:=</span> <span class="n">New_Instance</span> <span class="p">(</span><span class="n">Get_Script</span> <span class="p">(</span><span class="n">Data</span><span class="p">),</span> <span class="n">MyClass</span><span class="p">);</span>
        <span class="n">Set</span> <span class="p">(</span><span class="n">Tmp</span><span class="p">.</span><span class="n">Inst</span><span class="p">.</span><span class="kr">all</span><span class="p">,</span> <span class="n">Get_Script</span> <span class="p">(</span><span class="n">Data</span><span class="p">),</span> <span class="n">Inst</span><span class="p">);</span>
        <span class="n">Set_Data</span> <span class="p">(</span><span class="n">Inst</span><span class="p">,</span> <span class="n">Tmp</span><span class="p">);</span>
     <span class="kr">end</span> <span class="kr">if</span><span class="p">;</span>
     <span class="n">Set_Return_Value</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="n">Inst</span><span class="p">);</span>
   <span class="kr">end</span> <span class="kr">if</span><span class="p">;</span>
<span class="kr">end</span> <span class="nf">Handler</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Factory classes</p>
<p>The standard way to do this in python, which applies to other languages
as well, is to use the Factory design pattern. For this, we need to
create one class (<cite>MyClassImpl</cite>) and one factory
function (<cite>MyClass</cite>).</p>
<p>The python code now looks like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ed</span> <span class="o">=</span> <span class="n">MyClass</span> <span class="p">(</span><span class="s2">&quot;file.adb&quot;</span><span class="p">)</span>  <span class="c1"># Create new instance</span>
    <span class="o">=&gt;</span> <span class="n">ed</span> <span class="ow">is</span> <span class="n">of</span> <span class="nb">type</span> <span class="n">MyClassImpl</span>
<span class="n">ed</span> <span class="o">=</span> <span class="n">MyClass</span> <span class="p">(</span><span class="s2">&quot;file.adb&quot;</span><span class="p">)</span>  <span class="c1"># return same instance</span>
<span class="n">ed</span><span class="o">.</span><span class="n">do_something</span><span class="p">()</span>
</pre></div>
</div>
<p>It is important to realize that in the call above, we are not calling
the constructor of a class, but a function. At the Ada level, the function
has basically the same implementation as the one we gave for <cite>get</cite>
above. But the python code looks nicer because we do not have these
additional <cite>.get()</cite> calls. The name of the class <cite>MyClassImpl</cite>
doesn’t appear anywhere in the python code, so this is mostly transparent.</p>
<p>However, if you have more than one scripting language, in particular for
the shell, the code looks less nice in this case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MyClass</span> <span class="s2">&quot;file.adb&quot;</span>
    <span class="o">=&gt;</span>  <span class="o">&lt;</span><span class="n">MyClassImpl_Instance_0x12345</span><span class="o">&gt;</span>
<span class="n">MyClassImpl</span><span class="o">.</span><span class="n">do_something</span> <span class="o">%</span><span class="mi">1</span>
</pre></div>
</div>
<p>and the new name of the class is visible in the method call.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="executing-startup-scripts">
<span id="id15"></span><h3><span class="section-number">3.2.4. </span>Executing startup scripts<a class="headerlink" href="#executing-startup-scripts" title="Permalink to this headline">¶</a></h3>
<p>The final step in starting up your application is to load extensions or
plug-ins written in one of the scripting languages.</p>
<p>There is not much to be said here, except that you should use the
<cite>GNATCOLL.Scripts.Execute_File</cite> procedure to do so.</p>
</div>
<div class="section" id="multithreading-applications-and-scripts">
<span id="debugging-scripts"></span><h3><span class="section-number">3.2.5. </span>Multithreading applications and scripts<a class="headerlink" href="#multithreading-applications-and-scripts" title="Permalink to this headline">¶</a></h3>
<p>Python itself is not thread-safe. So a single thread can call the python C API
at a time. To enforce this, the python interpreter provides a global
interpreter lock, which you must acquire before calling the C API, and release
when you are done. To simulate multitasking, the python interpreter will in
fact release and reacquire the lock every 100 micro-instructions (opcodes in
the python virtual machine), to give a chance to run to other tasks. So this is
preemptive multitasking.</p>
<p>The threads that are created in Ada that do not need access to python do not
need any special handling. However, those that need access to python must make
a special function call before they first call the python C API, so that python
can create a thread-specific data for them.</p>
<p><cite>GNATCOLL.Scripts.Python</cite> contains a number of subprograms to interact with the
global interpreter lock of the python engine. The initialization of your
application needs to do two extra calls:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Register_Python_Scripting</span> <span class="p">(</span><span class="o">...</span><span class="p">);</span>
<span class="n">Initialize_Threads_Support</span><span class="p">;</span>   <span class="o">--</span>  <span class="n">Also</span> <span class="n">acquires</span> <span class="n">the</span> <span class="n">lock</span>
<span class="n">Begin_Allow_Threads</span><span class="p">;</span>          <span class="o">--</span>  <span class="n">Releases</span> <span class="n">the</span> <span class="n">lock</span>
</pre></div>
</div>
<p>Whenever a task needs to execute python commands (or basically use any
subprogram from <cite>GNATCOLL.Scripts</cite>, it needs to do the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Ensure_Thread_State</span><span class="p">;</span>   <span class="o">--</span>  <span class="n">Block</span> <span class="nb">all</span> <span class="n">python</span> <span class="n">threads</span>
<span class="o">...</span>  <span class="n">access</span> <span class="n">to</span> <span class="n">python</span> <span class="n">C</span> <span class="n">API</span> <span class="k">as</span> <span class="n">usual</span>
<span class="n">Begin_Allow_Threads</span><span class="p">;</span>   <span class="o">--</span>  <span class="n">Let</span> <span class="n">other</span> <span class="n">python</span> <span class="n">threads</span> <span class="n">run</span>
</pre></div>
</div>
<p>In some cases, the simplest is to get the lock at the beginning of the task,
and release it when done. This assumes the task executes fast enough. In other
cases, you will need finer grain control over the lock.</p>
</div>
<div class="section" id="id16">
<h3><span class="section-number">3.2.6. </span>Debugging scripts<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<p>GNATColl provides a convenient hook to debug your script. By default,
a script (python for instance) will call your Ada callback, which might
raise errors. Most of the time, the error should indeed be reported to the
user, and you can thus raise a standard exception, or call
<cite>Set_Error_Msg</cite>.</p>
<p>But if you wish to know which script was executing the command, it is
generally not doable. You can however activate a trace
(<a class="reference internal" href="traces.html#logging-information"><span class="std std-ref">Traces: Logging information</span></a>) called <cite>“PYTHON.TB”</cite> (for “traceback”), which will
output the name of the command that is being executed, as well as the
full traceback within the python scripts. This will help you locate which
script is raising an exception.</p>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/adacore_transparent.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3. <strong>Scripts</strong>: Embedding script languages</a><ul>
<li><a class="reference internal" href="#supported-languages">3.1. Supported languages</a><ul>
<li><a class="reference internal" href="#the-shell-language">3.1.1. The Shell language</a></li>
<li><a class="reference internal" href="#classes-exported-to-all-languages">3.1.2. Classes exported to all languages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#scripts-api">3.2. Scripts API</a><ul>
<li><a class="reference internal" href="#initializing-the-scripting-module">3.2.1. Initializing the scripting module</a><ul>
<li><a class="reference internal" href="#create-the-scripts-repository">3.2.1.1. Create the scripts repository</a></li>
<li><a class="reference internal" href="#loading-the-scripting-language">3.2.1.2. Loading the scripting language</a></li>
<li><a class="reference internal" href="#exporting-standard-classes">3.2.1.3. Exporting standard classes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-interactive-consoles">3.2.2. Creating interactive consoles</a></li>
<li><a class="reference internal" href="#exporting-classes-and-methods">3.2.3. Exporting classes and methods</a><ul>
<li><a class="reference internal" href="#classes-diagram">3.2.3.1. Classes diagram</a></li>
<li><a class="reference internal" href="#exporting-functions">3.2.3.2. Exporting functions</a><ul>
<li><a class="reference internal" href="#automatic-parameters-types">3.2.3.2.1. Automatic parameters types</a></li>
<li><a class="reference internal" href="#support-for-named-parameters">3.2.3.2.2. Support for named parameters</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exporting-classes">3.2.3.3. Exporting classes</a></li>
<li><a class="reference internal" href="#reusing-class-instances">3.2.3.4. Reusing class instances</a></li>
</ul>
</li>
<li><a class="reference internal" href="#executing-startup-scripts">3.2.4. Executing startup scripts</a></li>
<li><a class="reference internal" href="#multithreading-applications-and-scripts">3.2.5. Multithreading applications and scripts</a></li>
<li><a class="reference internal" href="#id16">3.2.6. Debugging scripts</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="building.html"
                        title="previous chapter"><span class="section-number">2. </span>Building GNATColl</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="traces.html"
                        title="next chapter"><span class="section-number">4. </span><strong>Traces</strong>: Logging information</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="traces.html" title="4. Traces: Logging information"
             >next</a> |</li>
        <li class="right" >
          <a href="building.html" title="2. Building GNATColl"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">GNATColl 2021 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">3. </span><strong>Scripts</strong>: Embedding script languages</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2007-2021, AdaCore.
    </div>
  </body>
</html>