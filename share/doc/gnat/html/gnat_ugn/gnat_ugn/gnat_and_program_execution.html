
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6. GNAT and Program Execution &#8212; GNAT User&#39;s Guide for Native Platforms 2021 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Platform-Specific Information" href="platform_specific_information.html" />
    <link rel="prev" title="5. GNAT Utility Programs" href="gnat_utility_programs.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="platform_specific_information.html" title="Platform-Specific Information"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="gnat_utility_programs.html" title="5. GNAT Utility Programs"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../gnat_ugn.html">GNAT User&#39;s Guide for Native Platforms 2021 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6. </span>GNAT and Program Execution</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="gnat-and-program-execution">
<span id="id1"></span><h1><span class="section-number">6. </span>GNAT and Program Execution<a class="headerlink" href="#gnat-and-program-execution" title="Permalink to this headline">¶</a></h1>
<p>This chapter covers several topics:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id2">Running and Debugging Ada Programs</a></p></li>
<li><p><a class="reference internal" href="#profiling">Profiling</a></p></li>
<li><p><a class="reference internal" href="#id26">Improving Performance</a></p></li>
<li><p><a class="reference internal" href="#id45">Overflow Check Handling in GNAT</a></p></li>
<li><p><a class="reference internal" href="#id51">Performing Dimensionality Analysis in GNAT</a></p></li>
<li><p><a class="reference internal" href="#id52">Stack Related Facilities</a></p></li>
<li><p><a class="reference internal" href="#id56">Memory Management Issues</a></p></li>
</ul>
<div class="section" id="running-and-debugging-ada-programs">
<span id="id2"></span><h2><span class="section-number">6.1. </span>Running and Debugging Ada Programs<a class="headerlink" href="#running-and-debugging-ada-programs" title="Permalink to this headline">¶</a></h2>
<p id="index-0">This section discusses how to debug Ada programs.</p>
<p>An incorrect Ada program may be handled in three ways by the GNAT compiler:</p>
<ul class="simple">
<li><p>The illegality may be a violation of the static semantics of Ada. In
that case GNAT diagnoses the constructs in the program that are illegal.
It is then a straightforward matter for the user to modify those parts of
the program.</p></li>
<li><p>The illegality may be a violation of the dynamic semantics of Ada. In
that case the program compiles and executes, but may generate incorrect
results, or may terminate abnormally with some exception.</p></li>
<li><p>When presented with a program that contains convoluted errors, GNAT
itself may terminate abnormally without providing full diagnostics on
the incorrect user program.</p></li>
</ul>
<span class="target" id="index-1"></span><div class="section" id="the-gnat-debugger-gdb">
<span id="index-2"></span><span id="id3"></span><h3><span class="section-number">6.1.1. </span>The GNAT Debugger GDB<a class="headerlink" href="#the-gnat-debugger-gdb" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">GDB</span></code> is a general purpose, platform-independent debugger that
can be used to debug mixed-language programs compiled with <code class="docutils literal notranslate"><span class="pre">gcc</span></code>,
and in particular is capable of debugging Ada programs compiled with
GNAT. The latest versions of <code class="docutils literal notranslate"><span class="pre">GDB</span></code> are Ada-aware and can handle
complex Ada data structures.</p>
<p>See <cite>Debugging with GDB</cite>,
for full details on the usage of <code class="docutils literal notranslate"><span class="pre">GDB</span></code>, including a section on
its usage on programs. This manual should be consulted for full
details. The section that follows is a brief introduction to the
philosophy and use of <code class="docutils literal notranslate"><span class="pre">GDB</span></code>.</p>
<p>When GNAT programs are compiled, the compiler optionally writes debugging
information into the generated object file, including information on
line numbers, and on declared types and variables. This information is
separate from the generated code. It makes the object files considerably
larger, but it does not add to the size of the actual executable that
will be loaded into memory, and has no impact on run-time performance. The
generation of debug information is triggered by the use of the
<code class="switch docutils literal notranslate"><span class="pre">-g</span></code> switch in the <code class="docutils literal notranslate"><span class="pre">gcc</span></code> or <code class="docutils literal notranslate"><span class="pre">gnatmake</span></code> command
used to carry out the compilations. It is important to emphasize that
the use of these options does not change the generated code.</p>
<p>The debugging information is written in standard system formats that
are used by many tools, including debuggers and profilers. The format
of the information is typically designed to describe C types and
semantics, but GNAT implements a translation scheme which allows full
details about Ada types and variables to be encoded into these
standard C formats. Details of this encoding scheme may be found in
the file exp_dbug.ads in the GNAT source distribution. However, the
details of this encoding are, in general, of no interest to a user,
since <code class="docutils literal notranslate"><span class="pre">GDB</span></code> automatically performs the necessary decoding.</p>
<p>When a program is bound and linked, the debugging information is
collected from the object files, and stored in the executable image of
the program. Again, this process significantly increases the size of
the generated executable file, but it does not increase the size of
the executable program itself. Furthermore, if this program is run in
the normal manner, it runs exactly as if the debug information were
not present, and takes no more actual memory.</p>
<p>However, if the program is run under control of <code class="docutils literal notranslate"><span class="pre">GDB</span></code>, the
debugger is activated.  The image of the program is loaded, at which
point it is ready to run.  If a run command is given, then the program
will run exactly as it would have if <code class="docutils literal notranslate"><span class="pre">GDB</span></code> were not present. This
is a crucial part of the <code class="docutils literal notranslate"><span class="pre">GDB</span></code> design philosophy.  <code class="docutils literal notranslate"><span class="pre">GDB</span></code> is
entirely non-intrusive until a breakpoint is encountered.  If no
breakpoint is ever hit, the program will run exactly as it would if no
debugger were present. When a breakpoint is hit, <code class="docutils literal notranslate"><span class="pre">GDB</span></code> accesses
the debugging information and can respond to user commands to inspect
variables, and more generally to report on the state of execution.</p>
</div>
<div class="section" id="running-gdb">
<span id="id4"></span><h3><span class="section-number">6.1.2. </span>Running GDB<a class="headerlink" href="#running-gdb" title="Permalink to this headline">¶</a></h3>
<p>This section describes how to initiate the debugger.</p>
<p>The debugger can be launched from a <code class="docutils literal notranslate"><span class="pre">GNAT</span> <span class="pre">Studio</span></code> menu or
directly from the command line. The description below covers the latter use.
All the commands shown can be used in the <code class="docutils literal notranslate"><span class="pre">GNAT</span> <span class="pre">Studio</span></code> debug console window,
but there are usually more GUI-based ways to achieve the same effect.</p>
<p>The command to run <code class="docutils literal notranslate"><span class="pre">GDB</span></code> is</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gdb program
</pre></div>
</div>
</div></blockquote>
<p>where <code class="docutils literal notranslate"><span class="pre">program</span></code> is the name of the executable file. This
activates the debugger and results in a prompt for debugger commands.
The simplest command is simply <code class="docutils literal notranslate"><span class="pre">run</span></code>, which causes the program to run
exactly as if the debugger were not present. The following section
describes some of the additional commands that can be given to <code class="docutils literal notranslate"><span class="pre">GDB</span></code>.</p>
</div>
<div class="section" id="introduction-to-gdb-commands">
<span id="id5"></span><h3><span class="section-number">6.1.3. </span>Introduction to GDB Commands<a class="headerlink" href="#introduction-to-gdb-commands" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">GDB</span></code> contains a large repertoire of commands.
See <cite>Debugging with GDB</cite> for extensive documentation on the use
of these commands, together with examples of their use. Furthermore,
the command <em>help</em> invoked from within GDB activates a simple help
facility which summarizes the available commands and their options.
In this section we summarize a few of the most commonly
used commands to give an idea of what <code class="docutils literal notranslate"><span class="pre">GDB</span></code> is about. You should create
a simple program with debugging information and experiment with the use of
these <code class="docutils literal notranslate"><span class="pre">GDB</span></code> commands on the program as you read through the
following section.</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">set</span> <span class="pre">args</span> <em><span class="pre">arguments</span></em></code></dt><dd><p>The <em>arguments</em> list above is a list of arguments to be passed to
the program on a subsequent run command, just as though the arguments
had been entered on a normal invocation of the program. The <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">args</span></code>
command is not needed if the program does not require arguments.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">run</span></code></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> command causes execution of the program to start from
the beginning. If the program is already running, that is to say if
you are currently positioned at a breakpoint, then a prompt will ask
for confirmation that you want to abandon the current execution and
restart.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">breakpoint</span> <em><span class="pre">location</span></em></code></dt><dd><p>The breakpoint command sets a breakpoint, that is to say a point at which
execution will halt and <code class="docutils literal notranslate"><span class="pre">GDB</span></code> will await further
commands. <em>location</em> is
either a line number within a file, given in the format <code class="docutils literal notranslate"><span class="pre">file:linenumber</span></code>,
or it is the name of a subprogram. If you request that a breakpoint be set on
a subprogram that is overloaded, a prompt will ask you to specify on which of
those subprograms you want to breakpoint. You can also
specify that all of them should be breakpointed. If the program is run
and execution encounters the breakpoint, then the program
stops and <code class="docutils literal notranslate"><span class="pre">GDB</span></code> signals that the breakpoint was encountered by
printing the line of code before which the program is halted.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">catch</span> <span class="pre">exception</span> <em><span class="pre">name</span></em></code></dt><dd><p>This command causes the program execution to stop whenever exception
<code class="docutils literal notranslate"><span class="pre">name</span></code> is raised.  If <code class="docutils literal notranslate"><span class="pre">name</span></code> is omitted, then the execution is
suspended when any exception is raised.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">print</span> <em><span class="pre">expression</span></em></code></dt><dd><p>This will print the value of the given expression. Most simple
Ada expression formats are properly handled by <code class="docutils literal notranslate"><span class="pre">GDB</span></code>, so the expression
can contain function calls, variables, operators, and attribute references.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">continue</span></code></dt><dd><p>Continues execution following a breakpoint, until the next breakpoint or the
termination of the program.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">step</span></code></dt><dd><p>Executes a single line after a breakpoint. If the next statement
is a subprogram call, execution continues into (the first statement of)
the called subprogram.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">next</span></code></dt><dd><p>Executes a single line. If this line is a subprogram call, executes and
returns from the call.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">list</span></code></dt><dd><p>Lists a few lines around the current source location. In practice, it
is usually more convenient to have a separate edit window open with the
relevant source file displayed. Successive applications of this command
print subsequent lines. The command can be given an argument which is a
line number, in which case it displays a few lines around the specified one.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">backtrace</span></code></dt><dd><p>Displays a backtrace of the call chain. This command is typically
used after a breakpoint has occurred, to examine the sequence of calls that
leads to the current breakpoint. The display includes one line for each
activation record (frame) corresponding to an active subprogram.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">up</span></code></dt><dd><p>At a breakpoint, <code class="docutils literal notranslate"><span class="pre">GDB</span></code> can display the values of variables local
to the current frame. The command <code class="docutils literal notranslate"><span class="pre">up</span></code> can be used to
examine the contents of other active frames, by moving the focus up
the stack, that is to say from callee to caller, one frame at a time.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">down</span></code></dt><dd><p>Moves the focus of <code class="docutils literal notranslate"><span class="pre">GDB</span></code> down from the frame currently being
examined to the frame of its callee (the reverse of the previous command),</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">frame</span> <em><span class="pre">n</span></em></code></dt><dd><p>Inspect the frame with the given number. The value 0 denotes the frame
of the current breakpoint, that is to say the top of the call stack.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">kill</span></code></dt><dd><p>Kills the child process in which the program is running under GDB.
This may be useful for several purposes:</p>
<ul>
<li><p>It allows you to recompile and relink your program, since on many systems
you cannot regenerate an executable file while it is running in a process.</p></li>
<li><p>You can run your program outside the debugger, on systems that do not
permit executing a program outside GDB while breakpoints are set
within GDB.</p></li>
<li><p>It allows you to debug a core dump rather than a running process.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>The above list is a very short introduction to the commands that
<code class="docutils literal notranslate"><span class="pre">GDB</span></code> provides. Important additional capabilities, including conditional
breakpoints, the ability to execute command sequences on a breakpoint,
the ability to debug at the machine instruction level and many other
features are described in detail in <cite>Debugging with GDB</cite>.
Note that most commands can be abbreviated
(for example, c for continue, bt for backtrace).</p>
</div>
<div class="section" id="using-ada-expressions">
<span id="id6"></span><h3><span class="section-number">6.1.4. </span>Using Ada Expressions<a class="headerlink" href="#using-ada-expressions" title="Permalink to this headline">¶</a></h3>
<p id="index-3"><code class="docutils literal notranslate"><span class="pre">GDB</span></code> supports a fairly large subset of Ada expression syntax, with some
extensions. The philosophy behind the design of this subset is</p>
<blockquote>
<div><ul class="simple">
<li><p>That <code class="docutils literal notranslate"><span class="pre">GDB</span></code> should provide basic literals and access to operations for
arithmetic, dereferencing, field selection, indexing, and subprogram calls,
leaving more sophisticated computations to subprograms written into the
program (which therefore may be called from <code class="docutils literal notranslate"><span class="pre">GDB</span></code>).</p></li>
<li><p>That type safety and strict adherence to Ada language restrictions
are not particularly relevant in a debugging context.</p></li>
<li><p>That brevity is important to the <code class="docutils literal notranslate"><span class="pre">GDB</span></code> user.</p></li>
</ul>
</div></blockquote>
<p>Thus, for brevity, the debugger acts as if there were
implicit <code class="docutils literal notranslate"><span class="pre">with</span></code> and <code class="docutils literal notranslate"><span class="pre">use</span></code> clauses in effect for all user-written
packages, thus making it unnecessary to fully qualify most names with
their packages, regardless of context. Where this causes ambiguity,
<code class="docutils literal notranslate"><span class="pre">GDB</span></code> asks the user’s intent.</p>
<p>For details on the supported Ada syntax, see <cite>Debugging with GDB</cite>.</p>
</div>
<div class="section" id="calling-user-defined-subprograms">
<span id="id7"></span><h3><span class="section-number">6.1.5. </span>Calling User-Defined Subprograms<a class="headerlink" href="#calling-user-defined-subprograms" title="Permalink to this headline">¶</a></h3>
<p>An important capability of <code class="docutils literal notranslate"><span class="pre">GDB</span></code> is the ability to call user-defined
subprograms while debugging. This is achieved simply by entering
a subprogram call statement in the form:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">call</span> <span class="n">subprogram</span><span class="o">-</span><span class="n">name</span> <span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>The keyword <code class="docutils literal notranslate"><span class="pre">call</span></code> can be omitted in the normal case where the
<code class="docutils literal notranslate"><span class="pre">subprogram-name</span></code> does not coincide with any of the predefined
<code class="docutils literal notranslate"><span class="pre">GDB</span></code> commands.</p>
<p>The effect is to invoke the given subprogram, passing it the
list of parameters that is supplied. The parameters can be expressions and
can include variables from the program being debugged. The
subprogram must be defined
at the library level within your program, and <code class="docutils literal notranslate"><span class="pre">GDB</span></code> will call the
subprogram within the environment of your program execution (which
means that the subprogram is free to access or even modify variables
within your program).</p>
<p>The most important use of this facility is in allowing the inclusion of
debugging routines that are tailored to particular data structures
in your program. Such debugging routines can be written to provide a suitably
high-level description of an abstract type, rather than a low-level dump
of its physical layout. After all, the standard
<code class="docutils literal notranslate"><span class="pre">GDB</span> <span class="pre">print</span></code> command only knows the physical layout of your
types, not their abstract meaning. Debugging routines can provide information
at the desired semantic level and are thus enormously useful.</p>
<p>For example, when debugging GNAT itself, it is crucial to have access to
the contents of the tree nodes used to represent the program internally.
But tree nodes are represented simply by an integer value (which in turn
is an index into a table of nodes).
Using the <code class="docutils literal notranslate"><span class="pre">print</span></code> command on a tree node would simply print this integer
value, which is not very useful. But the PN routine (defined in file
treepr.adb in the GNAT sources) takes a tree node as input, and displays
a useful high level representation of the tree node, which includes the
syntactic category of the node, its position in the source, the integers
that denote descendant nodes and parent node, as well as varied
semantic information. To study this example in more detail, you might want to
look at the body of the PN procedure in the stated file.</p>
<p>Another useful application of this capability is to deal with situations of
complex data which are not handled suitably by GDB. For example, if you specify
Convention Fortran for a multi-dimensional array, GDB does not know that
the ordering of array elements has been switched and will not properly
address the array elements. In such a case, instead of trying to print the
elements directly from GDB, you can write a callable procedure that prints
the elements in the desired format.</p>
</div>
<div class="section" id="using-the-next-command-in-a-function">
<span id="id8"></span><h3><span class="section-number">6.1.6. </span>Using the <em>next</em> Command in a Function<a class="headerlink" href="#using-the-next-command-in-a-function" title="Permalink to this headline">¶</a></h3>
<p>When you use the <code class="docutils literal notranslate"><span class="pre">next</span></code> command in a function, the current source
location will advance to the next statement as usual. A special case
arises in the case of a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement.</p>
<p>Part of the code for a return statement is the ‘epilogue’ of the function.
This is the code that returns to the caller. There is only one copy of
this epilogue code, and it is typically associated with the last return
statement in the function if there is more than one return. In some
implementations, this epilogue is associated with the first statement
of the function.</p>
<p>The result is that if you use the <code class="docutils literal notranslate"><span class="pre">next</span></code> command from a return
statement that is not the last return statement of the function you
may see a strange apparent jump to the last return statement or to
the start of the function. You should simply ignore this odd jump.
The value returned is always that from the first return statement
that was stepped through.</p>
</div>
<div class="section" id="stopping-when-ada-exceptions-are-raised">
<span id="id9"></span><h3><span class="section-number">6.1.7. </span>Stopping When Ada Exceptions Are Raised<a class="headerlink" href="#stopping-when-ada-exceptions-are-raised" title="Permalink to this headline">¶</a></h3>
<p id="index-4">You can set catchpoints that stop the program execution when your program
raises selected exceptions.</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">catch</span> <span class="pre">exception</span></code></dt><dd><p>Set a catchpoint that stops execution whenever (any task in the) program
raises any exception.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">catch</span> <span class="pre">exception</span> <em><span class="pre">name</span></em></code></dt><dd><p>Set a catchpoint that stops execution whenever (any task in the) program
raises the exception <em>name</em>.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">catch</span> <span class="pre">exception</span> <span class="pre">unhandled</span></code></dt><dd><p>Set a catchpoint that stops executing whenever (any task in the) program
raises an exception for which there is no handler.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="samp docutils literal notranslate"><span class="pre">info</span> <span class="pre">exceptions</span></code>, <code class="samp docutils literal notranslate"><span class="pre">info</span> <span class="pre">exceptions</span> <em><span class="pre">regexp</span></em></code></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">info</span> <span class="pre">exceptions</span></code> command permits the user to examine all defined
exceptions within Ada programs. With a regular expression, <em>regexp</em>, as
argument, prints out only those exceptions whose name matches <em>regexp</em>.</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="ada-tasks">
<span id="index-5"></span><span id="id10"></span><h3><span class="section-number">6.1.8. </span>Ada Tasks<a class="headerlink" href="#ada-tasks" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">GDB</span></code> allows the following task-related commands:</p>
<ul>
<li><dl>
<dt><code class="samp docutils literal notranslate"><span class="pre">info</span> <span class="pre">tasks</span></code></dt><dd><p>This command shows a list of current Ada tasks, as in the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">info</span> <span class="n">tasks</span>
  <span class="n">ID</span>       <span class="n">TID</span> <span class="n">P</span><span class="o">-</span><span class="n">ID</span>   <span class="n">Thread</span> <span class="n">Pri</span> <span class="n">State</span>                 <span class="n">Name</span>
   <span class="mi">1</span>   <span class="mi">8088000</span>   <span class="mi">0</span>   <span class="mf">807e000</span>  <span class="mi">15</span> <span class="n">Child</span> <span class="n">Activation</span> <span class="n">Wait</span> <span class="n">main_task</span>
   <span class="mi">2</span>   <span class="mi">80</span><span class="n">a4000</span>   <span class="mi">1</span>   <span class="mi">80</span><span class="n">ae000</span>  <span class="mi">15</span> <span class="n">Accept</span><span class="o">/</span><span class="n">Select</span> <span class="n">Wait</span>    <span class="n">b</span>
   <span class="mi">3</span>   <span class="mi">809</span><span class="n">a800</span>   <span class="mi">1</span>   <span class="mi">80</span><span class="n">a4800</span>  <span class="mi">15</span> <span class="n">Child</span> <span class="n">Activation</span> <span class="n">Wait</span> <span class="n">a</span>
<span class="o">*</span>  <span class="mi">4</span>   <span class="mi">80</span><span class="n">ae800</span>   <span class="mi">3</span>   <span class="mi">80</span><span class="n">b8000</span>  <span class="mi">15</span> <span class="n">Running</span>               <span class="n">c</span>
</pre></div>
</div>
<p>In this listing, the asterisk before the first task indicates it to be the
currently running task. The first column lists the task ID that is used
to refer to tasks in the following commands.</p>
</dd>
</dl>
</li>
</ul>
<ul id="index-6">
<li><p><code class="docutils literal notranslate"><span class="pre">break``*linespec*</span> <span class="pre">``task</span></code> <em>taskid</em>, <code class="docutils literal notranslate"><span class="pre">break</span></code> <em>linespec</em> <code class="docutils literal notranslate"><span class="pre">task</span></code> <em>taskid</em> <code class="docutils literal notranslate"><span class="pre">if</span></code> …</p>
<blockquote>
<div><p>These commands are like the <code class="docutils literal notranslate"><span class="pre">break</span> <span class="pre">...</span> <span class="pre">thread</span> <span class="pre">...</span></code>.
<em>linespec</em> specifies source lines.</p>
<p>Use the qualifier <code class="samp docutils literal notranslate"><span class="pre">task</span> <em><span class="pre">taskid</span></em></code> with a breakpoint command
to specify that you only want <code class="docutils literal notranslate"><span class="pre">GDB</span></code> to stop the program when a
particular Ada task reaches this breakpoint. <em>taskid</em> is one of the
numeric task identifiers assigned by <code class="docutils literal notranslate"><span class="pre">GDB</span></code>, shown in the first
column of the <code class="docutils literal notranslate"><span class="pre">info</span> <span class="pre">tasks</span></code> display.</p>
<p>If you do not specify <code class="samp docutils literal notranslate"><span class="pre">task</span> <em><span class="pre">taskid</span></em></code> when you set a
breakpoint, the breakpoint applies to <em>all</em> tasks of your
program.</p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">task</span></code> qualifier on conditional breakpoints as
well; in this case, place <code class="samp docutils literal notranslate"><span class="pre">task</span> <em><span class="pre">taskid</span></em></code> before the
breakpoint condition (before the <code class="docutils literal notranslate"><span class="pre">if</span></code>).</p>
</div></blockquote>
</li>
</ul>
<ul id="index-7">
<li><p><code class="samp docutils literal notranslate"><span class="pre">task</span> <em><span class="pre">taskno</span></em></code></p>
<blockquote>
<div><p>This command allows switching to the task referred by <em>taskno</em>. In
particular, this allows browsing of the backtrace of the specified
task. It is advisable to switch back to the original task before
continuing execution otherwise the scheduling of the program may be
perturbed.</p>
</div></blockquote>
</li>
</ul>
<p>For more detailed information on the tasking support,
see <cite>Debugging with GDB</cite>.</p>
<span class="target" id="index-8"></span></div>
<div class="section" id="debugging-generic-units">
<span id="index-9"></span><span id="id11"></span><h3><span class="section-number">6.1.9. </span>Debugging Generic Units<a class="headerlink" href="#debugging-generic-units" title="Permalink to this headline">¶</a></h3>
<p>GNAT always uses code expansion for generic instantiation. This means that
each time an instantiation occurs, a complete copy of the original code is
made, with appropriate substitutions of formals by actuals.</p>
<p>It is not possible to refer to the original generic entities in
<code class="docutils literal notranslate"><span class="pre">GDB</span></code>, but it is always possible to debug a particular instance of
a generic, by using the appropriate expanded names. For example, if we have</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="k">procedure </span><span class="nf">g</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">generic</span><span class="p"> </span><span class="k">package </span><span class="nf">k</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">procedure </span><span class="nf">kp</span> <span class="o">(</span><span class="n">v1</span> <span class="o">:</span> <span class="kr">in</span><span class="p"> </span><span class="kr">out</span><span class="p"> </span><span class="n">integer</span><span class="o">)</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">k</span><span class="p">;</span>

   <span class="k">package body </span><span class="nf">k</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">procedure </span><span class="nf">kp</span> <span class="o">(</span><span class="n">v1</span> <span class="o">:</span> <span class="kr">in</span><span class="p"> </span><span class="kr">out</span><span class="p"> </span><span class="n">integer</span><span class="o">)</span> <span class="kr">is</span><span class="p"></span>
      <span class="kr">begin</span><span class="p"></span>
         <span class="n">v1</span> <span class="o">:=</span> <span class="n">v1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">end </span><span class="nf">kp</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">k</span><span class="p">;</span>

   <span class="k">package </span><span class="nf">k1</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">k</span><span class="p">;</span>
   <span class="k">package </span><span class="nf">k2</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">k</span><span class="p">;</span>

   <span class="n">var</span> <span class="o">:</span> <span class="n">integer</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="n">k1.kp</span> <span class="o">(</span><span class="n">var</span><span class="o">)</span><span class="p">;</span>
   <span class="n">k2.kp</span> <span class="o">(</span><span class="n">var</span><span class="o">)</span><span class="p">;</span>
   <span class="n">k1.kp</span> <span class="o">(</span><span class="n">var</span><span class="o">)</span><span class="p">;</span>
   <span class="n">k2.kp</span> <span class="o">(</span><span class="n">var</span><span class="o">)</span><span class="p">;</span>
<span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Then to break on a call to procedure kp in the k2 instance, simply
use the command:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="k">break</span> <span class="n">g</span><span class="o">.</span><span class="n">k2</span><span class="o">.</span><span class="n">kp</span>
</pre></div>
</div>
</div></blockquote>
<p>When the breakpoint occurs, you can step through the code of the
instance in the normal manner and examine the values of local variables, as for
other units.</p>
</div>
<div class="section" id="remote-debugging-with-gdbserver">
<span id="index-10"></span><span id="id12"></span><h3><span class="section-number">6.1.10. </span>Remote Debugging with gdbserver<a class="headerlink" href="#remote-debugging-with-gdbserver" title="Permalink to this headline">¶</a></h3>
<p>On platforms where gdbserver is supported, it is possible to use this tool
to debug your application remotely.  This can be useful in situations
where the program needs to be run on a target host that is different
from the host used for development, particularly when the target has
a limited amount of resources (either CPU and/or memory).</p>
<p>To do so, start your program using gdbserver on the target machine.
gdbserver then automatically suspends the execution of your program
at its entry point, waiting for a debugger to connect to it.  The
following commands starts an application and tells gdbserver to
wait for a connection with the debugger on localhost port 4444.</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gdbserver localhost:4444 program
Process program created; pid = 5685
Listening on port 4444
</pre></div>
</div>
</div></blockquote>
<p>Once gdbserver has started listening, we can tell the debugger to establish
a connection with this gdbserver, and then start the same debugging session
as if the program was being debugged on the same host, directly under
the control of GDB.</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gdb program
(gdb) target remote targethost:4444
Remote debugging using targethost:4444
0x00007f29936d0af0 in ?? () from /lib64/ld-linux-x86-64.so.
(gdb) b foo.adb:3
Breakpoint 1 at 0x401f0c: file foo.adb, line 3.
(gdb) continue
Continuing.

Breakpoint 1, foo () at foo.adb:4
4       end foo;
</pre></div>
</div>
</div></blockquote>
<p>It is also possible to use gdbserver to attach to an already running
program, in which case the execution of that program is simply suspended
until the connection between the debugger and gdbserver is established.</p>
<p>For more information on how to use gdbserver, see the <em>Using the gdbserver Program</em>
section in <cite>Debugging with GDB</cite>.
GNAT provides support for gdbserver on x86-linux, x86-windows and x86_64-linux.</p>
</div>
<div class="section" id="gnat-abnormal-termination-or-failure-to-terminate">
<span id="index-11"></span><span id="id13"></span><h3><span class="section-number">6.1.11. </span>GNAT Abnormal Termination or Failure to Terminate<a class="headerlink" href="#gnat-abnormal-termination-or-failure-to-terminate" title="Permalink to this headline">¶</a></h3>
<p>When presented with programs that contain serious errors in syntax
or semantics,
GNAT may on rare occasions  experience problems in operation, such
as aborting with a
segmentation fault or illegal memory access, raising an internal
exception, terminating abnormally, or failing to terminate at all.
In such cases, you can activate
various features of GNAT that can help you pinpoint the construct in your
program that is the likely source of the problem.</p>
<p>The following strategies are presented in increasing order of
difficulty, corresponding to your experience in using GNAT and your
familiarity with compiler internals.</p>
<ul>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">gcc</span></code> with the <code class="switch docutils literal notranslate"><span class="pre">-gnatf</span></code>. This first
switch causes all errors on a given line to be reported. In its absence,
only the first error on a line is displayed.</p>
<p>The <code class="switch docutils literal notranslate"><span class="pre">-gnatdO</span></code> switch causes errors to be displayed as soon as they
are encountered, rather than after compilation is terminated. If GNAT
terminates prematurely or goes into an infinite loop, the last error
message displayed may help to pinpoint the culprit.</p>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">gcc</span></code> with the <code class="switch docutils literal notranslate"><span class="pre">-v</span></code> (verbose) switch. In this
mode, <code class="docutils literal notranslate"><span class="pre">gcc</span></code> produces ongoing information about the progress of the
compilation and provides the name of each procedure as code is
generated. This switch allows you to find which Ada procedure was being
compiled when it encountered a code generation problem.</p></li>
</ul>
<ul class="simple" id="index-12">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">gcc</span></code> with the <code class="switch docutils literal notranslate"><span class="pre">-gnatdc</span></code> switch. This is a GNAT specific
switch that does for the front-end what <code class="switch docutils literal notranslate"><span class="pre">-v</span></code> does
for the back end. The system prints the name of each unit,
either a compilation unit or nested unit, as it is being analyzed.</p></li>
<li><p>Finally, you can start
<code class="docutils literal notranslate"><span class="pre">gdb</span></code> directly on the <code class="docutils literal notranslate"><span class="pre">gnat1</span></code> executable. <code class="docutils literal notranslate"><span class="pre">gnat1</span></code> is the
front-end of GNAT, and can be run independently (normally it is just
called from <code class="docutils literal notranslate"><span class="pre">gcc</span></code>). You can use <code class="docutils literal notranslate"><span class="pre">gdb</span></code> on <code class="docutils literal notranslate"><span class="pre">gnat1</span></code> as you
would on a C program (but <a class="reference internal" href="#the-gnat-debugger-gdb"><span class="std std-ref">The GNAT Debugger GDB</span></a> for caveats). The
<code class="docutils literal notranslate"><span class="pre">where</span></code> command is the first line of attack; the variable
<code class="docutils literal notranslate"><span class="pre">lineno</span></code> (seen by <code class="docutils literal notranslate"><span class="pre">print</span> <span class="pre">lineno</span></code>), used by the second phase of
<code class="docutils literal notranslate"><span class="pre">gnat1</span></code> and by the <code class="docutils literal notranslate"><span class="pre">gcc</span></code> backend, indicates the source line at
which the execution stopped, and <code class="docutils literal notranslate"><span class="pre">input_file</span> <span class="pre">name</span></code> indicates the name of
the source file.</p></li>
</ul>
</div>
<div class="section" id="naming-conventions-for-gnat-source-files">
<span id="id14"></span><h3><span class="section-number">6.1.12. </span>Naming Conventions for GNAT Source Files<a class="headerlink" href="#naming-conventions-for-gnat-source-files" title="Permalink to this headline">¶</a></h3>
<p>In order to examine the workings of the GNAT system, the following
brief description of its organization may be helpful:</p>
<ul>
<li><p>Files with prefix <code class="file docutils literal notranslate"><span class="pre">sc</span></code> contain the lexical scanner.</p></li>
<li><p>All files prefixed with <code class="file docutils literal notranslate"><span class="pre">par</span></code> are components of the parser. The
numbers correspond to chapters of the Ada Reference Manual. For example,
parsing of select statements can be found in <code class="file docutils literal notranslate"><span class="pre">par-ch9.adb</span></code>.</p></li>
<li><p>All files prefixed with <code class="file docutils literal notranslate"><span class="pre">sem</span></code> perform semantic analysis. The
numbers correspond to chapters of the Ada standard. For example, all
issues involving context clauses can be found in <code class="file docutils literal notranslate"><span class="pre">sem_ch10.adb</span></code>. In
addition, some features of the language require sufficient special processing
to justify their own semantic files: sem_aggr for aggregates, sem_disp for
dynamic dispatching, etc.</p></li>
<li><p>All files prefixed with <code class="file docutils literal notranslate"><span class="pre">exp</span></code> perform normalization and
expansion of the intermediate representation (abstract syntax tree, or AST).
these files use the same numbering scheme as the parser and semantics files.
For example, the construction of record initialization procedures is done in
<code class="file docutils literal notranslate"><span class="pre">exp_ch3.adb</span></code>.</p></li>
<li><p>The files prefixed with <code class="file docutils literal notranslate"><span class="pre">bind</span></code> implement the binder, which
verifies the consistency of the compilation, determines an order of
elaboration, and generates the bind file.</p></li>
<li><p>The files <code class="file docutils literal notranslate"><span class="pre">atree.ads</span></code> and <code class="file docutils literal notranslate"><span class="pre">atree.adb</span></code> detail the low-level
data structures used by the front-end.</p></li>
<li><p>The files <code class="file docutils literal notranslate"><span class="pre">sinfo.ads</span></code> and <code class="file docutils literal notranslate"><span class="pre">sinfo.adb</span></code> detail the structure of
the abstract syntax tree as produced by the parser.</p></li>
<li><p>The files <code class="file docutils literal notranslate"><span class="pre">einfo.ads</span></code> and <code class="file docutils literal notranslate"><span class="pre">einfo.adb</span></code> detail the attributes of
all entities, computed during semantic analysis.</p></li>
<li><p>Library management issues are dealt with in files with prefix
<code class="file docutils literal notranslate"><span class="pre">lib</span></code>.</p>
</li>
<li id="index-13"><p>Ada files with the prefix <code class="file docutils literal notranslate"><span class="pre">a-</span></code> are children of <code class="docutils literal notranslate"><span class="pre">Ada</span></code>, as
defined in Annex A.</p>
</li>
<li id="index-14"><p>Files with prefix <code class="file docutils literal notranslate"><span class="pre">i-</span></code> are children of <code class="docutils literal notranslate"><span class="pre">Interfaces</span></code>, as
defined in Annex B.</p>
</li>
<li id="index-15"><p>Files with prefix <code class="file docutils literal notranslate"><span class="pre">s-</span></code> are children of <code class="docutils literal notranslate"><span class="pre">System</span></code>. This includes
both language-defined children and GNAT run-time routines.</p>
</li>
<li id="index-16"><p>Files with prefix <code class="file docutils literal notranslate"><span class="pre">g-</span></code> are children of <code class="docutils literal notranslate"><span class="pre">GNAT</span></code>. These are useful
general-purpose packages, fully documented in their specs. All
the other <code class="file docutils literal notranslate"><span class="pre">.c</span></code> files are modifications of common <code class="docutils literal notranslate"><span class="pre">gcc</span></code> files.</p></li>
</ul>
</div>
<div class="section" id="getting-internal-debugging-information">
<span id="id15"></span><h3><span class="section-number">6.1.13. </span>Getting Internal Debugging Information<a class="headerlink" href="#getting-internal-debugging-information" title="Permalink to this headline">¶</a></h3>
<p>Most compilers have internal debugging switches and modes. GNAT
does also, except GNAT internal debugging switches and modes are not
secret. A summary and full description of all the compiler and binder
debug flags are in the file <code class="file docutils literal notranslate"><span class="pre">debug.adb</span></code>. You must obtain the
sources of the compiler to see the full detailed effects of these flags.</p>
<p>The switches that print the source of the program (reconstructed from
the internal tree) are of general interest for user programs, as are the
options to print
the full internal tree, and the entity table (the symbol table
information). The reconstructed source provides a readable version of the
program after the front-end has completed analysis and  expansion,
and is useful when studying the performance of specific constructs.
For example, constraint checks are indicated, complex aggregates
are replaced with loops and assignments, and tasking primitives
are replaced with run-time calls.</p>
<span class="target" id="index-17"></span><span class="target" id="index-18"></span></div>
<div class="section" id="stack-traceback">
<span id="index-19"></span><span id="id16"></span><h3><span class="section-number">6.1.14. </span>Stack Traceback<a class="headerlink" href="#stack-traceback" title="Permalink to this headline">¶</a></h3>
<p>Traceback is a mechanism to display the sequence of subprogram calls that
leads to a specified execution point in a program. Often (but not always)
the execution point is an instruction at which an exception has been raised.
This mechanism is also known as <em>stack unwinding</em> because it obtains
its information by scanning the run-time stack and recovering the activation
records of all active subprograms. Stack unwinding is one of the most
important tools for program debugging.</p>
<p>The first entry stored in traceback corresponds to the deepest calling level,
that is to say the subprogram currently executing the instruction
from which we want to obtain the traceback.</p>
<p>Note that there is no runtime performance penalty when stack traceback
is enabled, and no exception is raised during program execution.</p>
<div class="section" id="non-symbolic-traceback">
<span id="index-20"></span><span id="id17"></span><h4><span class="section-number">6.1.14.1. </span>Non-Symbolic Traceback<a class="headerlink" href="#non-symbolic-traceback" title="Permalink to this headline">¶</a></h4>
<p>Note: this feature is not supported on all platforms. See
<code class="samp docutils literal notranslate"><span class="pre">GNAT.Traceback</span></code> spec in <code class="file docutils literal notranslate"><span class="pre">g-traceb.ads</span></code>
for a complete list of supported platforms.</p>
<p class="rubric">Tracebacks From an Unhandled Exception</p>
<p>A runtime non-symbolic traceback is a list of addresses of call instructions.
To enable this feature you must use the <code class="switch docutils literal notranslate"><span class="pre">-E</span></code>
<code class="docutils literal notranslate"><span class="pre">gnatbind</span></code> option. With this option a stack traceback is stored as part
of exception information. You can retrieve this information using the
<code class="docutils literal notranslate"><span class="pre">addr2line</span></code> tool.</p>
<p>Here is a simple example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="k">procedure </span><span class="nf">STB</span> <span class="kr">is</span><span class="p"></span>

   <span class="k">procedure </span><span class="nf">P1</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">raise</span><span class="p"> </span><span class="n">Constraint_Error</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P1</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">P2</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">P1</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P2</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="n">P2</span><span class="p">;</span>
<span class="k">end </span><span class="nf">STB</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmake stb -bargs -E
$ stb

Execution terminated by unhandled exception
Exception name: CONSTRAINT_ERROR
Message: stb.adb:5
Call stack traceback locations:
0x401373 0x40138b 0x40139c 0x401335 0x4011c4 0x4011f1 0x77e892a4
</pre></div>
</div>
</div></blockquote>
<p>As we see the traceback lists a sequence of addresses for the unhandled
exception <code class="docutils literal notranslate"><span class="pre">CONSTRAINT_ERROR</span></code> raised in procedure P1. It is easy to
guess that this exception come from procedure P1. To translate these
addresses into the source lines where the calls appear, the
<code class="docutils literal notranslate"><span class="pre">addr2line</span></code> tool, described below, is invaluable. The use of this tool
requires the program to be compiled with debug information.</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmake -g stb -bargs -E
$ stb

Execution terminated by unhandled exception
Exception name: CONSTRAINT_ERROR
Message: stb.adb:5
Call stack traceback locations:
0x401373 0x40138b 0x40139c 0x401335 0x4011c4 0x4011f1 0x77e892a4

$ addr2line --exe=stb 0x401373 0x40138b 0x40139c 0x401335 0x4011c4
   0x4011f1 0x77e892a4

00401373 at d:/stb/stb.adb:5
0040138B at d:/stb/stb.adb:10
0040139C at d:/stb/stb.adb:14
00401335 at d:/stb/b~stb.adb:104
004011C4 at /build/.../crt1.c:200
004011F1 at /build/.../crt1.c:222
77E892A4 in ?? at ??:0
</pre></div>
</div>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">addr2line</span></code> tool has several other useful options:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 70%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="samp docutils literal notranslate"><span class="pre">--functions</span></code></p></td>
<td><p>to get the function name corresponding to any location</p></td>
</tr>
<tr class="row-even"><td><p><code class="samp docutils literal notranslate"><span class="pre">--demangle=gnat</span></code></p></td>
<td><p>to use the gnat decoding mode for the function names.
Note that for binutils version 2.9.x the option is
simply <code class="samp docutils literal notranslate"><span class="pre">--demangle</span></code>.</p></td>
</tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ addr2line --exe=stb --functions --demangle=gnat 0x401373 0x40138b
   0x40139c 0x401335 0x4011c4 0x4011f1

00401373 in stb.p1 at d:/stb/stb.adb:5
0040138B in stb.p2 at d:/stb/stb.adb:10
0040139C in stb at d:/stb/stb.adb:14
00401335 in main at d:/stb/b~stb.adb:104
004011C4 in &lt;__mingw_CRTStartup&gt; at /build/.../crt1.c:200
004011F1 in &lt;mainCRTStartup&gt; at /build/.../crt1.c:222
</pre></div>
</div>
</div></blockquote>
<p>From this traceback we can see that the exception was raised in
<code class="file docutils literal notranslate"><span class="pre">stb.adb</span></code> at line 5, which was reached from a procedure call in
<code class="file docutils literal notranslate"><span class="pre">stb.adb</span></code> at line 10, and so on. The <code class="file docutils literal notranslate"><span class="pre">b~std.adb</span></code> is the binder file,
which contains the call to the main program.
<a class="reference internal" href="building_executable_programs_with_gnat.html#running-gnatbind"><span class="std std-ref">Running gnatbind</span></a>. The remaining entries are assorted runtime routines,
and the output will vary from platform to platform.</p>
<p>It is also possible to use <code class="docutils literal notranslate"><span class="pre">GDB</span></code> with these traceback addresses to debug
the program. For example, we can break at a given code location, as reported
in the stack traceback:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gdb -nw stb
</pre></div>
</div>
</div></blockquote>
<p>Furthermore, this feature is not implemented inside Windows DLL. Only
the non-symbolic traceback is reported in this case.</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="k">break</span> <span class="o">*</span><span class="mh">0x401373</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">at</span> <span class="mh">0x401373</span><span class="p">:</span> <span class="n">file</span> <span class="n">stb</span><span class="o">.</span><span class="n">adb</span><span class="p">,</span> <span class="n">line</span> <span class="mf">5.</span>
</pre></div>
</div>
</div></blockquote>
<p>It is important to note that the stack traceback addresses
do not change when debug information is included. This is particularly useful
because it makes it possible to release software without debug information (to
minimize object size), get a field report that includes a stack traceback
whenever an internal bug occurs, and then be able to retrieve the sequence
of calls with the same program compiled with debug information.</p>
<p class="rubric">Tracebacks From Exception Occurrences</p>
<p>Non-symbolic tracebacks are obtained by using the <code class="switch docutils literal notranslate"><span class="pre">-E</span></code> binder argument.
The stack traceback is attached to the exception information string, and can
be retrieved in an exception handler within the Ada program, by means of the
Ada facilities defined in <code class="docutils literal notranslate"><span class="pre">Ada.Exceptions</span></code>. Here is a simple example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">Ada.Text_IO</span><span class="p">;</span>
<span class="kr">with</span><span class="nn"> Ada.Exceptions;</span>

<span class="k">procedure </span><span class="nf">STB</span> <span class="kr">is</span><span class="p"></span>

<span class="p">   </span><span class="kr">use</span><span class="nn"> Ada;</span><span class="p"></span>
<span class="p">   </span><span class="kr">use</span><span class="nn"> Ada.Exceptions;</span>

   <span class="k">procedure </span><span class="nf">P1</span> <span class="kr">is</span><span class="p"></span>
      <span class="n">K</span> <span class="o">:</span> <span class="n">Positive</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">K</span> <span class="o">:=</span> <span class="n">K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
   <span class="kr">exception</span><span class="p"></span>
      <span class="kr">when</span><span class="p"> </span><span class="n">E</span> <span class="o">:</span> <span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span>
         <span class="n">Text_IO.Put_Line</span> <span class="o">(</span><span class="n">Exception_Information</span> <span class="o">(</span><span class="n">E</span><span class="o">))</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P1</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">P2</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">P1</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P2</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="n">P2</span><span class="p">;</span>
<span class="k">end </span><span class="nf">STB</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>This program will output:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ stb

Exception name: CONSTRAINT_ERROR
Message: stb.adb:12
Call stack traceback locations:
0x4015e4 0x401633 0x401644 0x401461 0x4011c4 0x4011f1 0x77e892a4
</pre></div>
</div>
</div></blockquote>
<p class="rubric">Tracebacks From Anywhere in a Program</p>
<p>It is also possible to retrieve a stack traceback from anywhere in a
program. For this you need to
use the <code class="docutils literal notranslate"><span class="pre">GNAT.Traceback</span></code> API. This package includes a procedure called
<code class="docutils literal notranslate"><span class="pre">Call_Chain</span></code> that computes a complete stack traceback, as well as useful
display procedures described below. It is not necessary to use the
<code class="switch docutils literal notranslate"><span class="pre">-E</span></code> <code class="docutils literal notranslate"><span class="pre">gnatbind</span></code> option in this case, because the stack traceback mechanism
is invoked explicitly.</p>
<p>In the following example we compute a traceback at a specific location in
the program, and we display it using <code class="docutils literal notranslate"><span class="pre">GNAT.Debug_Utilities.Image</span></code> to
convert addresses to strings:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">Ada.Text_IO</span><span class="p">;</span>
<span class="kr">with</span><span class="nn"> GNAT.Traceback;</span><span class="p"></span>
<span class="kr">with</span><span class="nn"> GNAT.Debug_Utilities;</span>

<span class="k">procedure </span><span class="nf">STB</span> <span class="kr">is</span><span class="p"></span>

<span class="p">   </span><span class="kr">use</span><span class="nn"> Ada;</span><span class="p"></span>
<span class="p">   </span><span class="kr">use</span><span class="nn"> GNAT;</span><span class="p"></span>
<span class="p">   </span><span class="kr">use</span><span class="nn"> GNAT.Traceback;</span>

   <span class="k">procedure </span><span class="nf">P1</span> <span class="kr">is</span><span class="p"></span>
      <span class="n">TB</span>  <span class="o">:</span> <span class="n">Tracebacks_Array</span> <span class="o">(</span><span class="mi">1</span> <span class="o">..</span> <span class="mi">10</span><span class="o">)</span><span class="p">;</span>
      <span class="c">--  We are asking for a maximum of 10 stack frames.</span>
      <span class="n">Len</span> <span class="o">:</span> <span class="n">Natural</span><span class="p">;</span>
      <span class="c">--  Len will receive the actual number of stack frames returned.</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Call_Chain</span> <span class="o">(</span><span class="n">TB</span><span class="p">,</span> <span class="n">Len</span><span class="o">)</span><span class="p">;</span>

      <span class="n">Text_IO.Put</span> <span class="o">(</span><span class="s">&quot;In STB.P1 : &quot;</span><span class="o">)</span><span class="p">;</span>

      <span class="kr">for</span><span class="p"> </span><span class="n">K</span> <span class="kr">in</span><span class="p"> </span><span class="mi">1</span> <span class="o">..</span> <span class="n">Len</span> <span class="kr">loop</span><span class="p"></span>
         <span class="n">Text_IO.Put</span> <span class="o">(</span><span class="n">Debug_Utilities.Image</span> <span class="o">(</span><span class="n">TB</span> <span class="o">(</span><span class="n">K</span><span class="o">)))</span><span class="p">;</span>
         <span class="n">Text_IO.Put</span> <span class="o">(</span><span class="sc">&#39; &#39;</span><span class="o">)</span><span class="p">;</span>
      <span class="k">end loop</span><span class="p">;</span>

      <span class="n">Text_IO.New_Line</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P1</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">P2</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">P1</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P2</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="n">P2</span><span class="p">;</span>
<span class="k">end </span><span class="nf">STB</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmake -g stb
$ stb

In STB.P1 : 16#0040_F1E4# 16#0040_14F2# 16#0040_170B# 16#0040_171C#
16#0040_1461# 16#0040_11C4# 16#0040_11F1# 16#77E8_92A4#
</pre></div>
</div>
</div></blockquote>
<p>You can then get further information by invoking the <code class="docutils literal notranslate"><span class="pre">addr2line</span></code>
tool as described earlier (note that the hexadecimal addresses
need to be specified in C format, with a leading ‘0x’).</p>
</div>
<div class="section" id="symbolic-traceback">
<span id="index-21"></span><span id="id18"></span><h4><span class="section-number">6.1.14.2. </span>Symbolic Traceback<a class="headerlink" href="#symbolic-traceback" title="Permalink to this headline">¶</a></h4>
<p>A symbolic traceback is a stack traceback in which procedure names are
associated with each code location.</p>
<p>Note that this feature is not supported on all platforms. See
<code class="samp docutils literal notranslate"><span class="pre">GNAT.Traceback.Symbolic</span></code> spec in <code class="file docutils literal notranslate"><span class="pre">g-trasym.ads</span></code> for a complete
list of currently supported platforms.</p>
<p>Note that the symbolic traceback requires that the program be compiled
with debug information. If it is not compiled with debug information
only the non-symbolic information will be valid.</p>
<p class="rubric">Tracebacks From Exception Occurrences</p>
<p>Here is an example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">Ada.Text_IO</span><span class="p">;</span>
<span class="kr">with</span><span class="nn"> GNAT.Traceback.Symbolic;</span>

<span class="k">procedure </span><span class="nf">STB</span> <span class="kr">is</span><span class="p"></span>

   <span class="k">procedure </span><span class="nf">P1</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">raise</span><span class="p"> </span><span class="n">Constraint_Error</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P1</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">P2</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">P1</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P2</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">P3</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">P2</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P3</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="n">P3</span><span class="p">;</span>
<span class="kr">exception</span><span class="p"></span>
   <span class="kr">when</span><span class="p"> </span><span class="n">E</span> <span class="o">:</span> <span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span>
      <span class="n">Ada.Text_IO.Put_Line</span> <span class="o">(</span><span class="n">GNAT.Traceback.Symbolic.Symbolic_Traceback</span> <span class="o">(</span><span class="n">E</span><span class="o">))</span><span class="p">;</span>
<span class="k">end </span><span class="nf">STB</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmake -g .\stb -bargs -E
$ stb

0040149F in stb.p1 at stb.adb:8
004014B7 in stb.p2 at stb.adb:13
004014CF in stb.p3 at stb.adb:18
004015DD in ada.stb at stb.adb:22
00401461 in main at b~stb.adb:168
004011C4 in __mingw_CRTStartup at crt1.c:200
004011F1 in mainCRTStartup at crt1.c:222
77E892A4 in ?? at ??:0
</pre></div>
</div>
</div></blockquote>
<p>In the above example the <code class="docutils literal notranslate"><span class="pre">.\</span></code> syntax in the <code class="docutils literal notranslate"><span class="pre">gnatmake</span></code> command
is currently required by <code class="docutils literal notranslate"><span class="pre">addr2line</span></code> for files that are in
the current working directory.
Moreover, the exact sequence of linker options may vary from platform
to platform.
The above <code class="switch docutils literal notranslate"><span class="pre">-largs</span></code> section is for Windows platforms. By contrast,
under Unix there is no need for the <code class="switch docutils literal notranslate"><span class="pre">-largs</span></code> section.
Differences across platforms are due to details of linker implementation.</p>
<p class="rubric">Tracebacks From Anywhere in a Program</p>
<p>It is possible to get a symbolic stack traceback
from anywhere in a program, just as for non-symbolic tracebacks.
The first step is to obtain a non-symbolic
traceback, and then call <code class="docutils literal notranslate"><span class="pre">Symbolic_Traceback</span></code> to compute the symbolic
information. Here is an example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">Ada.Text_IO</span><span class="p">;</span>
<span class="kr">with</span><span class="nn"> GNAT.Traceback;</span><span class="p"></span>
<span class="kr">with</span><span class="nn"> GNAT.Traceback.Symbolic;</span>

<span class="k">procedure </span><span class="nf">STB</span> <span class="kr">is</span><span class="p"></span>

<span class="p">   </span><span class="kr">use</span><span class="nn"> Ada;</span><span class="p"></span>
<span class="p">   </span><span class="kr">use</span><span class="nn"> GNAT.Traceback;</span><span class="p"></span>
<span class="p">   </span><span class="kr">use</span><span class="nn"> GNAT.Traceback.Symbolic;</span>

   <span class="k">procedure </span><span class="nf">P1</span> <span class="kr">is</span><span class="p"></span>
      <span class="n">TB</span>  <span class="o">:</span> <span class="n">Tracebacks_Array</span> <span class="o">(</span><span class="mi">1</span> <span class="o">..</span> <span class="mi">10</span><span class="o">)</span><span class="p">;</span>
      <span class="c">--  We are asking for a maximum of 10 stack frames.</span>
      <span class="n">Len</span> <span class="o">:</span> <span class="n">Natural</span><span class="p">;</span>
      <span class="c">--  Len will receive the actual number of stack frames returned.</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Call_Chain</span> <span class="o">(</span><span class="n">TB</span><span class="p">,</span> <span class="n">Len</span><span class="o">)</span><span class="p">;</span>
      <span class="n">Text_IO.Put_Line</span> <span class="o">(</span><span class="n">Symbolic_Traceback</span> <span class="o">(</span><span class="n">TB</span> <span class="o">(</span><span class="mi">1</span> <span class="o">..</span> <span class="n">Len</span><span class="o">)))</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P1</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">P2</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">P1</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">P2</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="n">P2</span><span class="p">;</span>
<span class="k">end </span><span class="nf">STB</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p class="rubric">Automatic Symbolic Tracebacks</p>
<p>Symbolic tracebacks may also be enabled by using the -Es switch to gnatbind (as
in <code class="docutils literal notranslate"><span class="pre">gprbuild</span> <span class="pre">-g</span> <span class="pre">...</span> <span class="pre">-bargs</span> <span class="pre">-Es</span></code>).
This will cause the Exception_Information to contain a symbolic traceback,
which will also be printed if an unhandled exception terminates the
program.</p>
</div>
</div>
<div class="section" id="pretty-printers-for-the-gnat-runtime">
<span id="id19"></span><h3><span class="section-number">6.1.15. </span>Pretty-Printers for the GNAT runtime<a class="headerlink" href="#pretty-printers-for-the-gnat-runtime" title="Permalink to this headline">¶</a></h3>
<p>As discussed in <cite>Calling User-Defined Subprograms</cite>, GDB’s
<code class="docutils literal notranslate"><span class="pre">print</span></code> command only knows about the physical layout of program data
structures and therefore normally displays only low-level dumps, which
are often hard to understand.</p>
<p>An example of this is when trying to display the contents of an Ada
standard container, such as <code class="docutils literal notranslate"><span class="pre">Ada.Containers.Ordered_Maps.Map</span></code>:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">Ada.Containers.Ordered_Maps</span><span class="p">;</span>

<span class="k">procedure </span><span class="nf">PP</span> <span class="kr">is</span><span class="p"></span>
   <span class="k">package </span><span class="nf">Int_To_Nat</span> <span class="kr">is</span><span class="p"></span>
      <span class="kr">new</span><span class="p"> </span><span class="n">Ada.Containers.Ordered_Maps</span> <span class="o">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Natural</span><span class="o">)</span><span class="p">;</span>

   <span class="n">Map</span> <span class="o">:</span> <span class="n">Int_To_Nat.Map</span><span class="p">;</span>
<span class="kr">begin</span><span class="p"></span>
   <span class="n">Map.Insert</span> <span class="o">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="o">)</span><span class="p">;</span>
   <span class="n">Map.Insert</span> <span class="o">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="o">)</span><span class="p">;</span>
   <span class="n">Map.Insert</span> <span class="o">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">30</span><span class="o">)</span><span class="p">;</span>

   <span class="n">Map.Clear</span><span class="p">;</span> <span class="c">--  BREAK HERE</span>
<span class="k">end </span><span class="nf">PP</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>When this program is built with debugging information and run under
GDB up to the <code class="docutils literal notranslate"><span class="pre">Map.Clear</span></code> statement, trying to print <code class="docutils literal notranslate"><span class="pre">Map</span></code> will
yield information that is only relevant to the developers of our standard
containers:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) print map
$1 = (
  tree =&gt; (
    first =&gt; 0x64e010,
    last =&gt; 0x64e070,
    root =&gt; 0x64e040,
    length =&gt; 3,
    tc =&gt; (
      busy =&gt; 0,
      lock =&gt; 0
    )
  )
)
</pre></div>
</div>
</div></blockquote>
<p>Fortunately, GDB has a feature called <a class="reference external" href="http://docs.adacore.com/gdb-docs/html/gdb.html#Pretty_002dPrinter-Introduction">pretty-printers</a>,
which allows customizing how GDB displays data structures. The GDB
shipped with GNAT embeds such pretty-printers for the most common
containers in the standard library.  To enable them, either run the
following command manually under GDB or add it to your <code class="docutils literal notranslate"><span class="pre">.gdbinit</span></code> file:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="kn">import</span> <span class="nn">gnatdbg</span><span class="p">;</span> <span class="n">gnatdbg</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
<p>Once this is done, GDB’s <code class="docutils literal notranslate"><span class="pre">print</span></code> command will automatically use
these pretty-printers when appropriate. Using the previous example:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) print map
$1 = pp.int_to_nat.map of length 3 = {
  [1] = 10,
  [2] = 20,
  [3] = 30
}
</pre></div>
</div>
</div></blockquote>
<p>Pretty-printers are invoked each time GDB tries to display a value,
including when displaying the arguments of a called subprogram (in
GDB’s <code class="docutils literal notranslate"><span class="pre">backtrace</span></code> command) or when printing the value returned by a
function (in GDB’s <code class="docutils literal notranslate"><span class="pre">finish</span></code> command).</p>
<p>To display a value without involving pretty-printers, <code class="docutils literal notranslate"><span class="pre">print</span></code> can be
invoked with its <code class="docutils literal notranslate"><span class="pre">/r</span></code> option:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) print/r map
$1 = (
  tree =&gt; (...
</pre></div>
</div>
</div></blockquote>
<p>Finer control of pretty-printers is also possible: see <a class="reference external" href="http://docs.adacore.com/gdb-docs/html/gdb.html#Pretty_002dPrinter-Commands">GDB’s online
documentation</a>
for more information.</p>
</div>
</div>
<div class="section" id="profiling">
<span id="index-22"></span><span id="id20"></span><h2><span class="section-number">6.2. </span>Profiling<a class="headerlink" href="#profiling" title="Permalink to this headline">¶</a></h2>
<p>This section describes how to use the <code class="docutils literal notranslate"><span class="pre">gprof</span></code> profiler tool on Ada programs.</p>
<span class="target" id="index-23"></span><div class="section" id="profiling-an-ada-program-with-gprof">
<span id="index-24"></span><span id="id21"></span><h3><span class="section-number">6.2.1. </span>Profiling an Ada Program with gprof<a class="headerlink" href="#profiling-an-ada-program-with-gprof" title="Permalink to this headline">¶</a></h3>
<p>This section is not meant to be an exhaustive documentation of <code class="docutils literal notranslate"><span class="pre">gprof</span></code>.
Full documentation for it can be found in the <cite>GNU Profiler User’s Guide</cite>
documentation that is part of this GNAT distribution.</p>
<p>Profiling a program helps determine the parts of a program that are executed
most often, and are therefore the most time-consuming.</p>
<p><code class="docutils literal notranslate"><span class="pre">gprof</span></code> is the standard GNU profiling tool; it has been enhanced to
better handle Ada programs and multitasking.
It is currently supported on the following platforms</p>
<ul class="simple">
<li><p>linux x86/x86_64</p></li>
<li><p>windows x86</p></li>
</ul>
<p>In order to profile a program using <code class="docutils literal notranslate"><span class="pre">gprof</span></code>, several steps are needed:</p>
<ol class="arabic simple">
<li><p>Instrument the code, which requires a full recompilation of the project with the
proper switches.</p></li>
<li><p>Execute the program under the analysis conditions, i.e. with the desired
input.</p></li>
<li><p>Analyze the results using the <code class="docutils literal notranslate"><span class="pre">gprof</span></code> tool.</p></li>
</ol>
<p>The following sections detail the different steps, and indicate how
to interpret the results.</p>
<div class="section" id="compilation-for-profiling">
<span id="id22"></span><h4><span class="section-number">6.2.1.1. </span>Compilation for profiling<a class="headerlink" href="#compilation-for-profiling" title="Permalink to this headline">¶</a></h4>
<span class="target" id="index-25"></span><p id="index-26">In order to profile a program the first step is to tell the compiler
to generate the necessary profiling information. The compiler switch to be used
is <code class="docutils literal notranslate"><span class="pre">-pg</span></code>, which must be added to other compilation switches. This
switch needs to be specified both during compilation and link stages, and can
be specified once when using gnatmake:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmake -f -pg -P my_project
</pre></div>
</div>
</div></blockquote>
<p>Note that only the objects that were compiled with the <code class="docutils literal notranslate"><span class="pre">-pg</span></code> switch will
be profiled; if you need to profile your whole project, use the <code class="docutils literal notranslate"><span class="pre">-f</span></code>
gnatmake switch to force full recompilation.</p>
</div>
<div class="section" id="program-execution">
<span id="id23"></span><h4><span class="section-number">6.2.1.2. </span>Program execution<a class="headerlink" href="#program-execution" title="Permalink to this headline">¶</a></h4>
<p>Once the program has been compiled for profiling, you can run it as usual.</p>
<p>The only constraint imposed by profiling is that the program must terminate
normally. An interrupted program (via a Ctrl-C, kill, etc.) will not be
properly analyzed.</p>
<p>Once the program completes execution, a data file called <code class="file docutils literal notranslate"><span class="pre">gmon.out</span></code> is
generated in the directory where the program was launched from. If this file
already exists, it will be overwritten.</p>
</div>
<div class="section" id="running-gprof">
<span id="id24"></span><h4><span class="section-number">6.2.1.3. </span>Running gprof<a class="headerlink" href="#running-gprof" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">gprof</span></code> tool is called as follow:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gprof my_prog gmon.out
</pre></div>
</div>
</div></blockquote>
<p>or simply:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  gprof my_prog
</pre></div>
</div>
</div></blockquote>
<p>The complete form of the gprof command line is the following:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gprof [switches] [executable [data-file]]
</pre></div>
</div>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">gprof</span></code> supports numerous switches. The order of these
switch does not matter. The full list of options can be found in
the GNU Profiler User’s Guide documentation that comes with this documentation.</p>
<p>The following is the subset of those switches that is most relevant:</p>
<dl class="simple" id="index-27">
<dt><code class="samp docutils literal notranslate"><span class="pre">--demangle[=</span><em><span class="pre">style</span></em><span class="pre">]</span></code>, <code class="samp docutils literal notranslate"><span class="pre">--no-demangle</span></code></dt><dd><p>These options control whether symbol names should be demangled when
printing output.  The default is to demangle C++ symbols.  The
<code class="docutils literal notranslate"><span class="pre">--no-demangle</span></code> option may be used to turn off demangling. Different
compilers have different mangling styles.  The optional demangling style
argument can be used to choose an appropriate demangling style for your
compiler, in particular Ada symbols generated by GNAT can be demangled using
<code class="docutils literal notranslate"><span class="pre">--demangle=gnat</span></code>.</p>
</dd>
</dl>
<dl class="simple" id="index-28">
<dt><code class="samp docutils literal notranslate"><span class="pre">-e</span> <em><span class="pre">function_name</span></em></code></dt><dd><p>The <code class="samp docutils literal notranslate"><span class="pre">-e</span> <em><span class="pre">function</span></em></code> option tells <code class="docutils literal notranslate"><span class="pre">gprof</span></code> not to print
information about the function <code class="docutils literal notranslate"><span class="pre">function_name</span></code> (and its
children…) in the call graph.  The function will still be listed
as a child of any functions that call it, but its index number will be
shown as <code class="docutils literal notranslate"><span class="pre">[not</span> <span class="pre">printed]</span></code>.  More than one <code class="docutils literal notranslate"><span class="pre">-e</span></code> option may be
given; only one <code class="docutils literal notranslate"><span class="pre">function_name</span></code> may be indicated with each <code class="docutils literal notranslate"><span class="pre">-e</span></code>
option.</p>
</dd>
</dl>
<dl class="simple" id="index-29">
<dt><code class="samp docutils literal notranslate"><span class="pre">-E</span> <em><span class="pre">function_name</span></em></code></dt><dd><p>The <code class="samp docutils literal notranslate"><span class="pre">-E</span> <em><span class="pre">function</span></em></code> option works like the <code class="docutils literal notranslate"><span class="pre">-e</span></code> option, but
execution time spent in the function (and children who were not called from
anywhere else), will not be used to compute the percentages-of-time for
the call graph.  More than one <code class="switch docutils literal notranslate"><span class="pre">-E</span></code> option may be given; only one
<code class="docutils literal notranslate"><span class="pre">function_name</span></code> may be indicated with each <code class="switch docutils literal notranslate"><span class="pre">-E`</span></code> option.</p>
</dd>
</dl>
<dl class="simple" id="index-30">
<dt><code class="samp docutils literal notranslate"><span class="pre">-f</span> <em><span class="pre">function_name</span></em></code></dt><dd><p>The <code class="samp docutils literal notranslate"><span class="pre">-f</span> <em><span class="pre">function</span></em></code> option causes <code class="docutils literal notranslate"><span class="pre">gprof</span></code> to limit the
call graph to the function <code class="docutils literal notranslate"><span class="pre">function_name</span></code> and its children (and
their children…).  More than one <code class="docutils literal notranslate"><span class="pre">-f</span></code> option may be given;
only one <code class="docutils literal notranslate"><span class="pre">function_name</span></code> may be indicated with each <code class="docutils literal notranslate"><span class="pre">-f</span></code>
option.</p>
</dd>
</dl>
<dl class="simple" id="index-31">
<dt><code class="samp docutils literal notranslate"><span class="pre">-F</span> <em><span class="pre">function_name</span></em></code></dt><dd><p>The <code class="samp docutils literal notranslate"><span class="pre">-F</span> <em><span class="pre">function</span></em></code> option works like the <code class="docutils literal notranslate"><span class="pre">-f</span></code> option, but
only time spent in the function and its children (and their
children…) will be used to determine total-time and
percentages-of-time for the call graph.  More than one <code class="docutils literal notranslate"><span class="pre">-F</span></code> option
may be given; only one <code class="docutils literal notranslate"><span class="pre">function_name</span></code> may be indicated with each
<code class="docutils literal notranslate"><span class="pre">-F</span></code> option.  The <code class="docutils literal notranslate"><span class="pre">-F</span></code> option overrides the <code class="docutils literal notranslate"><span class="pre">-E</span></code> option.</p>
</dd>
</dl>
</div>
<div class="section" id="interpretation-of-profiling-results">
<span id="id25"></span><h4><span class="section-number">6.2.1.4. </span>Interpretation of profiling results<a class="headerlink" href="#interpretation-of-profiling-results" title="Permalink to this headline">¶</a></h4>
<p>The results of the profiling analysis are represented by two arrays: the
‘flat profile’ and the ‘call graph’. Full documentation of those outputs
can be found in the GNU Profiler User’s Guide.</p>
<p>The flat profile shows the time spent in each function of the program, and how
many time it has been called. This allows you to locate easily the most
time-consuming functions.</p>
<p>The call graph shows, for each subprogram, the subprograms that call it,
and the subprograms that it calls. It also provides an estimate of the time
spent in each of those callers/called subprograms.</p>
</div>
</div>
</div>
<div class="section" id="improving-performance">
<span id="id26"></span><h2><span class="section-number">6.3. </span>Improving Performance<a class="headerlink" href="#improving-performance" title="Permalink to this headline">¶</a></h2>
<p id="index-32">This section presents several topics related to program performance.
It first describes some of the tradeoffs that need to be considered
and some of the techniques for making your program run faster.</p>
<p>It then documents the unused subprogram/data elimination feature,
which can reduce the size of program executables.</p>
<div class="section" id="performance-considerations">
<span id="id27"></span><h3><span class="section-number">6.3.1. </span>Performance Considerations<a class="headerlink" href="#performance-considerations" title="Permalink to this headline">¶</a></h3>
<p>The GNAT system provides a number of options that allow a trade-off
between</p>
<ul class="simple">
<li><p>performance of the generated code</p></li>
<li><p>speed of compilation</p></li>
<li><p>minimization of dependences and recompilation</p></li>
<li><p>the degree of run-time checking.</p></li>
</ul>
<p>The defaults (if no options are selected) aim at improving the speed
of compilation and minimizing dependences, at the expense of performance
of the generated code:</p>
<ul class="simple">
<li><p>no optimization</p></li>
<li><p>no inlining of subprogram calls</p></li>
<li><p>all run-time checks enabled except overflow and elaboration checks</p></li>
</ul>
<p>These options are suitable for most program development purposes. This
section describes how you can modify these choices, and also provides
some guidelines on debugging optimized code.</p>
<div class="section" id="controlling-run-time-checks">
<span id="id28"></span><h4><span class="section-number">6.3.1.1. </span>Controlling Run-Time Checks<a class="headerlink" href="#controlling-run-time-checks" title="Permalink to this headline">¶</a></h4>
<p>By default, GNAT generates all run-time checks, except stack overflow
checks, and checks for access before elaboration on subprogram
calls. The latter are not required in default mode, because all
necessary checking is done at compile time.</p>
<span class="target" id="index-33"></span><p id="index-34">The gnat switch, <code class="switch docutils literal notranslate"><span class="pre">-gnatp</span></code> allows this default to be modified. See
<a class="reference internal" href="building_executable_programs_with_gnat.html#run-time-checks"><span class="std std-ref">Run-Time Checks</span></a>.</p>
<p>Our experience is that the default is suitable for most development
purposes.</p>
<p>Elaboration checks are off by default, and also not needed by default, since
GNAT uses a static elaboration analysis approach that avoids the need for
run-time checking. This manual contains a full chapter discussing the issue
of elaboration checks, and if the default is not satisfactory for your use,
you should read this chapter.</p>
<p>For validity checks, the minimal checks required by the Ada Reference
Manual (for case statements and assignments to array elements) are on
by default. These can be suppressed by use of the <code class="switch docutils literal notranslate"><span class="pre">-gnatVn</span></code> switch.
Note that in Ada 83, there were no validity checks, so if the Ada 83 mode
is acceptable (or when comparing GNAT performance with an Ada 83 compiler),
it may be reasonable to routinely use <code class="switch docutils literal notranslate"><span class="pre">-gnatVn</span></code>. Validity checks
are also suppressed entirely if <code class="switch docutils literal notranslate"><span class="pre">-gnatp</span></code> is used.</p>
<span class="target" id="index-35"></span><span class="target" id="index-36"></span><span class="target" id="index-37"></span><span class="target" id="index-38"></span><span class="target" id="index-39"></span><p id="index-40">Note that the setting of the switches controls the default setting of
the checks. They may be modified using either <code class="docutils literal notranslate"><span class="pre">pragma</span> <span class="pre">Suppress</span></code> (to
remove checks) or <code class="docutils literal notranslate"><span class="pre">pragma</span> <span class="pre">Unsuppress</span></code> (to add back suppressed
checks) in the program source.</p>
</div>
<div class="section" id="use-of-restrictions">
<span id="id29"></span><h4><span class="section-number">6.3.1.2. </span>Use of Restrictions<a class="headerlink" href="#use-of-restrictions" title="Permalink to this headline">¶</a></h4>
<p>The use of pragma Restrictions allows you to control which features are
permitted in your program. Apart from the obvious point that if you avoid
relatively expensive features like finalization (enforceable by the use
of pragma Restrictions (No_Finalization), the use of this pragma does not
affect the generated code in most cases.</p>
<p>One notable exception to this rule is that the possibility of task abort
results in some distributed overhead, particularly if finalization or
exception handlers are used. The reason is that certain sections of code
have to be marked as non-abortable.</p>
<p>If you use neither the <code class="docutils literal notranslate"><span class="pre">abort</span></code> statement, nor asynchronous transfer
of control (<code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">...</span> <span class="pre">then</span> <span class="pre">abort</span></code>), then this distributed overhead
is removed, which may have a general positive effect in improving
overall performance.  Especially code involving frequent use of tasking
constructs and controlled types will show much improved performance.
The relevant restrictions pragmas are</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma</span><span class="p"> </span><span class="n">Restrictions</span> <span class="o">(</span><span class="n">No_Abort_Statements</span><span class="o">)</span><span class="p">;</span>
<span class="kr">pragma</span><span class="p"> </span><span class="n">Restrictions</span> <span class="o">(</span><span class="n">Max_Asynchronous_Select_Nesting</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>It is recommended that these restriction pragmas be used if possible. Note
that this also means that you can write code without worrying about the
possibility of an immediate abort at any point.</p>
</div>
<div class="section" id="optimization-levels">
<span id="id30"></span><h4><span class="section-number">6.3.1.3. </span>Optimization Levels<a class="headerlink" href="#optimization-levels" title="Permalink to this headline">¶</a></h4>
<p id="index-41">Without any optimization option,
the compiler’s goal is to reduce the cost of
compilation and to make debugging produce the expected results.
Statements are independent: if you stop the program with a breakpoint between
statements, you can then assign a new value to any variable or change
the program counter to any other statement in the subprogram and get exactly
the results you would expect from the source code.</p>
<p>Turning on optimization makes the compiler attempt to improve the
performance and/or code size at the expense of compilation time and
possibly the ability to debug the program.</p>
<p>If you use multiple
-O options, with or without level numbers,
the last such option is the one that is effective.</p>
<p>The default is optimization off. This results in the fastest compile
times, but GNAT makes absolutely no attempt to optimize, and the
generated programs are considerably larger and slower than when
optimization is enabled. You can use the
<code class="switch docutils literal notranslate"><span class="pre">-O</span></code> switch (the permitted forms are <code class="switch docutils literal notranslate"><span class="pre">-O0</span></code>, <code class="switch docutils literal notranslate"><span class="pre">-O1</span></code>
<code class="switch docutils literal notranslate"><span class="pre">-O2</span></code>, <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code>, and <code class="switch docutils literal notranslate"><span class="pre">-Os</span></code>)
to <code class="docutils literal notranslate"><span class="pre">gcc</span></code> to control the optimization level:</p>
<ul>
<li><dl>
<dt><code class="switch docutils literal notranslate"><span class="pre">-O0</span></code></dt><dd><p>No optimization (the default);
generates unoptimized code but has
the fastest compilation time.</p>
<p>Note that many other compilers do substantial optimization even
if ‘no optimization’ is specified. With gcc, it is very unusual
to use <code class="switch docutils literal notranslate"><span class="pre">-O0</span></code> for production if execution time is of any concern,
since <code class="switch docutils literal notranslate"><span class="pre">-O0</span></code> means (almost) no optimization. This difference
between gcc and other compilers should be kept in mind when
doing performance comparisons.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="switch docutils literal notranslate"><span class="pre">-O1</span></code></dt><dd><p>Moderate optimization;
optimizes reasonably well but does not
degrade compilation time significantly.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="switch docutils literal notranslate"><span class="pre">-O2</span></code></dt><dd><p>Full optimization;
generates highly optimized code and has
the slowest compilation time.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="switch docutils literal notranslate"><span class="pre">-O3</span></code></dt><dd><p>Full optimization as in <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code>;
also uses more aggressive automatic inlining of subprograms within a unit
(<a class="reference internal" href="#inlining-of-subprograms"><span class="std std-ref">Inlining of Subprograms</span></a>) and attempts to vectorize loops.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="switch docutils literal notranslate"><span class="pre">-Os</span></code></dt><dd><p>Optimize space usage (code and data) of resulting program.</p>
</dd>
</dl>
</li>
</ul>
<p>Higher optimization levels perform more global transformations on the
program and apply more expensive analysis algorithms in order to generate
faster and more compact code. The price in compilation time, and the
resulting improvement in execution time,
both depend on the particular application and the hardware environment.
You should experiment to find the best level for your application.</p>
<p>Since the precise set of optimizations done at each level will vary from
release to release (and sometime from target to target), it is best to think
of the optimization settings in general terms.
See the <em>Options That Control Optimization</em> section in
<cite>Using the GNU Compiler Collection (GCC)</cite>
for details about
the <code class="switch docutils literal notranslate"><span class="pre">-O</span></code> settings and a number of <code class="switch docutils literal notranslate"><span class="pre">-f</span></code> options that
individually enable or disable specific optimizations.</p>
<p>Unlike some other compilation systems, <code class="docutils literal notranslate"><span class="pre">gcc</span></code> has
been tested extensively at all optimization levels. There are some bugs
which appear only with optimization turned on, but there have also been
bugs which show up only in <em>unoptimized</em> code. Selecting a lower
level of optimization does not improve the reliability of the code
generator, which in practice is highly reliable at all optimization
levels.</p>
<p>Note regarding the use of <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code>: The use of this optimization level
ought not to be automatically preferred over that of level <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code>,
since it often results in larger executables which may run more slowly.
See further discussion of this point in <a class="reference internal" href="#inlining-of-subprograms"><span class="std std-ref">Inlining of Subprograms</span></a>.</p>
</div>
<div class="section" id="debugging-optimized-code">
<span id="id31"></span><h4><span class="section-number">6.3.1.4. </span>Debugging Optimized Code<a class="headerlink" href="#debugging-optimized-code" title="Permalink to this headline">¶</a></h4>
<span class="target" id="index-42"></span><p id="index-43">Although it is possible to do a reasonable amount of debugging at
nonzero optimization levels,
the higher the level the more likely that
source-level constructs will have been eliminated by optimization.
For example, if a loop is strength-reduced, the loop
control variable may be completely eliminated and thus cannot be
displayed in the debugger.
This can only happen at <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code> or <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code>.
Explicit temporary variables that you code might be eliminated at
level <code class="switch docutils literal notranslate"><span class="pre">-O1</span></code> or higher.</p>
<p id="index-44">The use of the <code class="switch docutils literal notranslate"><span class="pre">-g</span></code> switch,
which is needed for source-level debugging,
affects the size of the program executable on disk,
and indeed the debugging information can be quite large.
However, it has no effect on the generated code (and thus does not
degrade performance)</p>
<p>Since the compiler generates debugging tables for a compilation unit before
it performs optimizations, the optimizing transformations may invalidate some
of the debugging data.  You therefore need to anticipate certain
anomalous situations that may arise while debugging optimized code.
These are the most common cases:</p>
<ul>
<li><p><em>The ‘hopping Program Counter’:</em>  Repeated <code class="docutils literal notranslate"><span class="pre">step</span></code> or <code class="docutils literal notranslate"><span class="pre">next</span></code>
commands show
the PC bouncing back and forth in the code.  This may result from any of
the following optimizations:</p>
<ul class="simple">
<li><p><em>Common subexpression elimination:</em> using a single instance of code for a
quantity that the source computes several times.  As a result you
may not be able to stop on what looks like a statement.</p></li>
<li><p><em>Invariant code motion:</em> moving an expression that does not change within a
loop, to the beginning of the loop.</p></li>
<li><p><em>Instruction scheduling:</em> moving instructions so as to
overlap loads and stores (typically) with other code, or in
general to move computations of values closer to their uses. Often
this causes you to pass an assignment statement without the assignment
happening and then later bounce back to the statement when the
value is actually needed.  Placing a breakpoint on a line of code
and then stepping over it may, therefore, not always cause all the
expected side-effects.</p></li>
</ul>
</li>
<li><p><em>The ‘big leap’:</em> More commonly known as <em>cross-jumping</em>, in which
two identical pieces of code are merged and the program counter suddenly
jumps to a statement that is not supposed to be executed, simply because
it (and the code following) translates to the same thing as the code
that <em>was</em> supposed to be executed.  This effect is typically seen in
sequences that end in a jump, such as a <code class="docutils literal notranslate"><span class="pre">goto</span></code>, a <code class="docutils literal notranslate"><span class="pre">return</span></code>, or
a <code class="docutils literal notranslate"><span class="pre">break</span></code> in a C <code class="docutils literal notranslate"><span class="pre">switch</span></code> statement.</p></li>
<li><p><em>The ‘roving variable’:</em> The symptom is an unexpected value in a variable.
There are various reasons for this effect:</p>
<ul class="simple">
<li><p>In a subprogram prologue, a parameter may not yet have been moved to its
‘home’.</p></li>
<li><p>A variable may be dead, and its register re-used.  This is
probably the most common cause.</p></li>
<li><p>As mentioned above, the assignment of a value to a variable may
have been moved.</p></li>
<li><p>A variable may be eliminated entirely by value propagation or
other means.  In this case, GCC may incorrectly generate debugging
information for the variable</p></li>
</ul>
<p>In general, when an unexpected value appears for a local variable or parameter
you should first ascertain if that value was actually computed by
your program, as opposed to being incorrectly reported by the debugger.
Record fields or
array elements in an object designated by an access value
are generally less of a problem, once you have ascertained that the access
value is sensible.
Typically, this means checking variables in the preceding code and in the
calling subprogram to verify that the value observed is explainable from other
values (one must apply the procedure recursively to those
other values); or re-running the code and stopping a little earlier
(perhaps before the call) and stepping to better see how the variable obtained
the value in question; or continuing to step <em>from</em> the point of the
strange value to see if code motion had simply moved the variable’s
assignments later.</p>
</li>
</ul>
<p>In light of such anomalies, a recommended technique is to use <code class="switch docutils literal notranslate"><span class="pre">-O0</span></code>
early in the software development cycle, when extensive debugging capabilities
are most needed, and then move to <code class="switch docutils literal notranslate"><span class="pre">-O1</span></code> and later <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code> as
the debugger becomes less critical.
Whether to use the <code class="switch docutils literal notranslate"><span class="pre">-g</span></code> switch in the release version is
a release management issue.
Note that if you use <code class="switch docutils literal notranslate"><span class="pre">-g</span></code> you can then use the <code class="docutils literal notranslate"><span class="pre">strip</span></code> program
on the resulting executable,
which removes both debugging information and global symbols.</p>
</div>
<div class="section" id="inlining-of-subprograms">
<span id="id32"></span><h4><span class="section-number">6.3.1.5. </span>Inlining of Subprograms<a class="headerlink" href="#inlining-of-subprograms" title="Permalink to this headline">¶</a></h4>
<p>A call to a subprogram in the current unit is inlined if all the
following conditions are met:</p>
<ul>
<li><p>The optimization level is at least <code class="switch docutils literal notranslate"><span class="pre">-O1</span></code>.</p></li>
<li><p>The called subprogram is suitable for inlining: It must be small enough
and not contain something that <code class="docutils literal notranslate"><span class="pre">gcc</span></code> cannot support in inlined
subprograms.</p>
<span class="target" id="index-45"></span></li>
<li id="index-46"><p>Any one of the following applies: <code class="docutils literal notranslate"><span class="pre">pragma</span> <span class="pre">Inline</span></code> is applied to the
subprogram; the subprogram is local to the unit and called once from
within it; the subprogram is small and optimization level <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code> is
specified; optimization level <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code> is specified.</p></li>
</ul>
<p>Calls to subprograms in <em>with</em>ed units are normally not inlined.
To achieve actual inlining (that is, replacement of the call by the code
in the body of the subprogram), the following conditions must all be true:</p>
<ul class="simple">
<li><p>The optimization level is at least <code class="switch docutils literal notranslate"><span class="pre">-O1</span></code>.</p></li>
<li><p>The called subprogram is suitable for inlining: It must be small enough
and not contain something that <code class="docutils literal notranslate"><span class="pre">gcc</span></code> cannot support in inlined
subprograms.</p></li>
<li><p>There is a <code class="docutils literal notranslate"><span class="pre">pragma</span> <span class="pre">Inline</span></code> for the subprogram.</p></li>
<li><p>The <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code> switch is used on the command line.</p></li>
</ul>
<p>Even if all these conditions are met, it may not be possible for
the compiler to inline the call, due to the length of the body,
or features in the body that make it impossible for the compiler
to do the inlining.</p>
<p>Note that specifying the <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code> switch causes additional
compilation dependencies. Consider the following:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">R</span> <span class="kr">is</span><span class="p"></span>
   <span class="k">procedure </span><span class="nf">Q</span><span class="p">;</span>
   <span class="kr">pragma</span><span class="p"> </span><span class="n">Inline</span> <span class="o">(</span><span class="n">Q</span><span class="o">)</span><span class="p">;</span>
<span class="k">end </span><span class="nf">R</span><span class="p">;</span>
<span class="k">package body </span><span class="nf">R</span> <span class="kr">is</span><span class="p"></span>
   <span class="o">...</span>
<span class="k">end </span><span class="nf">R</span><span class="p">;</span>

<span class="kr">with</span><span class="nn"> R;</span>
<span class="k">procedure </span><span class="nf">Main</span> <span class="kr">is</span><span class="p"></span>
<span class="kr">begin</span><span class="p"></span>
   <span class="o">...</span>
   <span class="n">R.Q</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Main</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>With the default behavior (no <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code> switch specified), the
compilation of the <code class="docutils literal notranslate"><span class="pre">Main</span></code> procedure depends only on its own source,
<code class="file docutils literal notranslate"><span class="pre">main.adb</span></code>, and the spec of the package in file <code class="file docutils literal notranslate"><span class="pre">r.ads</span></code>. This
means that editing the body of <code class="docutils literal notranslate"><span class="pre">R</span></code> does not require recompiling
<code class="docutils literal notranslate"><span class="pre">Main</span></code>.</p>
<p>On the other hand, the call <code class="docutils literal notranslate"><span class="pre">R.Q</span></code> is not inlined under these
circumstances. If the <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code> switch is present when <code class="docutils literal notranslate"><span class="pre">Main</span></code>
is compiled, the call will be inlined if the body of <code class="docutils literal notranslate"><span class="pre">Q</span></code> is small
enough, but now <code class="docutils literal notranslate"><span class="pre">Main</span></code> depends on the body of <code class="docutils literal notranslate"><span class="pre">R</span></code> in
<code class="file docutils literal notranslate"><span class="pre">r.adb</span></code> as well as on the spec. This means that if this body is edited,
the main program must be recompiled. Note that this extra dependency
occurs whether or not the call is in fact inlined by <code class="docutils literal notranslate"><span class="pre">gcc</span></code>.</p>
<p>The use of front end inlining with <code class="switch docutils literal notranslate"><span class="pre">-gnatN</span></code> generates similar
additional dependencies.</p>
<p id="index-47">Note: The <code class="switch docutils literal notranslate"><span class="pre">-fno-inline</span></code> switch overrides all other conditions and ensures that
no inlining occurs, unless requested with pragma Inline_Always for <code class="docutils literal notranslate"><span class="pre">gcc</span></code>
back-ends. The extra dependences resulting from <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code> will still be active,
even if this switch is used to suppress the resulting inlining actions.</p>
<p id="index-48">Note: The <code class="switch docutils literal notranslate"><span class="pre">-fno-inline-functions</span></code> switch can be used to prevent
automatic inlining of subprograms if <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code> is used.</p>
<p id="index-49">Note: The <code class="switch docutils literal notranslate"><span class="pre">-fno-inline-small-functions</span></code> switch can be used to prevent
automatic inlining of small subprograms if <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code> is used.</p>
<p id="index-50">Note: The <code class="switch docutils literal notranslate"><span class="pre">-fno-inline-functions-called-once</span></code> switch
can be used to prevent inlining of subprograms local to the unit
and called once from within it if <code class="switch docutils literal notranslate"><span class="pre">-O1</span></code> is used.</p>
<p>Note regarding the use of <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code>: <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code> is made up of two
sub-switches <code class="switch docutils literal notranslate"><span class="pre">-gnatn1</span></code> and <code class="switch docutils literal notranslate"><span class="pre">-gnatn2</span></code> that can be directly
specified in lieu of it, <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code> being translated into one of them
based on the optimization level. With <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code> or below, <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code>
is equivalent to <code class="switch docutils literal notranslate"><span class="pre">-gnatn1</span></code> which activates pragma <code class="docutils literal notranslate"><span class="pre">Inline</span></code> with
moderate inlining across modules. With <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code>, <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code> is
equivalent to <code class="switch docutils literal notranslate"><span class="pre">-gnatn2</span></code> which activates pragma <code class="docutils literal notranslate"><span class="pre">Inline</span></code> with
full inlining across modules. If you have used pragma <code class="docutils literal notranslate"><span class="pre">Inline</span></code> in
appropriate cases, then it is usually much better to use <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code>
and <code class="switch docutils literal notranslate"><span class="pre">-gnatn</span></code> and avoid the use of <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code> which has the additional
effect of inlining subprograms you did not think should be inlined. We have
found that the use of <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code> may slow down the compilation and increase
the code size by performing excessive inlining, leading to increased
instruction cache pressure from the increased code size and thus minor
performance improvements. So the bottom line here is that you should not
automatically assume that <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code> is better than <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code>, and
indeed you should use <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code> only if tests show that it actually
improves performance for your program.</p>
</div>
<div class="section" id="floating-point-operations">
<span id="id33"></span><h4><span class="section-number">6.3.1.6. </span>Floating Point Operations<a class="headerlink" href="#floating-point-operations" title="Permalink to this headline">¶</a></h4>
<p id="index-51">On almost all targets, GNAT maps Float and Long_Float to the 32-bit and
64-bit standard IEEE floating-point representations, and operations will
use standard IEEE arithmetic as provided by the processor. On most, but
not all, architectures, the attribute Machine_Overflows is False for these
types, meaning that the semantics of overflow is implementation-defined.
In the case of GNAT, these semantics correspond to the normal IEEE
treatment of infinities and NaN (not a number) values. For example,
1.0 / 0.0 yields plus infinitiy and 0.0 / 0.0 yields a NaN. By
avoiding explicit overflow checks, the performance is greatly improved
on many targets. However, if required, floating-point overflow can be
enabled by the use of the pragma Check_Float_Overflow.</p>
<p>Another consideration that applies specifically to x86 32-bit
architectures is which form of floating-point arithmetic is used.
By default the operations use the old style x86 floating-point,
which implements an 80-bit extended precision form (on these
architectures the type Long_Long_Float corresponds to that form).
In addition, generation of efficient code in this mode means that
the extended precision form will be used for intermediate results.
This may be helpful in improving the final precision of a complex
expression. However it means that the results obtained on the x86
will be different from those on other architectures, and for some
algorithms, the extra intermediate precision can be detrimental.</p>
<p>In addition to this old-style floating-point, all modern x86 chips
implement an alternative floating-point operation model referred
to as SSE2. In this model there is no extended form, and furthermore
execution performance is significantly enhanced. To force GNAT to use
this more modern form, use both of the switches:</p>
<blockquote>
<div><p>-msse2 -mfpmath=sse</p>
</div></blockquote>
<p>A unit compiled with these switches will automatically use the more
efficient SSE2 instruction set for Float and Long_Float operations.
Note that the ABI has the same form for both floating-point models,
so it is permissible to mix units compiled with and without these
switches.</p>
</div>
<div class="section" id="vectorization-of-loops">
<span id="id34"></span><h4><span class="section-number">6.3.1.7. </span>Vectorization of loops<a class="headerlink" href="#vectorization-of-loops" title="Permalink to this headline">¶</a></h4>
<p id="index-52">You can take advantage of the auto-vectorizer present in the <code class="docutils literal notranslate"><span class="pre">gcc</span></code>
back end to vectorize loops with GNAT.  The corresponding command line switch
is <code class="switch docutils literal notranslate"><span class="pre">-ftree-vectorize</span></code> but, as it is enabled by default at <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code>
and other aggressive optimizations helpful for vectorization also are enabled
by default at this level, using <code class="switch docutils literal notranslate"><span class="pre">-O3</span></code> directly is recommended.</p>
<p>You also need to make sure that the target architecture features a supported
SIMD instruction set.  For example, for the x86 architecture, you should at
least specify <code class="switch docutils literal notranslate"><span class="pre">-msse2</span></code> to get significant vectorization (but you don’t
need to specify it for x86-64 as it is part of the base 64-bit architecture).
Similarly, for the PowerPC architecture, you should specify <code class="switch docutils literal notranslate"><span class="pre">-maltivec</span></code>.</p>
<p>The preferred loop form for vectorization is the <code class="docutils literal notranslate"><span class="pre">for</span></code> iteration scheme.
Loops with a <code class="docutils literal notranslate"><span class="pre">while</span></code> iteration scheme can also be vectorized if they are
very simple, but the vectorizer will quickly give up otherwise.  With either
iteration scheme, the flow of control must be straight, in particular no
<code class="docutils literal notranslate"><span class="pre">exit</span></code> statement may appear in the loop body.  The loop may however
contain a single nested loop, if it can be vectorized when considered alone:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">:</span> <span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="o">..</span><span class="mi">4</span><span class="o">)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Long_Float</span><span class="p">;</span>
<span class="n">S</span> <span class="o">:</span> <span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">4</span><span class="o">)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Long_Float</span><span class="p">;</span>

<span class="k">procedure </span><span class="nf">Sum</span> <span class="kr">is</span><span class="p"></span>
<span class="kr">begin</span><span class="p"></span>
   <span class="kr">for</span><span class="p"> </span><span class="n">I</span> <span class="kr">in</span><span class="p"> </span><span class="n">A</span><span class="na">&#39;Range</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="kr">loop</span><span class="p"></span>
      <span class="kr">for</span><span class="p"> </span><span class="n">J</span> <span class="kr">in</span><span class="p"> </span><span class="n">A</span><span class="na">&#39;Range</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="kr">loop</span><span class="p"></span>
         <span class="n">S</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span> <span class="o">:=</span> <span class="n">S</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span> <span class="o">+</span> <span class="n">A</span> <span class="o">(</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="o">)</span><span class="p">;</span>
      <span class="k">end loop</span><span class="p">;</span>
   <span class="k">end loop</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Sum</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>The vectorizable operations depend on the targeted SIMD instruction set, but
the adding and some of the multiplying operators are generally supported, as
well as the logical operators for modular types. Note that compiling
with <code class="switch docutils literal notranslate"><span class="pre">-gnatp</span></code> might well reveal cases where some checks do thwart
vectorization.</p>
<p>Type conversions may also prevent vectorization if they involve semantics that
are not directly supported by the code generator or the SIMD instruction set.
A typical example is direct conversion from floating-point to integer types.
The solution in this case is to use the following idiom:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">Integer</span> <span class="o">(</span><span class="n">S</span><span class="na">&#39;Truncation</span> <span class="o">(</span><span class="n">F</span><span class="o">))</span>
</pre></div>
</div>
</div></blockquote>
<p>if <code class="docutils literal notranslate"><span class="pre">S</span></code> is the subtype of floating-point object <code class="docutils literal notranslate"><span class="pre">F</span></code>.</p>
<p>In most cases, the vectorizable loops are loops that iterate over arrays.
All kinds of array types are supported, i.e. constrained array types with
static bounds:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">Array_Type</span> <span class="kr">is</span><span class="p"> </span><span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="mi">1</span> <span class="o">..</span> <span class="mi">4</span><span class="o">)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Long_Float</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>constrained array types with dynamic bounds:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">Array_Type</span> <span class="kr">is</span><span class="p"> </span><span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="mi">1</span> <span class="o">..</span> <span class="n">Q.N</span><span class="o">)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Long_Float</span><span class="p">;</span>

<span class="kr">type</span><span class="p"> </span><span class="n">Array_Type</span> <span class="kr">is</span><span class="p"> </span><span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="n">Q.K</span> <span class="o">..</span> <span class="mi">4</span><span class="o">)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Long_Float</span><span class="p">;</span>

<span class="kr">type</span><span class="p"> </span><span class="n">Array_Type</span> <span class="kr">is</span><span class="p"> </span><span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="n">Q.K</span> <span class="o">..</span> <span class="n">Q.N</span><span class="o">)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Long_Float</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>or unconstrained array types:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">Array_Type</span> <span class="kr">is</span><span class="p"> </span><span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="n">Positive</span> <span class="kr">range</span><span class="p"> </span><span class="o">&lt;&gt;)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Long_Float</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>The quality of the generated code decreases when the dynamic aspect of the
array type increases, the worst code being generated for unconstrained array
types.  This is so because, the less information the compiler has about the
bounds of the array, the more fallback code it needs to generate in order to
fix things up at run time.</p>
<p>It is possible to specify that a given loop should be subject to vectorization
preferably to other optimizations by means of pragma <code class="docutils literal notranslate"><span class="pre">Loop_Optimize</span></code>:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma</span><span class="p"> </span><span class="n">Loop_Optimize</span> <span class="o">(</span><span class="n">Vector</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>placed immediately within the loop will convey the appropriate hint to the
compiler for this loop.</p>
<p>It is also possible to help the compiler generate better vectorized code
for a given loop by asserting that there are no loop-carried dependencies
in the loop.  Consider for example the procedure:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">Arr</span> <span class="kr">is</span><span class="p"> </span><span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="mi">1</span> <span class="o">..</span> <span class="mi">4</span><span class="o">)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Long_Float</span><span class="p">;</span>

<span class="k">procedure </span><span class="nf">Add</span> <span class="o">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">:</span> <span class="kr">not</span><span class="p"> </span><span class="kr">null</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Arr</span><span class="p">;</span> <span class="n">R</span> <span class="o">:</span> <span class="kr">not</span><span class="p"> </span><span class="kr">null</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Arr</span><span class="o">)</span> <span class="kr">is</span><span class="p"></span>
<span class="kr">begin</span><span class="p"></span>
  <span class="kr">for</span><span class="p"> </span><span class="n">I</span> <span class="kr">in</span><span class="p"> </span><span class="n">Arr</span><span class="na">&#39;Range</span> <span class="kr">loop</span><span class="p"></span>
    <span class="n">R</span><span class="o">(</span><span class="n">I</span><span class="o">)</span> <span class="o">:=</span> <span class="n">X</span><span class="o">(</span><span class="n">I</span><span class="o">)</span> <span class="o">+</span> <span class="n">Y</span><span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="p">;</span>
  <span class="k">end loop</span><span class="p">;</span>
<span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>By default, the compiler cannot unconditionally vectorize the loop because
assigning to a component of the array designated by R in one iteration could
change the value read from the components of the array designated by X or Y
in a later iteration.  As a result, the compiler will generate two versions
of the loop in the object code, one vectorized and the other not vectorized,
as well as a test to select the appropriate version at run time.  This can
be overcome by another hint:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma</span><span class="p"> </span><span class="n">Loop_Optimize</span> <span class="o">(</span><span class="n">Ivdep</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>placed immediately within the loop will tell the compiler that it can safely
omit the non-vectorized version of the loop as well as the run-time test.</p>
</div>
<div class="section" id="other-optimization-switches">
<span id="id35"></span><h4><span class="section-number">6.3.1.8. </span>Other Optimization Switches<a class="headerlink" href="#other-optimization-switches" title="Permalink to this headline">¶</a></h4>
<p id="index-53">Since GNAT uses the <code class="docutils literal notranslate"><span class="pre">gcc</span></code> back end, all the specialized
<code class="docutils literal notranslate"><span class="pre">gcc</span></code> optimization switches are potentially usable. These switches
have not been extensively tested with GNAT but can generally be expected
to work. Examples of switches in this category are <code class="switch docutils literal notranslate"><span class="pre">-funroll-loops</span></code>
and the various target-specific <code class="switch docutils literal notranslate"><span class="pre">-m</span></code> options (in particular, it has
been observed that <code class="switch docutils literal notranslate"><span class="pre">-march=xxx</span></code> can significantly improve performance
on appropriate machines). For full details of these switches, see
the <em>Submodel Options</em> section in the <em>Hardware Models and Configurations</em>
chapter of <cite>Using the GNU Compiler Collection (GCC)</cite>.</p>
</div>
<div class="section" id="optimization-and-strict-aliasing">
<span id="id36"></span><h4><span class="section-number">6.3.1.9. </span>Optimization and Strict Aliasing<a class="headerlink" href="#optimization-and-strict-aliasing" title="Permalink to this headline">¶</a></h4>
<span class="target" id="index-54"></span><span class="target" id="index-55"></span><p id="index-56">The strong typing capabilities of Ada allow an optimizer to generate
efficient code in situations where other languages would be forced to
make worst case assumptions preventing such optimizations. Consider
the following example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="k">procedure </span><span class="nf">R</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">type</span><span class="p"> </span><span class="n">Int1</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">Integer</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">Int2</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">Integer</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">Int1A</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Int1</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">Int2A</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Int2</span><span class="p">;</span>
   <span class="n">Int1V</span> <span class="o">:</span> <span class="n">Int1A</span><span class="p">;</span>
   <span class="n">Int2V</span> <span class="o">:</span> <span class="n">Int2A</span><span class="p">;</span>
   <span class="o">...</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="o">...</span>
   <span class="kr">for</span><span class="p"> </span><span class="n">J</span> <span class="kr">in</span><span class="p"> </span><span class="n">Data</span><span class="na">&#39;Range</span> <span class="kr">loop</span><span class="p"></span>
      <span class="kr">if</span><span class="p"> </span><span class="n">Data</span> <span class="o">(</span><span class="n">J</span><span class="o">)</span> <span class="o">=</span> <span class="n">Int1V.all</span> <span class="kr">then</span><span class="p"></span>
         <span class="n">Int2V.all</span> <span class="o">:=</span> <span class="n">Int2V.all</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">end if</span><span class="p">;</span>
   <span class="k">end loop</span><span class="p">;</span>
   <span class="o">...</span>
<span class="k">end </span><span class="nf">R</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>In this example, since the variable <code class="docutils literal notranslate"><span class="pre">Int1V</span></code> can only access objects
of type <code class="docutils literal notranslate"><span class="pre">Int1</span></code>, and <code class="docutils literal notranslate"><span class="pre">Int2V</span></code> can only access objects of type
<code class="docutils literal notranslate"><span class="pre">Int2</span></code>, there is no possibility that the assignment to
<code class="docutils literal notranslate"><span class="pre">Int2V.all</span></code> affects the value of <code class="docutils literal notranslate"><span class="pre">Int1V.all</span></code>. This means that
the compiler optimizer can “know” that the value <code class="docutils literal notranslate"><span class="pre">Int1V.all</span></code> is constant
for all iterations of the loop and avoid the extra memory reference
required to dereference it each time through the loop.</p>
<p>This kind of optimization, called strict aliasing analysis, is
triggered by specifying an optimization level of <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code> or
higher or <code class="switch docutils literal notranslate"><span class="pre">-Os</span></code> and allows GNAT to generate more efficient code
when access values are involved.</p>
<p>However, although this optimization is always correct in terms of
the formal semantics of the Ada Reference Manual, difficulties can
arise if features like <code class="docutils literal notranslate"><span class="pre">Unchecked_Conversion</span></code> are used to break
the typing system. Consider the following complete program example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="k">package </span><span class="nf">p1</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">type</span><span class="p"> </span><span class="n">int1</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">integer</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">int2</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">integer</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">a1</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">int1</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">a2</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">int2</span><span class="p">;</span>
<span class="k">end </span><span class="nf">p1</span><span class="p">;</span>

<span class="kr">with</span><span class="nn"> p1;</span> <span class="kr">use</span><span class="p"> </span><span class="n">p1</span><span class="p">;</span>
<span class="k">package </span><span class="nf">p2</span> <span class="kr">is</span><span class="p"></span>
   <span class="k">function </span><span class="nf">to_a2</span> <span class="o">(</span><span class="n">Input</span> <span class="o">:</span> <span class="n">a1</span><span class="o">)</span> <span class="kr">return</span><span class="p"> </span><span class="n">a2</span><span class="p">;</span>
<span class="k">end </span><span class="nf">p2</span><span class="p">;</span>

<span class="kr">with</span><span class="nn"> Unchecked_Conversion;</span>
<span class="k">package body </span><span class="nf">p2</span> <span class="kr">is</span><span class="p"></span>
   <span class="k">function </span><span class="nf">to_a2</span> <span class="o">(</span><span class="n">Input</span> <span class="o">:</span> <span class="n">a1</span><span class="o">)</span> <span class="kr">return</span><span class="p"> </span><span class="n">a2</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">function </span><span class="nf">to_a2u</span> <span class="kr">is</span><span class="p"></span>
        <span class="kr">new</span><span class="p"> </span><span class="n">Unchecked_Conversion</span> <span class="o">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="o">)</span><span class="p">;</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">return</span><span class="p"> </span><span class="n">to_a2u</span> <span class="o">(</span><span class="n">Input</span><span class="o">)</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">to_a2</span><span class="p">;</span>
<span class="k">end </span><span class="nf">p2</span><span class="p">;</span>

<span class="kr">with</span><span class="nn"> p2;</span> <span class="kr">use</span><span class="p"> </span><span class="n">p2</span><span class="p">;</span>
<span class="kr">with</span><span class="nn"> p1;</span> <span class="kr">use</span><span class="p"> </span><span class="n">p1</span><span class="p">;</span>
<span class="kr">with</span><span class="nn"> Text_IO;</span> <span class="kr">use</span><span class="p"> </span><span class="n">Text_IO</span><span class="p">;</span>
<span class="k">procedure </span><span class="nf">m</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">v1</span> <span class="o">:</span> <span class="n">a1</span> <span class="o">:=</span> <span class="kr">new</span><span class="p"> </span><span class="n">int1</span><span class="p">;</span>
   <span class="n">v2</span> <span class="o">:</span> <span class="n">a2</span> <span class="o">:=</span> <span class="n">to_a2</span> <span class="o">(</span><span class="n">v1</span><span class="o">)</span><span class="p">;</span>
<span class="kr">begin</span><span class="p"></span>
   <span class="n">v1.all</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">v2.all</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">put_line</span> <span class="o">(</span><span class="n">int1</span><span class="na">&#39;image</span> <span class="o">(</span><span class="n">v1.all</span><span class="o">))</span><span class="p">;</span>
<span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>This program prints out 0 in <code class="switch docutils literal notranslate"><span class="pre">-O0</span></code> or <code class="switch docutils literal notranslate"><span class="pre">-O1</span></code>
mode, but it prints out 1 in <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code> mode. That’s
because in strict aliasing mode, the compiler can and
does assume that the assignment to <code class="docutils literal notranslate"><span class="pre">v2.all</span></code> could not
affect the value of <code class="docutils literal notranslate"><span class="pre">v1.all</span></code>, since different types
are involved.</p>
<p>This behavior is not a case of non-conformance with the standard, since
the Ada RM specifies that an unchecked conversion where the resulting
bit pattern is not a correct value of the target type can result in an
abnormal value and attempting to reference an abnormal value makes the
execution of a program erroneous.  That’s the case here since the result
does not point to an object of type <code class="docutils literal notranslate"><span class="pre">int2</span></code>.  This means that the
effect is entirely unpredictable.</p>
<p>However, although that explanation may satisfy a language
lawyer, in practice an applications programmer expects an
unchecked conversion involving pointers to create true
aliases and the behavior of printing 1 seems plain wrong.
In this case, the strict aliasing optimization is unwelcome.</p>
<p>Indeed the compiler recognizes this possibility, and the
unchecked conversion generates a warning:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p2</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">possible</span> <span class="n">aliasing</span> <span class="n">problem</span> <span class="k">with</span> <span class="nb">type</span> <span class="s2">&quot;a2&quot;</span>
<span class="n">p2</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span> <span class="n">use</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">strict</span><span class="o">-</span><span class="n">aliasing</span> <span class="n">switch</span> <span class="k">for</span> <span class="n">references</span>
<span class="n">p2</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span> <span class="n">warning</span><span class="p">:</span>  <span class="ow">or</span> <span class="n">use</span> <span class="s2">&quot;pragma No_Strict_Aliasing (a2);&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Unfortunately the problem is recognized when compiling the body of
package <code class="docutils literal notranslate"><span class="pre">p2</span></code>, but the actual “bad” code is generated while
compiling the body of <code class="docutils literal notranslate"><span class="pre">m</span></code> and this latter compilation does not see
the suspicious <code class="docutils literal notranslate"><span class="pre">Unchecked_Conversion</span></code>.</p>
<p>As implied by the warning message, there are approaches you can use to
avoid the unwanted strict aliasing optimization in a case like this.</p>
<p>One possibility is to simply avoid the use of <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code>, but
that is a bit drastic, since it throws away a number of useful
optimizations that do not involve strict aliasing assumptions.</p>
<p>A less drastic approach is to compile the program using the
option <code class="switch docutils literal notranslate"><span class="pre">-fno-strict-aliasing</span></code>. Actually it is only the
unit containing the dereferencing of the suspicious pointer
that needs to be compiled. So in this case, if we compile
unit <code class="docutils literal notranslate"><span class="pre">m</span></code> with this switch, then we get the expected
value of zero printed. Analyzing which units might need
the switch can be painful, so a more reasonable approach
is to compile the entire program with options <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code>
and <code class="switch docutils literal notranslate"><span class="pre">-fno-strict-aliasing</span></code>. If the performance is
satisfactory with this combination of options, then the
advantage is that the entire issue of possible “wrong”
optimization due to strict aliasing is avoided.</p>
<p>To avoid the use of compiler switches, the configuration
pragma <code class="docutils literal notranslate"><span class="pre">No_Strict_Aliasing</span></code> with no parameters may be
used to specify that for all access types, the strict
aliasing optimization should be suppressed.</p>
<p>However, these approaches are still overkill, in that they causes
all manipulations of all access values to be deoptimized. A more
refined approach is to concentrate attention on the specific
access type identified as problematic.</p>
<p>First, if a careful analysis of uses of the pointer shows
that there are no possible problematic references, then
the warning can be suppressed by bracketing the
instantiation of <code class="docutils literal notranslate"><span class="pre">Unchecked_Conversion</span></code> to turn
the warning off:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma</span><span class="p"> </span><span class="n">Warnings</span> <span class="o">(</span><span class="n">Off</span><span class="o">)</span><span class="p">;</span>
<span class="k">function </span><span class="nf">to_a2u</span> <span class="kr">is</span><span class="p"></span>
  <span class="kr">new</span><span class="p"> </span><span class="n">Unchecked_Conversion</span> <span class="o">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="o">)</span><span class="p">;</span>
<span class="kr">pragma</span><span class="p"> </span><span class="n">Warnings</span> <span class="o">(</span><span class="n">On</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Of course that approach is not appropriate for this particular
example, since indeed there is a problematic reference. In this
case we can take one of two other approaches.</p>
<p>The first possibility is to move the instantiation of unchecked
conversion to the unit in which the type is declared. In
this example, we would move the instantiation of
<code class="docutils literal notranslate"><span class="pre">Unchecked_Conversion</span></code> from the body of package
<code class="docutils literal notranslate"><span class="pre">p2</span></code> to the spec of package <code class="docutils literal notranslate"><span class="pre">p1</span></code>. Now the
warning disappears. That’s because any use of the
access type knows there is a suspicious unchecked
conversion, and the strict aliasing optimization
is automatically suppressed for the type.</p>
<p>If it is not practical to move the unchecked conversion to the same unit
in which the destination access type is declared (perhaps because the
source type is not visible in that unit), you may use pragma
<code class="docutils literal notranslate"><span class="pre">No_Strict_Aliasing</span></code> for the type. This pragma must occur in the
same declarative sequence as the declaration of the access type:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">a2</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">int2</span><span class="p">;</span>
<span class="kr">pragma</span><span class="p"> </span><span class="n">No_Strict_Aliasing</span> <span class="o">(</span><span class="n">a2</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Here again, the compiler now knows that the strict aliasing optimization
should be suppressed for any reference to type <code class="docutils literal notranslate"><span class="pre">a2</span></code> and the
expected behavior is obtained.</p>
<p>Finally, note that although the compiler can generate warnings for
simple cases of unchecked conversions, there are tricker and more
indirect ways of creating type incorrect aliases which the compiler
cannot detect. Examples are the use of address overlays and unchecked
conversions involving composite types containing access types as
components. In such cases, no warnings are generated, but there can
still be aliasing problems. One safe coding practice is to forbid the
use of address clauses for type overlaying, and to allow unchecked
conversion only for primitive types. This is not really a significant
restriction since any possible desired effect can be achieved by
unchecked conversion of access values.</p>
<p>The aliasing analysis done in strict aliasing mode can certainly
have significant benefits. We have seen cases of large scale
application code where the time is increased by up to 5% by turning
this optimization off. If you have code that includes significant
usage of unchecked conversion, you might want to just stick with
<code class="switch docutils literal notranslate"><span class="pre">-O1</span></code> and avoid the entire issue. If you get adequate
performance at this level of optimization level, that’s probably
the safest approach. If tests show that you really need higher
levels of optimization, then you can experiment with <code class="switch docutils literal notranslate"><span class="pre">-O2</span></code>
and <code class="switch docutils literal notranslate"><span class="pre">-O2</span> <span class="pre">-fno-strict-aliasing</span></code> to see how much effect this
has on size and speed of the code. If you really need to use
<code class="switch docutils literal notranslate"><span class="pre">-O2</span></code> with strict aliasing in effect, then you should
review any uses of unchecked conversion of access types,
particularly if you are getting the warnings described above.</p>
</div>
<div class="section" id="aliased-variables-and-optimization">
<span id="id37"></span><h4><span class="section-number">6.3.1.10. </span>Aliased Variables and Optimization<a class="headerlink" href="#aliased-variables-and-optimization" title="Permalink to this headline">¶</a></h4>
<p id="index-57">There are scenarios in which programs may
use low level techniques to modify variables
that otherwise might be considered to be unassigned. For example,
a variable can be passed to a procedure by reference, which takes
the address of the parameter and uses the address to modify the
variable’s value, even though it is passed as an IN parameter.
Consider the following example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="k">procedure </span><span class="nf">P</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Max_Length</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Natural</span> <span class="o">:=</span> <span class="mi">16</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">Char_Ptr</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="kr">all</span><span class="p"> </span><span class="n">Character</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">Get_String</span><span class="o">(</span><span class="n">Buffer</span><span class="o">:</span> <span class="n">Char_Ptr</span><span class="p">;</span> <span class="n">Size</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">)</span><span class="p">;</span>
   <span class="kr">pragma</span><span class="p"> </span><span class="n">Import</span> <span class="o">(</span><span class="n">C</span><span class="p">,</span> <span class="n">Get_String</span><span class="p">,</span> <span class="s">&quot;get_string&quot;</span><span class="o">)</span><span class="p">;</span>

   <span class="n">Name</span> <span class="o">:</span> <span class="kr">aliased</span><span class="p"> </span><span class="n">String</span> <span class="o">(</span><span class="mi">1</span> <span class="o">..</span> <span class="n">Max_Length</span><span class="o">)</span> <span class="o">:=</span> <span class="o">(</span><span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span> <span class="sc">&#39; &#39;</span><span class="o">)</span><span class="p">;</span>
   <span class="n">Temp</span> <span class="o">:</span> <span class="n">Char_Ptr</span><span class="p">;</span>

   <span class="k">function </span><span class="nf">Addr</span> <span class="o">(</span><span class="n">S</span> <span class="o">:</span> <span class="n">String</span><span class="o">)</span> <span class="kr">return</span><span class="p"> </span><span class="n">Char_Ptr</span> <span class="kr">is</span><span class="p"></span>
      <span class="k">function </span><span class="nf">To_Char_Ptr</span> <span class="kr">is</span><span class="p"></span>
        <span class="kr">new</span><span class="p"> </span><span class="n">Ada.Unchecked_Conversion</span> <span class="o">(</span><span class="n">System.Address</span><span class="p">,</span> <span class="n">Char_Ptr</span><span class="o">)</span><span class="p">;</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">return</span><span class="p"> </span><span class="n">To_Char_Ptr</span> <span class="o">(</span><span class="n">S</span> <span class="o">(</span><span class="n">S</span><span class="na">&#39;First</span><span class="o">)</span><span class="na">&#39;Address</span><span class="o">)</span><span class="p">;</span>
   <span class="kr">end</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="n">Temp</span> <span class="o">:=</span> <span class="n">Addr</span> <span class="o">(</span><span class="n">Name</span><span class="o">)</span><span class="p">;</span>
   <span class="n">Get_String</span> <span class="o">(</span><span class="n">Temp</span><span class="p">,</span> <span class="n">Max_Length</span><span class="o">)</span><span class="p">;</span>
<span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>where Get_String is a C function that uses the address in Temp to
modify the variable <code class="docutils literal notranslate"><span class="pre">Name</span></code>. This code is dubious, and arguably
erroneous, and the compiler would be entitled to assume that
<code class="docutils literal notranslate"><span class="pre">Name</span></code> is never modified, and generate code accordingly.</p>
<p>However, in practice, this would cause some existing code that
seems to work with no optimization to start failing at high
levels of optimzization.</p>
<p>What the compiler does for such cases is to assume that marking
a variable as aliased indicates that some “funny business” may
be going on. The optimizer recognizes the aliased keyword and
inhibits optimizations that assume the value cannot be assigned.
This means that the above example will in fact “work” reliably,
that is, it will produce the expected results.</p>
</div>
<div class="section" id="atomic-variables-and-optimization">
<span id="id38"></span><h4><span class="section-number">6.3.1.11. </span>Atomic Variables and Optimization<a class="headerlink" href="#atomic-variables-and-optimization" title="Permalink to this headline">¶</a></h4>
<p id="index-58">There are two considerations with regard to performance when
atomic variables are used.</p>
<p>First, the RM only guarantees that access to atomic variables
be atomic, it has nothing to say about how this is achieved,
though there is a strong implication that this should not be
achieved by explicit locking code. Indeed GNAT will never
generate any locking code for atomic variable access (it will
simply reject any attempt to make a variable or type atomic
if the atomic access cannot be achieved without such locking code).</p>
<p>That being said, it is important to understand that you cannot
assume that the entire variable will always be accessed. Consider
this example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">R</span> <span class="kr">is</span><span class="p"> </span><span class="kr">record</span><span class="p"></span>
   <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">D</span> <span class="o">:</span> <span class="n">Character</span><span class="p">;</span>
<span class="k">end record</span><span class="p">;</span>
<span class="kr">for</span><span class="p"> </span><span class="n">R</span><span class="na">&#39;Size</span> <span class="kr">use</span><span class="p"> </span><span class="mi">32</span><span class="p">;</span>
<span class="kr">for</span><span class="p"> </span><span class="n">R</span><span class="na">&#39;Alignment</span> <span class="kr">use</span><span class="p"> </span><span class="mi">4</span><span class="p">;</span>

<span class="n">RV</span> <span class="o">:</span> <span class="n">R</span><span class="p">;</span>
<span class="kr">pragma</span><span class="p"> </span><span class="n">Atomic</span> <span class="o">(</span><span class="n">RV</span><span class="o">)</span><span class="p">;</span>
<span class="n">X</span> <span class="o">:</span> <span class="n">Character</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">X</span> <span class="o">:=</span> <span class="n">RV.B</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>You cannot assume that the reference to <code class="docutils literal notranslate"><span class="pre">RV.B</span></code>
will read the entire 32-bit
variable with a single load instruction. It is perfectly legitimate if
the hardware allows it to do a byte read of just the B field. This read
is still atomic, which is all the RM requires. GNAT can and does take
advantage of this, depending on the architecture and optimization level.
Any assumption to the contrary is non-portable and risky. Even if you
examine the assembly language and see a full 32-bit load, this might
change in a future version of the compiler.</p>
<p>If your application requires that all accesses to <code class="docutils literal notranslate"><span class="pre">RV</span></code> in this
example be full 32-bit loads, you need to make a copy for the access
as in:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">declare</span><span class="p"></span>
   <span class="n">RV_Copy</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">R</span> <span class="o">:=</span> <span class="n">RV</span><span class="p">;</span>
<span class="kr">begin</span><span class="p"></span>
   <span class="n">X</span> <span class="o">:=</span> <span class="n">RV_Copy.B</span><span class="p">;</span>
<span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Now the reference to RV must read the whole variable.
Actually one can imagine some compiler which figures
out that the whole copy is not required (because only
the B field is actually accessed), but GNAT
certainly won’t do that, and we don’t know of any
compiler that would not handle this right, and the
above code will in practice work portably across
all architectures (that permit the Atomic declaration).</p>
<p>The second issue with atomic variables has to do with
the possible requirement of generating synchronization
code. For more details on this, consult the sections on
the pragmas Enable/Disable_Atomic_Synchronization in the
GNAT Reference Manual. If performance is critical, and
such synchronization code is not required, it may be
useful to disable it.</p>
</div>
<div class="section" id="passive-task-optimization">
<span id="id39"></span><h4><span class="section-number">6.3.1.12. </span>Passive Task Optimization<a class="headerlink" href="#passive-task-optimization" title="Permalink to this headline">¶</a></h4>
<p id="index-59">A passive task is one which is sufficiently simple that
in theory a compiler could recognize it an implement it
efficiently without creating a new thread. The original design
of Ada 83 had in mind this kind of passive task optimization, but
only a few Ada 83 compilers attempted it. The problem was that
it was difficult to determine the exact conditions under which
the optimization was possible. The result is a very fragile
optimization where a very minor change in the program can
suddenly silently make a task non-optimizable.</p>
<p>With the revisiting of this issue in Ada 95, there was general
agreement that this approach was fundamentally flawed, and the
notion of protected types was introduced. When using protected
types, the restrictions are well defined, and you KNOW that the
operations will be optimized, and furthermore this optimized
performance is fully portable.</p>
<p>Although it would theoretically be possible for GNAT to attempt to
do this optimization, but it really doesn’t make sense in the
context of Ada 95, and none of the Ada 95 compilers implement
this optimization as far as we know. In particular GNAT never
attempts to perform this optimization.</p>
<p>In any new Ada 95 code that is written, you should always
use protected types in place of tasks that might be able to
be optimized in this manner.
Of course this does not help if you have legacy Ada 83 code
that depends on this optimization, but it is unusual to encounter
a case where the performance gains from this optimization
are significant.</p>
<p>Your program should work correctly without this optimization. If
you have performance problems, then the most practical
approach is to figure out exactly where these performance problems
arise, and update those particular tasks to be protected types. Note
that typically clients of the tasks who call entries, will not have
to be modified, only the task definition itself.</p>
</div>
</div>
<div class="section" id="text-io-suggestions">
<span id="id40"></span><h3><span class="section-number">6.3.2. </span><code class="docutils literal notranslate"><span class="pre">Text_IO</span></code> Suggestions<a class="headerlink" href="#text-io-suggestions" title="Permalink to this headline">¶</a></h3>
<p id="index-60">The <code class="docutils literal notranslate"><span class="pre">Ada.Text_IO</span></code> package has fairly high overheads due in part to
the requirement of maintaining page and line counts. If performance
is critical, a recommendation is to use <code class="docutils literal notranslate"><span class="pre">Stream_IO</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">Text_IO</span></code> for volume output, since this package has less overhead.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">Text_IO</span></code> must be used, note that by default output to the standard
output and standard error files is unbuffered (this provides better
behavior when output statements are used for debugging, or if the
progress of a program is observed by tracking the output, e.g. by
using the Unix <em>tail -f</em> command to watch redirected output.</p>
<p>If you are generating large volumes of output with <code class="docutils literal notranslate"><span class="pre">Text_IO</span></code> and
performance is an important factor, use a designated file instead
of the standard output file, or change the standard output file to
be buffered using <code class="docutils literal notranslate"><span class="pre">Interfaces.C_Streams.setvbuf</span></code>.</p>
</div>
<div class="section" id="reducing-size-of-executables-with-unused-subprogram-data-elimination">
<span id="id41"></span><h3><span class="section-number">6.3.3. </span>Reducing Size of Executables with Unused Subprogram/Data Elimination<a class="headerlink" href="#reducing-size-of-executables-with-unused-subprogram-data-elimination" title="Permalink to this headline">¶</a></h3>
<p id="index-61">This section describes how you can eliminate unused subprograms and data from
your executable just by setting options at compilation time.</p>
<div class="section" id="about-unused-subprogram-data-elimination">
<span id="id42"></span><h4><span class="section-number">6.3.3.1. </span>About unused subprogram/data elimination<a class="headerlink" href="#about-unused-subprogram-data-elimination" title="Permalink to this headline">¶</a></h4>
<p>By default, an executable contains all code and data of its composing objects
(directly linked or coming from statically linked libraries), even data or code
never used by this executable.</p>
<p>This feature will allow you to eliminate such unused code from your
executable, making it smaller (in disk and in memory).</p>
<p>This functionality is available on all Linux platforms except for the IA-64
architecture and on all cross platforms using the ELF binary file format.
In both cases GNU binutils version 2.16 or later are required to enable it.</p>
</div>
<div class="section" id="compilation-options">
<span id="id43"></span><h4><span class="section-number">6.3.3.2. </span>Compilation options<a class="headerlink" href="#compilation-options" title="Permalink to this headline">¶</a></h4>
<p>The operation of eliminating the unused code and data from the final executable
is directly performed by the linker.</p>
<span class="target" id="index-62"></span><p id="index-63">In order to do this, it has to work with objects compiled with the
following options:
<code class="switch docutils literal notranslate"><span class="pre">-ffunction-sections</span></code> <code class="switch docutils literal notranslate"><span class="pre">-fdata-sections</span></code>.</p>
<p>These options are usable with C and Ada files.
They will place respectively each
function or data in a separate section in the resulting object file.</p>
<p>Once the objects and static libraries are created with these options, the
linker can perform the dead code elimination. You can do this by setting
the <code class="switch docutils literal notranslate"><span class="pre">-Wl,--gc-sections</span></code> option to gcc command or in the
<code class="switch docutils literal notranslate"><span class="pre">-largs</span></code> section of <code class="docutils literal notranslate"><span class="pre">gnatmake</span></code>. This will perform a
garbage collection of code and data never referenced.</p>
<p>If the linker performs a partial link (<code class="switch docutils literal notranslate"><span class="pre">-r</span></code> linker option), then you
will need to provide the entry point using the <code class="switch docutils literal notranslate"><span class="pre">-e</span></code> / <code class="switch docutils literal notranslate"><span class="pre">--entry</span></code>
linker option.</p>
<p>Note that objects compiled without the <code class="switch docutils literal notranslate"><span class="pre">-ffunction-sections</span></code> and
<code class="switch docutils literal notranslate"><span class="pre">-fdata-sections</span></code> options can still be linked with the executable.
However, no dead code elimination will be performed on those objects (they will
be linked as is).</p>
<p>The GNAT static library is now compiled with -ffunction-sections and
-fdata-sections on some platforms. This allows you to eliminate the unused code
and data of the GNAT library from your executable.</p>
</div>
<div class="section" id="example-of-unused-subprogram-data-elimination">
<span id="id44"></span><h4><span class="section-number">6.3.3.3. </span>Example of unused subprogram/data elimination<a class="headerlink" href="#example-of-unused-subprogram-data-elimination" title="Permalink to this headline">¶</a></h4>
<p>Here is a simple example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">Aux</span><span class="p">;</span>

<span class="k">procedure </span><span class="nf">Test</span> <span class="kr">is</span><span class="p"></span>
<span class="kr">begin</span><span class="p"></span>
   <span class="n">Aux.Used</span> <span class="o">(</span><span class="mi">10</span><span class="o">)</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Test</span><span class="p">;</span>

<span class="k">package </span><span class="nf">Aux</span> <span class="kr">is</span><span class="p"></span>
   <span class="n">Used_Data</span>   <span class="o">:</span> <span class="n">Integer</span><span class="p">;</span>
   <span class="n">Unused_Data</span> <span class="o">:</span> <span class="n">Integer</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">Used</span>   <span class="o">(</span><span class="n">Data</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">)</span><span class="p">;</span>
   <span class="k">procedure </span><span class="nf">Unused</span> <span class="o">(</span><span class="n">Data</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">)</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Aux</span><span class="p">;</span>

<span class="k">package body </span><span class="nf">Aux</span> <span class="kr">is</span><span class="p"></span>
   <span class="k">procedure </span><span class="nf">Used</span> <span class="o">(</span><span class="n">Data</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">)</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Used_Data</span> <span class="o">:=</span> <span class="n">Data</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Used</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">Unused</span> <span class="o">(</span><span class="n">Data</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">)</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Unused_Data</span> <span class="o">:=</span> <span class="n">Data</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Unused</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Aux</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">Unused</span></code> and <code class="docutils literal notranslate"><span class="pre">Unused_Data</span></code> are never referenced in this code
excerpt, and hence they may be safely removed from the final executable.</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmake test

$ nm test | grep used
020015f0 T aux__unused
02005d88 B aux__unused_data
020015cc T aux__used
02005d84 B aux__used_data

$ gnatmake test -cargs -fdata-sections -ffunction-sections \\
     -largs -Wl,--gc-sections

$ nm test | grep used
02005350 T aux__used
0201ffe0 B aux__used_data
</pre></div>
</div>
</div></blockquote>
<p>It can be observed that the procedure <code class="docutils literal notranslate"><span class="pre">Unused</span></code> and the object
<code class="docutils literal notranslate"><span class="pre">Unused_Data</span></code> are removed by the linker when using the
appropriate options.</p>
<span class="target" id="index-64"></span></div>
</div>
</div>
<div class="section" id="overflow-check-handling-in-gnat">
<span id="index-65"></span><span id="id45"></span><h2><span class="section-number">6.4. </span>Overflow Check Handling in GNAT<a class="headerlink" href="#overflow-check-handling-in-gnat" title="Permalink to this headline">¶</a></h2>
<p>This section explains how to control the handling of overflow checks.</p>
<div class="section" id="background">
<span id="id46"></span><h3><span class="section-number">6.4.1. </span>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h3>
<p>Overflow checks are checks that the compiler may make to ensure
that intermediate results are not out of range. For example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">:</span> <span class="n">Integer</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">A</span> <span class="o">:=</span> <span class="n">A</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>If <code class="docutils literal notranslate"><span class="pre">A</span></code> has the value <code class="docutils literal notranslate"><span class="pre">Integer'Last</span></code>, then the addition may cause
overflow since the result is out of range of the type <code class="docutils literal notranslate"><span class="pre">Integer</span></code>.
In this case <code class="docutils literal notranslate"><span class="pre">Constraint_Error</span></code> will be raised if checks are
enabled.</p>
<p>A trickier situation arises in examples like the following:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">A</span><span class="p">,</span> <span class="n">C</span> <span class="o">:</span> <span class="n">Integer</span><span class="p">;</span>
<span class="o">...</span>
<span class="n">A</span> <span class="o">:=</span> <span class="o">(</span><span class="n">A</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">C</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>where <code class="docutils literal notranslate"><span class="pre">A</span></code> is <code class="docutils literal notranslate"><span class="pre">Integer'Last</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span></code> is <code class="docutils literal notranslate"><span class="pre">-1</span></code>.
Now the final result of the expression on the right hand side is
<code class="docutils literal notranslate"><span class="pre">Integer'Last</span></code> which is in range, but the question arises whether the
intermediate addition of <code class="docutils literal notranslate"><span class="pre">(A</span> <span class="pre">+</span> <span class="pre">1)</span></code> raises an overflow error.</p>
<p>The (perhaps surprising) answer is that the Ada language
definition does not answer this question. Instead it leaves
it up to the implementation to do one of two things if overflow
checks are enabled.</p>
<ul class="simple">
<li><p>raise an exception (<code class="docutils literal notranslate"><span class="pre">Constraint_Error</span></code>), or</p></li>
<li><p>yield the correct mathematical result which is then used in
subsequent operations.</p></li>
</ul>
<p>If the compiler chooses the first approach, then the assignment of this
example will indeed raise <code class="docutils literal notranslate"><span class="pre">Constraint_Error</span></code> if overflow checking is
enabled, or result in erroneous execution if overflow checks are suppressed.</p>
<p>But if the compiler
chooses the second approach, then it can perform both additions yielding
the correct mathematical result, which is in range, so no exception
will be raised, and the right result is obtained, regardless of whether
overflow checks are suppressed.</p>
<p>Note that in the first example an
exception will be raised in either case, since if the compiler
gives the correct mathematical result for the addition, it will
be out of range of the target type of the assignment, and thus
fails the range check.</p>
<p>This lack of specified behavior in the handling of overflow for
intermediate results is a source of non-portability, and can thus
be problematic when programs are ported. Most typically this arises
in a situation where the original compiler did not raise an exception,
and then the application is moved to a compiler where the check is
performed on the intermediate result and an unexpected exception is
raised.</p>
<p>Furthermore, when using Ada 2012’s preconditions and other
assertion forms, another issue arises. Consider:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="k">procedure </span><span class="nf">P</span> <span class="o">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">)</span> <span class="kr">with</span><span class="p"></span>
  <span class="n">Pre</span> <span class="o">=&gt;</span> <span class="n">A</span> <span class="o">+</span> <span class="n">B</span> <span class="o">&lt;=</span> <span class="n">Integer</span><span class="na">&#39;Last</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>One often wants to regard arithmetic in a context like this from
a mathematical point of view. So for example, if the two actual parameters
for a call to <code class="docutils literal notranslate"><span class="pre">P</span></code> are both <code class="docutils literal notranslate"><span class="pre">Integer'Last</span></code>, then
the precondition should be regarded as False. If we are executing
in a mode with run-time checks enabled for preconditions, then we would
like this precondition to fail, rather than raising an exception
because of the intermediate overflow.</p>
<p>However, the language definition leaves the specification of
whether the above condition fails (raising <code class="docutils literal notranslate"><span class="pre">Assert_Error</span></code>) or
causes an intermediate overflow (raising <code class="docutils literal notranslate"><span class="pre">Constraint_Error</span></code>)
up to the implementation.</p>
<p>The situation is worse in a case such as the following:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="k">procedure </span><span class="nf">Q</span> <span class="o">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">)</span> <span class="kr">with</span><span class="p"></span>
  <span class="n">Pre</span> <span class="o">=&gt;</span> <span class="n">A</span> <span class="o">+</span> <span class="n">B</span> <span class="o">+</span> <span class="n">C</span> <span class="o">&lt;=</span> <span class="n">Integer</span><span class="na">&#39;Last</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Consider the call</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">Q</span> <span class="o">(</span><span class="n">A</span> <span class="o">=&gt;</span> <span class="n">Integer</span><span class="na">&#39;Last</span><span class="p">,</span> <span class="n">B</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">C</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>From a mathematical point of view the precondition
is True, but at run time we may (but are not guaranteed to) get an
exception raised because of the intermediate overflow (and we really
would prefer this precondition to be considered True at run time).</p>
</div>
<div class="section" id="management-of-overflows-in-gnat">
<span id="id47"></span><h3><span class="section-number">6.4.2. </span>Management of Overflows in GNAT<a class="headerlink" href="#management-of-overflows-in-gnat" title="Permalink to this headline">¶</a></h3>
<p>To deal with the portability issue, and with the problem of
mathematical versus run-time interpretation of the expressions in
assertions, GNAT provides comprehensive control over the handling
of intermediate overflow. GNAT can operate in three modes, and
furthemore, permits separate selection of operating modes for
the expressions within assertions (here the term ‘assertions’
is used in the technical sense, which includes preconditions and so forth)
and for expressions appearing outside assertions.</p>
<p>The three modes are:</p>
<ul>
<li><p><em>Use base type for intermediate operations</em> (<code class="docutils literal notranslate"><span class="pre">STRICT</span></code>)</p>
<p>In this mode, all intermediate results for predefined arithmetic
operators are computed using the base type, and the result must
be in range of the base type. If this is not the
case then either an exception is raised (if overflow checks are
enabled) or the execution is erroneous (if overflow checks are suppressed).
This is the normal default mode.</p>
</li>
<li><p><em>Most intermediate overflows avoided</em> (<code class="docutils literal notranslate"><span class="pre">MINIMIZED</span></code>)</p>
<p>In this mode, the compiler attempts to avoid intermediate overflows by
using a larger integer type, typically <code class="docutils literal notranslate"><span class="pre">Long_Long_Integer</span></code>,
as the type in which arithmetic is
performed for predefined arithmetic operators. This may be slightly more
expensive at
run time (compared to suppressing intermediate overflow checks), though
the cost is negligible on modern 64-bit machines. For the examples given
earlier, no intermediate overflows would have resulted in exceptions,
since the intermediate results are all in the range of
<code class="docutils literal notranslate"><span class="pre">Long_Long_Integer</span></code> (typically 64-bits on nearly all implementations
of GNAT). In addition, if checks are enabled, this reduces the number of
checks that must be made, so this choice may actually result in an
improvement in space and time behavior.</p>
<p>However, there are cases where <code class="docutils literal notranslate"><span class="pre">Long_Long_Integer</span></code> is not large
enough, consider the following example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="k">procedure </span><span class="nf">R</span> <span class="o">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span> <span class="o">:</span> <span class="n">Integer</span><span class="o">)</span> <span class="kr">with</span><span class="p"></span>
  <span class="n">Pre</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">A</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">B</span><span class="o">**</span><span class="mi">2</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="n">C</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">D</span><span class="o">**</span><span class="mi">2</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>where <code class="docutils literal notranslate"><span class="pre">A</span></code> = <code class="docutils literal notranslate"><span class="pre">B</span></code> = <code class="docutils literal notranslate"><span class="pre">C</span></code> = <code class="docutils literal notranslate"><span class="pre">D</span></code> = <code class="docutils literal notranslate"><span class="pre">Integer'Last</span></code>.
Now the intermediate results are
out of the range of <code class="docutils literal notranslate"><span class="pre">Long_Long_Integer</span></code> even though the final result
is in range and the precondition is True (from a mathematical point
of view). In such a case, operating in this mode, an overflow occurs
for the intermediate computation (which is why this mode
says <em>most</em> intermediate overflows are avoided). In this case,
an exception is raised if overflow checks are enabled, and the
execution is erroneous if overflow checks are suppressed.</p>
</li>
<li><p><em>All intermediate overflows avoided</em> (<code class="docutils literal notranslate"><span class="pre">ELIMINATED</span></code>)</p>
<p>In this mode, the compiler  avoids all intermediate overflows
by using arbitrary precision arithmetic as required. In this
mode, the above example with <code class="docutils literal notranslate"><span class="pre">A**2</span> <span class="pre">*</span> <span class="pre">B**2</span></code> would
not cause intermediate overflow, because the intermediate result
would be evaluated using sufficient precision, and the result
of evaluating the precondition would be True.</p>
<p>This mode has the advantage of avoiding any intermediate
overflows, but at the expense of significant run-time overhead,
including the use of a library (included automatically in this
mode) for multiple-precision arithmetic.</p>
<p>This mode provides cleaner semantics for assertions, since now
the run-time behavior emulates true arithmetic behavior for the
predefined arithmetic operators, meaning that there is never a
conflict between the mathematical view of the assertion, and its
run-time behavior.</p>
<p>Note that in this mode, the behavior is unaffected by whether or
not overflow checks are suppressed, since overflow does not occur.
It is possible for gigantic intermediate expressions to raise
<code class="docutils literal notranslate"><span class="pre">Storage_Error</span></code> as a result of attempting to compute the
results of such expressions (e.g. <code class="docutils literal notranslate"><span class="pre">Integer'Last</span> <span class="pre">**</span> <span class="pre">Integer'Last</span></code>)
but overflow is impossible.</p>
</li>
</ul>
<p>Note that these modes apply only to the evaluation of predefined
arithmetic, membership, and comparison operators for signed integer
arithmetic.</p>
<p>For fixed-point arithmetic, checks can be suppressed. But if checks
are enabled
then fixed-point values are always checked for overflow against the
base type for intermediate expressions (that is such checks always
operate in the equivalent of <code class="docutils literal notranslate"><span class="pre">STRICT</span></code> mode).</p>
<p>For floating-point, on nearly all architectures, <code class="docutils literal notranslate"><span class="pre">Machine_Overflows</span></code>
is False, and IEEE infinities are generated, so overflow exceptions
are never raised. If you want to avoid infinities, and check that
final results of expressions are in range, then you can declare a
constrained floating-point type, and range checks will be carried
out in the normal manner (with infinite values always failing all
range checks).</p>
</div>
<div class="section" id="specifying-the-desired-mode">
<span id="id48"></span><h3><span class="section-number">6.4.3. </span>Specifying the Desired Mode<a class="headerlink" href="#specifying-the-desired-mode" title="Permalink to this headline">¶</a></h3>
<p id="index-66">The desired mode of for handling intermediate overflow can be specified using
either the <code class="docutils literal notranslate"><span class="pre">Overflow_Mode</span></code> pragma or an equivalent compiler switch.
The pragma has the form</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma</span><span class="p"> </span><span class="n">Overflow_Mode</span> <span class="o">(</span>[<span class="n">General</span> <span class="o">=&gt;</span>] <span class="n">MODE</span> [<span class="p">,</span> [<span class="n">Assertions</span> <span class="o">=&gt;</span>] <span class="n">MODE</span>]<span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>where <code class="docutils literal notranslate"><span class="pre">MODE</span></code> is one of</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">STRICT</span></code>:  intermediate overflows checked (using base type)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MINIMIZED</span></code>: minimize intermediate overflows</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ELIMINATED</span></code>: eliminate intermediate overflows</p></li>
</ul>
<p>The case is ignored, so <code class="docutils literal notranslate"><span class="pre">MINIMIZED</span></code>, <code class="docutils literal notranslate"><span class="pre">Minimized</span></code> and
<code class="docutils literal notranslate"><span class="pre">minimized</span></code> all have the same effect.</p>
<p>If only the <code class="docutils literal notranslate"><span class="pre">General</span></code> parameter is present, then the given <code class="docutils literal notranslate"><span class="pre">MODE</span></code> applies
to expressions both within and outside assertions. If both arguments
are present, then <code class="docutils literal notranslate"><span class="pre">General</span></code> applies to expressions outside assertions,
and <code class="docutils literal notranslate"><span class="pre">Assertions</span></code> applies to expressions within assertions. For example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">pragma</span><span class="p"> </span><span class="n">Overflow_Mode</span>
  <span class="o">(</span><span class="n">General</span> <span class="o">=&gt;</span> <span class="n">Minimized</span><span class="p">,</span> <span class="n">Assertions</span> <span class="o">=&gt;</span> <span class="n">Eliminated</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>specifies that general expressions outside assertions be evaluated
in ‘minimize intermediate overflows’ mode, and expressions within
assertions be evaluated in ‘eliminate intermediate overflows’ mode.
This is often a reasonable choice, avoiding excessive overhead
outside assertions, but assuring a high degree of portability
when importing code from another compiler, while incurring
the extra overhead for assertion expressions to ensure that
the behavior at run time matches the expected mathematical
behavior.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Overflow_Mode</span></code> pragma has the same scoping and placement
rules as pragma <code class="docutils literal notranslate"><span class="pre">Suppress</span></code>, so it can occur either as a
configuration pragma, specifying a default for the whole
program, or in a declarative scope, where it applies to the
remaining declarations and statements in that scope.</p>
<p>Note that pragma <code class="docutils literal notranslate"><span class="pre">Overflow_Mode</span></code> does not affect whether
overflow checks are enabled or suppressed. It only controls the
method used to compute intermediate values. To control whether
overflow checking is enabled or suppressed, use pragma <code class="docutils literal notranslate"><span class="pre">Suppress</span></code>
or <code class="docutils literal notranslate"><span class="pre">Unsuppress</span></code> in the usual manner.</p>
<span class="target" id="index-67"></span><p id="index-68">Additionally, a compiler switch <code class="switch docutils literal notranslate"><span class="pre">-gnato?</span></code> or <code class="switch docutils literal notranslate"><span class="pre">-gnato??</span></code>
can be used to control the checking mode default (which can be subsequently
overridden using pragmas).</p>
<p>Here <code class="docutils literal notranslate"><span class="pre">?</span></code> is one of the digits <code class="docutils literal notranslate"><span class="pre">1</span></code> through <code class="docutils literal notranslate"><span class="pre">3</span></code>:</p>
<blockquote>
<div><table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td><p>use base type for intermediate operations (<code class="docutils literal notranslate"><span class="pre">STRICT</span></code>)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">2</span></code></p></td>
<td><p>minimize intermediate overflows (<code class="docutils literal notranslate"><span class="pre">MINIMIZED</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">3</span></code></p></td>
<td><p>eliminate intermediate overflows (<code class="docutils literal notranslate"><span class="pre">ELIMINATED</span></code>)</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>As with the pragma, if only one digit appears then it applies to all
cases; if two digits are given, then the first applies outside
assertions, and the second within assertions. Thus the equivalent
of the example pragma above would be
<code class="switch docutils literal notranslate"><span class="pre">-gnato23</span></code>.</p>
<p>If no digits follow the <code class="switch docutils literal notranslate"><span class="pre">-gnato</span></code>, then it is equivalent to
<code class="switch docutils literal notranslate"><span class="pre">-gnato11</span></code>,
causing all intermediate operations to be computed using the base
type (<code class="docutils literal notranslate"><span class="pre">STRICT</span></code> mode).</p>
</div>
<div class="section" id="default-settings">
<span id="id49"></span><h3><span class="section-number">6.4.4. </span>Default Settings<a class="headerlink" href="#default-settings" title="Permalink to this headline">¶</a></h3>
<p>The default mode for overflow checks is</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">General</span> <span class="o">=&gt;</span> <span class="n">Strict</span>
</pre></div>
</div>
</div></blockquote>
<p>which causes all computations both inside and outside assertions to use
the base type.</p>
<p>This retains compatibility with previous versions of
GNAT which suppressed overflow checks by default and always
used the base type for computation of intermediate results.</p>
<p>The <span class="target" id="index-69"></span>switch <code class="switch docutils literal notranslate"><span class="pre">-gnato</span></code> (with no digits following)
is equivalent to</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">General</span> <span class="o">=&gt;</span> <span class="n">Strict</span>
</pre></div>
</div>
</div></blockquote>
<p>which causes overflow checking of all intermediate overflows
both inside and outside assertions against the base type.</p>
<p>The pragma <code class="docutils literal notranslate"><span class="pre">Suppress</span> <span class="pre">(Overflow_Check)</span></code> disables overflow
checking, but it has no effect on the method used for computing
intermediate results.</p>
<p>The pragma <code class="docutils literal notranslate"><span class="pre">Unsuppress</span> <span class="pre">(Overflow_Check)</span></code> enables overflow
checking, but it has no effect on the method used for computing
intermediate results.</p>
</div>
<div class="section" id="implementation-notes">
<span id="id50"></span><h3><span class="section-number">6.4.5. </span>Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permalink to this headline">¶</a></h3>
<p>In practice on typical 64-bit machines, the <code class="docutils literal notranslate"><span class="pre">MINIMIZED</span></code> mode is
reasonably efficient, and can be generally used. It also helps
to ensure compatibility with code imported from some other
compiler to GNAT.</p>
<p>Setting all intermediate overflows checking (<code class="docutils literal notranslate"><span class="pre">CHECKED</span></code> mode)
makes sense if you want to
make sure that your code is compatible with any other possible
Ada implementation. This may be useful in ensuring portability
for code that is to be exported to some other compiler than GNAT.</p>
<p>The Ada standard allows the reassociation of expressions at
the same precedence level if no parentheses are present. For
example, <code class="docutils literal notranslate"><span class="pre">A+B+C</span></code> parses as though it were <code class="docutils literal notranslate"><span class="pre">(A+B)+C</span></code>, but
the compiler can reintepret this as <code class="docutils literal notranslate"><span class="pre">A+(B+C)</span></code>, possibly
introducing or eliminating an overflow exception. The GNAT
compiler never takes advantage of this freedom, and the
expression <code class="docutils literal notranslate"><span class="pre">A+B+C</span></code> will be evaluated as <code class="docutils literal notranslate"><span class="pre">(A+B)+C</span></code>.
If you need the other order, you can write the parentheses
explicitly <code class="docutils literal notranslate"><span class="pre">A+(B+C)</span></code> and GNAT will respect this order.</p>
<p>The use of <code class="docutils literal notranslate"><span class="pre">ELIMINATED</span></code> mode will cause the compiler to
automatically include an appropriate arbitrary precision
integer arithmetic package. The compiler will make calls
to this package, though only in cases where it cannot be
sure that <code class="docutils literal notranslate"><span class="pre">Long_Long_Integer</span></code> is sufficient to guard against
intermediate overflows. This package does not use dynamic
allocation, but it does use the secondary stack, so an
appropriate secondary stack package must be present (this
is always true for standard full Ada, but may require
specific steps for restricted run times such as ZFP).</p>
<p>Although <code class="docutils literal notranslate"><span class="pre">ELIMINATED</span></code> mode causes expressions to use arbitrary
precision arithmetic, avoiding overflow, the final result
must be in an appropriate range. This is true even if the
final result is of type <code class="docutils literal notranslate"><span class="pre">[Long_[Long_]]Integer'Base</span></code>, which
still has the same bounds as its associated constrained
type at run-time.</p>
<p>Currently, the <code class="docutils literal notranslate"><span class="pre">ELIMINATED</span></code> mode is only available on target
platforms for which <code class="docutils literal notranslate"><span class="pre">Long_Long_Integer</span></code> is 64-bits (nearly all GNAT
platforms).</p>
</div>
</div>
<div class="section" id="performing-dimensionality-analysis-in-gnat">
<span id="id51"></span><h2><span class="section-number">6.5. </span>Performing Dimensionality Analysis in GNAT<a class="headerlink" href="#performing-dimensionality-analysis-in-gnat" title="Permalink to this headline">¶</a></h2>
<p id="index-70">The GNAT compiler supports dimensionality checking. The user can
specify physical units for objects, and the compiler will verify that uses
of these objects are compatible with their dimensions, in a fashion that is
familiar to engineering practice. The dimensions of algebraic expressions
(including powers with static exponents) are computed from their constituents.</p>
<span class="target" id="index-71"></span><p id="index-72">This feature depends on Ada 2012 aspect specifications, and is available from
version 7.0.1 of GNAT onwards.
The GNAT-specific aspect <code class="docutils literal notranslate"><span class="pre">Dimension_System</span></code>
allows you to define a system of units; the aspect <code class="docutils literal notranslate"><span class="pre">Dimension</span></code>
then allows the user to declare dimensioned quantities within a given system.
(These aspects are described in the <em>Implementation Defined Aspects</em>
chapter of the <em>GNAT Reference Manual</em>).</p>
<p>The major advantage of this model is that it does not require the declaration of
multiple operators for all possible combinations of types: it is only necessary
to use the proper subtypes in object declarations.</p>
<span class="target" id="index-73"></span><p id="index-74">The simplest way to impose dimensionality checking on a computation is to make
use of one of the instantiations of the package <code class="docutils literal notranslate"><span class="pre">System.Dim.Generic_Mks</span></code>, which
are part of the GNAT library. This generic package defines a floating-point
type <code class="docutils literal notranslate"><span class="pre">MKS_Type</span></code>, for which a sequence of dimension names are specified,
together with their conventional abbreviations.  The following should be read
together with the full specification of the package, in file
<code class="file docutils literal notranslate"><span class="pre">s-digemk.ads</span></code>.</p>
<blockquote>
<div><div class="highlight-ada notranslate" id="index-75"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">Mks_Type</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">Float_Type</span>
  <span class="kr">with</span><span class="p"></span>
   <span class="n">Dimension_System</span> <span class="o">=&gt;</span> <span class="o">(</span>
     <span class="o">(</span><span class="n">Unit_Name</span> <span class="o">=&gt;</span> <span class="n">Meter</span><span class="p">,</span>    <span class="n">Unit_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;m&#39;</span><span class="p">,</span>   <span class="n">Dim_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;L&#39;</span><span class="o">)</span><span class="p">,</span>
     <span class="o">(</span><span class="n">Unit_Name</span> <span class="o">=&gt;</span> <span class="n">Kilogram</span><span class="p">,</span> <span class="n">Unit_Symbol</span> <span class="o">=&gt;</span> <span class="s">&quot;kg&quot;</span><span class="p">,</span>  <span class="n">Dim_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;M&#39;</span><span class="o">)</span><span class="p">,</span>
     <span class="o">(</span><span class="n">Unit_Name</span> <span class="o">=&gt;</span> <span class="n">Second</span><span class="p">,</span>   <span class="n">Unit_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;s&#39;</span><span class="p">,</span>   <span class="n">Dim_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;T&#39;</span><span class="o">)</span><span class="p">,</span>
     <span class="o">(</span><span class="n">Unit_Name</span> <span class="o">=&gt;</span> <span class="n">Ampere</span><span class="p">,</span>   <span class="n">Unit_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span>   <span class="n">Dim_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;I&#39;</span><span class="o">)</span><span class="p">,</span>
     <span class="o">(</span><span class="n">Unit_Name</span> <span class="o">=&gt;</span> <span class="n">Kelvin</span><span class="p">,</span>   <span class="n">Unit_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;K&#39;</span><span class="p">,</span>   <span class="n">Dim_Symbol</span> <span class="o">=&gt;</span> <span class="s">&quot;Theta&quot;</span><span class="o">)</span><span class="p">,</span>
     <span class="o">(</span><span class="n">Unit_Name</span> <span class="o">=&gt;</span> <span class="n">Mole</span><span class="p">,</span>     <span class="n">Unit_Symbol</span> <span class="o">=&gt;</span> <span class="s">&quot;mol&quot;</span><span class="p">,</span> <span class="n">Dim_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;N&#39;</span><span class="o">)</span><span class="p">,</span>
     <span class="o">(</span><span class="n">Unit_Name</span> <span class="o">=&gt;</span> <span class="n">Candela</span><span class="p">,</span>  <span class="n">Unit_Symbol</span> <span class="o">=&gt;</span> <span class="s">&quot;cd&quot;</span><span class="p">,</span>  <span class="n">Dim_Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;J&#39;</span><span class="o">))</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>The package then defines a series of subtypes that correspond to these
conventional units. For example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">subtype</span><span class="p"> </span><span class="n">Length</span> <span class="kr">is</span><span class="p"> </span><span class="n">Mks_Type</span>
  <span class="kr">with</span><span class="p"></span>
   <span class="n">Dimension</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">Symbol</span> <span class="o">=&gt;</span> <span class="sc">&#39;m&#39;</span><span class="p">,</span> <span class="n">Meter</span>  <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span> <span class="mi">0</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>and similarly for <code class="docutils literal notranslate"><span class="pre">Mass</span></code>, <code class="docutils literal notranslate"><span class="pre">Time</span></code>, <code class="docutils literal notranslate"><span class="pre">Electric_Current</span></code>,
<code class="docutils literal notranslate"><span class="pre">Thermodynamic_Temperature</span></code>, <code class="docutils literal notranslate"><span class="pre">Amount_Of_Substance</span></code>, and
<code class="docutils literal notranslate"><span class="pre">Luminous_Intensity</span></code> (the standard set of units of the SI system).</p>
<p>The package also defines conventional names for values of each unit, for
example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">m</span>   <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Length</span>           <span class="o">:=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>
<span class="n">kg</span>  <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Mass</span>             <span class="o">:=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>
<span class="n">s</span>   <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Time</span>             <span class="o">:=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>
<span class="n">A</span>   <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Electric_Current</span> <span class="o">:=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>as well as useful multiples of these units:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span> <span class="n">cm</span>  <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Length</span> <span class="o">:=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0E-02</span><span class="p">;</span>
 <span class="n">g</span>   <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Mass</span>   <span class="o">:=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0E-03</span><span class="p">;</span>
 <span class="n">min</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Time</span>   <span class="o">:=</span> <span class="mi">60</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>
 <span class="n">day</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">Time</span>   <span class="o">:=</span> <span class="mi">60</span><span class="o">.</span><span class="mi">0</span> <span class="o">*</span> <span class="mi">24</span><span class="o">.</span><span class="mi">0</span> <span class="o">*</span> <span class="n">min</span><span class="p">;</span>
<span class="o">...</span>
</pre></div>
</div>
</div></blockquote>
<p>There are three instantiations of <code class="docutils literal notranslate"><span class="pre">System.Dim.Generic_Mks</span></code> defined in the
GNAT library:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">System.Dim.Float_Mks</span></code> based on <code class="docutils literal notranslate"><span class="pre">Float</span></code> defined in <code class="file docutils literal notranslate"><span class="pre">s-diflmk.ads</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">System.Dim.Long_Mks</span></code> based on <code class="docutils literal notranslate"><span class="pre">Long_Float</span></code> defined in <code class="file docutils literal notranslate"><span class="pre">s-dilomk.ads</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">System.Dim.Mks</span></code> based on <code class="docutils literal notranslate"><span class="pre">Long_Long_Float</span></code> defined in <code class="file docutils literal notranslate"><span class="pre">s-dimmks.ads</span></code>.</p></li>
</ul>
<p>Using one of these packages, you can then define a derived unit by providing
the aspect that specifies its dimensions within the MKS system, as well as the
string to be used for output of a value of that unit:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">subtype</span><span class="p"> </span><span class="n">Acceleration</span> <span class="kr">is</span><span class="p"> </span><span class="n">Mks_Type</span>
  <span class="kr">with</span><span class="p"> </span><span class="n">Dimension</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="s">&quot;m/sec^2&quot;</span><span class="p">,</span>
                     <span class="n">Meter</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="n">Second</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                     <span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span> <span class="mi">0</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Here is a complete example of use:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">System.Dim.MKS</span><span class="p">; </span><span class="kr">use</span><span class="nn"> System.Dim.Mks;</span><span class="p"></span>
<span class="kr">with</span><span class="nn"> System.Dim.Mks_IO;</span> <span class="kr">use</span><span class="p"> </span><span class="n">System.Dim.Mks_IO</span><span class="p">;</span>
<span class="kr">with</span><span class="nn"> Text_IO;</span> <span class="kr">use</span><span class="p"> </span><span class="n">Text_IO</span><span class="p">;</span>
<span class="k">procedure </span><span class="nf">Free_Fall</span> <span class="kr">is</span><span class="p"></span>
  <span class="kr">subtype</span><span class="p"> </span><span class="n">Acceleration</span> <span class="kr">is</span><span class="p"> </span><span class="n">Mks_Type</span>
    <span class="kr">with</span><span class="p"> </span><span class="n">Dimension</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="s">&quot;m/sec^2&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span> <span class="mi">0</span><span class="o">)</span><span class="p">;</span>
  <span class="n">G</span> <span class="o">:</span> <span class="kr">constant</span><span class="p"> </span><span class="n">acceleration</span> <span class="o">:=</span> <span class="mf">9.81</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="o">(</span><span class="n">s</span> <span class="o">**</span> <span class="mi">2</span><span class="o">)</span><span class="p">;</span>
  <span class="n">T</span> <span class="o">:</span> <span class="n">Time</span> <span class="o">:=</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="o">*</span><span class="n">s</span><span class="p">;</span>
  <span class="n">Distance</span> <span class="o">:</span> <span class="n">Length</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
  <span class="n">Put</span> <span class="o">(</span><span class="s">&quot;Gravitational constant: &quot;</span><span class="o">)</span><span class="p">;</span>
  <span class="n">Put</span> <span class="o">(</span><span class="n">G</span><span class="p">,</span> <span class="n">Aft</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Exp</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">)</span><span class="p">;</span> <span class="n">Put_Line</span> <span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)</span><span class="p">;</span>
  <span class="n">Distance</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">T</span> <span class="o">**</span> <span class="mi">2</span><span class="p">;</span>
  <span class="n">Put</span> <span class="o">(</span><span class="s">&quot;distance travelled in 10 seconds of free fall &quot;</span><span class="o">)</span><span class="p">;</span>
  <span class="n">Put</span> <span class="o">(</span><span class="n">Distance</span><span class="p">,</span> <span class="n">Aft</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Exp</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">)</span><span class="p">;</span>
  <span class="n">Put_Line</span> <span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Free_Fall</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Execution of this program yields:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Gravitational</span> <span class="n">constant</span><span class="p">:</span>  <span class="mf">9.81</span> <span class="n">m</span><span class="o">/</span><span class="n">sec</span><span class="o">^</span><span class="mi">2</span>
<span class="n">distance</span> <span class="n">travelled</span> <span class="ow">in</span> <span class="mi">10</span> <span class="n">seconds</span> <span class="n">of</span> <span class="n">free</span> <span class="n">fall</span> <span class="mf">490.50</span> <span class="n">m</span>
</pre></div>
</div>
</div></blockquote>
<p>However, incorrect assignments such as:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">Distance</span> <span class="o">:=</span> <span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>
<span class="n">Distance</span> <span class="o">:=</span> <span class="mi">5</span><span class="o">.</span><span class="mi">0</span> <span class="o">*</span> <span class="n">kg</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>are rejected with the following diagnoses:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Distance</span> <span class="o">:=</span> <span class="mf">5.0</span><span class="p">;</span>
   <span class="o">&gt;&gt;&gt;</span> <span class="n">dimensions</span> <span class="n">mismatch</span> <span class="ow">in</span> <span class="n">assignment</span>
   <span class="o">&gt;&gt;&gt;</span> <span class="n">left</span><span class="o">-</span><span class="n">hand</span> <span class="n">side</span> <span class="n">has</span> <span class="n">dimension</span> <span class="p">[</span><span class="n">L</span><span class="p">]</span>
   <span class="o">&gt;&gt;&gt;</span> <span class="n">right</span><span class="o">-</span><span class="n">hand</span> <span class="n">side</span> <span class="ow">is</span> <span class="n">dimensionless</span>

<span class="n">Distance</span> <span class="o">:=</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">kg</span><span class="p">:</span>
   <span class="o">&gt;&gt;&gt;</span> <span class="n">dimensions</span> <span class="n">mismatch</span> <span class="ow">in</span> <span class="n">assignment</span>
   <span class="o">&gt;&gt;&gt;</span> <span class="n">left</span><span class="o">-</span><span class="n">hand</span> <span class="n">side</span> <span class="n">has</span> <span class="n">dimension</span> <span class="p">[</span><span class="n">L</span><span class="p">]</span>
   <span class="o">&gt;&gt;&gt;</span> <span class="n">right</span><span class="o">-</span><span class="n">hand</span> <span class="n">side</span> <span class="n">has</span> <span class="n">dimension</span> <span class="p">[</span><span class="n">M</span><span class="p">]</span>
</pre></div>
</div>
</div></blockquote>
<p>The dimensions of an expression are properly displayed, even if there is
no explicit subtype for it. If we add to the program:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">Put</span> <span class="o">(</span><span class="s">&quot;Final velocity: &quot;</span><span class="o">)</span><span class="p">;</span>
<span class="n">Put</span> <span class="o">(</span><span class="n">G</span> <span class="o">*</span> <span class="n">T</span><span class="p">,</span> <span class="n">Aft</span> <span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">Exp</span> <span class="o">=&gt;</span><span class="mi">0</span><span class="o">)</span><span class="p">;</span>
<span class="n">Put_Line</span> <span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">)</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>then the output includes:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Final</span> <span class="n">velocity</span><span class="p">:</span> <span class="mf">98.10</span> <span class="n">m</span><span class="o">.</span><span class="n">s</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<span class="target" id="index-76"></span></div></blockquote>
<p id="index-77">The type <code class="docutils literal notranslate"><span class="pre">Mks_Type</span></code> is said to be a <em>dimensionable type</em> since it has a
<code class="docutils literal notranslate"><span class="pre">Dimension_System</span></code> aspect, and the subtypes <code class="docutils literal notranslate"><span class="pre">Length</span></code>, <code class="docutils literal notranslate"><span class="pre">Mass</span></code>, etc.,
are said to be <em>dimensioned subtypes</em> since each one has a <code class="docutils literal notranslate"><span class="pre">Dimension</span></code>
aspect.</p>
<blockquote>
<div><span class="target" id="index-78"></span><span class="target" id="index-79"></span></div></blockquote>
<p id="index-80">The <code class="docutils literal notranslate"><span class="pre">Dimension</span></code> aspect of a dimensioned subtype <code class="docutils literal notranslate"><span class="pre">S</span></code> defines a mapping
from the base type’s Unit_Names to integer (or, more generally, rational)
values. This mapping is the <em>dimension vector</em> (also referred to as the
<em>dimensionality</em>) for that subtype, denoted by <code class="docutils literal notranslate"><span class="pre">DV(S)</span></code>, and thus for each
object of that subtype. Intuitively, the value specified for each
<code class="docutils literal notranslate"><span class="pre">Unit_Name</span></code> is the exponent associated with that unit; a zero value
means that the unit is not used. For example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">declare</span><span class="p"></span>
   <span class="n">Acc</span> <span class="o">:</span> <span class="n">Acceleration</span><span class="p">;</span>
   <span class="o">...</span>
<span class="kr">begin</span><span class="p"></span>
   <span class="o">...</span>
<span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>Here <code class="docutils literal notranslate"><span class="pre">DV(Acc)</span></code> = <code class="docutils literal notranslate"><span class="pre">DV(Acceleration)</span></code> =
<code class="docutils literal notranslate"><span class="pre">(Meter=&gt;1,</span> <span class="pre">Kilogram=&gt;0,</span> <span class="pre">Second=&gt;-2,</span> <span class="pre">Ampere=&gt;0,</span> <span class="pre">Kelvin=&gt;0,</span> <span class="pre">Mole=&gt;0,</span> <span class="pre">Candela=&gt;0)</span></code>.
Symbolically, we can express this as <code class="docutils literal notranslate"><span class="pre">Meter</span> <span class="pre">/</span> <span class="pre">Second**2</span></code>.</p>
<p>The dimension vector of an arithmetic expression is synthesized from the
dimension vectors of its components, with compile-time dimensionality checks
that help prevent mismatches such as using an <code class="docutils literal notranslate"><span class="pre">Acceleration</span></code> where a
<code class="docutils literal notranslate"><span class="pre">Length</span></code> is required.</p>
<p>The dimension vector of the result of an arithmetic expression <em>expr</em>, or
<code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr</span></em><span class="pre">)</span></code>, is defined as follows, assuming conventional
mathematical definitions for the vector operations that are used:</p>
<ul class="simple">
<li><p>If <em>expr</em> is of the type <em>universal_real</em>, or is not of a dimensioned subtype,
then <em>expr</em> is dimensionless; <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr</span></em><span class="pre">)</span></code> is the empty vector.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">op</span> <span class="pre">expr</span></em><span class="pre">)</span></code>, where <em>op</em> is a unary operator, is <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr</span></em><span class="pre">)</span></code></p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr1</span> <span class="pre">op</span> <span class="pre">expr2</span></em><span class="pre">)</span></code> where <em>op</em> is “+” or “-” is <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr1</span></em><span class="pre">)</span></code>
provided that <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr1</span></em><span class="pre">)</span></code> = <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr2</span></em><span class="pre">)</span></code>.
If this condition is not met then the construct is illegal.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr1</span></em> <span class="pre">*</span> <em><span class="pre">expr2</span></em><span class="pre">)</span></code> is <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr1</span></em><span class="pre">)</span></code> + <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr2</span></em><span class="pre">)</span></code>,
and <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr1</span></em> <span class="pre">/</span> <em><span class="pre">expr2</span></em><span class="pre">)</span></code> = <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr1</span></em><span class="pre">)</span></code> - <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr2</span></em><span class="pre">)</span></code>.
In this context if one of the <em>expr</em>s is dimensionless then its empty
dimension vector is treated as <code class="docutils literal notranslate"><span class="pre">(others</span> <span class="pre">=&gt;</span> <span class="pre">0)</span></code>.</p></li>
<li><p><code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr</span></em> <span class="pre">**</span> <em><span class="pre">power</span></em><span class="pre">)</span></code> is <em>power</em> * <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr</span></em><span class="pre">)</span></code>,
provided that <em>power</em> is a static rational value. If this condition is not
met then the construct is illegal.</p></li>
</ul>
<p>Note that, by the above rules, it is illegal to use binary “+” or “-” to
combine a dimensioned and dimensionless value.  Thus an expression such as
<code class="docutils literal notranslate"><span class="pre">acc-10.0</span></code> is illegal, where <code class="docutils literal notranslate"><span class="pre">acc</span></code> is an object of subtype
<code class="docutils literal notranslate"><span class="pre">Acceleration</span></code>.</p>
<p>The dimensionality checks for relationals use the same rules as
for “+” and “-“, except when comparing to a literal; thus</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">acc</span> <span class="o">&gt;</span> <span class="n">len</span>
</pre></div>
</div>
</div></blockquote>
<p>is equivalent to</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">acc</span><span class="o">-</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
</div></blockquote>
<p>and is thus illegal, but</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">acc</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
</div></blockquote>
<p>is accepted with a warning. Analogously a conditional expression requires the
same dimension vector for each branch (with no exception for literals).</p>
<p>The dimension vector of a type conversion <code class="samp docutils literal notranslate"><span class="pre">T(</span><em><span class="pre">expr</span></em><span class="pre">)</span></code> is defined
as follows, based on the nature of <code class="docutils literal notranslate"><span class="pre">T</span></code>:</p>
<ul>
<li><p>If <code class="docutils literal notranslate"><span class="pre">T</span></code> is a dimensioned subtype then <code class="samp docutils literal notranslate"><span class="pre">DV(T(</span><em><span class="pre">expr</span></em><span class="pre">))</span></code> is <code class="docutils literal notranslate"><span class="pre">DV(T)</span></code>
provided that either <em>expr</em> is dimensionless or
<code class="samp docutils literal notranslate"><span class="pre">DV(T)</span></code> = <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr</span></em><span class="pre">)</span></code>. The conversion is illegal
if <em>expr</em> is dimensioned and <code class="samp docutils literal notranslate"><span class="pre">DV(</span><em><span class="pre">expr</span></em><span class="pre">)</span></code> /= <code class="docutils literal notranslate"><span class="pre">DV(T)</span></code>.
Note that vector equality does not require that the corresponding
Unit_Names be the same.</p>
<p>As a consequence of the above rule, it is possible to convert between
different dimension systems that follow the same international system
of units, with the seven physical components given in the standard order
(length, mass, time, etc.). Thus a length in meters can be converted to
a length in inches (with a suitable conversion factor) but cannot be
converted, for example, to a mass in pounds.</p>
</li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">T</span></code> is the base type for <em>expr</em> (and the dimensionless root type of
the dimension system), then <code class="samp docutils literal notranslate"><span class="pre">DV(T(</span><em><span class="pre">expr</span></em><span class="pre">))</span></code> is <code class="docutils literal notranslate"><span class="pre">DV(expr)</span></code>.
Thus, if <em>expr</em> is of a dimensioned subtype of <code class="docutils literal notranslate"><span class="pre">T</span></code>, the conversion may
be regarded as a “view conversion” that preserves dimensionality.</p>
<p>This rule makes it possible to write generic code that can be instantiated
with compatible dimensioned subtypes.  The generic unit will contain
conversions that will consequently be present in instantiations, but
conversions to the base type will preserve dimensionality and make it
possible to write generic code that is correct with respect to
dimensionality.</p>
</li>
<li><p>Otherwise (i.e., <code class="docutils literal notranslate"><span class="pre">T</span></code> is neither a dimensioned subtype nor a dimensionable
base type), <code class="samp docutils literal notranslate"><span class="pre">DV(T(</span><em><span class="pre">expr</span></em><span class="pre">))</span></code> is the empty vector. Thus a dimensioned
value can be explicitly converted to a non-dimensioned subtype, which
of course then escapes dimensionality analysis.</p></li>
</ul>
<p>The dimension vector for a type qualification <code class="samp docutils literal notranslate"><span class="pre">T'(</span><em><span class="pre">expr</span></em><span class="pre">)</span></code> is the same
as for the type conversion <code class="samp docutils literal notranslate"><span class="pre">T(</span><em><span class="pre">expr</span></em><span class="pre">)</span></code>.</p>
<p>An assignment statement</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="n">Source</span> <span class="o">:=</span> <span class="n">Target</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>requires <code class="docutils literal notranslate"><span class="pre">DV(Source)</span></code> = <code class="docutils literal notranslate"><span class="pre">DV(Target)</span></code>, and analogously for parameter
passing (the dimension vector for the actual parameter must be equal to the
dimension vector for the formal parameter).</p>
</div>
<div class="section" id="stack-related-facilities">
<span id="id52"></span><h2><span class="section-number">6.6. </span>Stack Related Facilities<a class="headerlink" href="#stack-related-facilities" title="Permalink to this headline">¶</a></h2>
<p>This section describes some useful tools associated with stack
checking and analysis. In
particular, it deals with dynamic and static stack usage measurements.</p>
<div class="section" id="stack-overflow-checking">
<span id="id53"></span><h3><span class="section-number">6.6.1. </span>Stack Overflow Checking<a class="headerlink" href="#stack-overflow-checking" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-81"></span><p id="index-82">For most operating systems, <code class="docutils literal notranslate"><span class="pre">gcc</span></code> does not perform stack overflow
checking by default. This means that if the main environment task or
some other task exceeds the available stack space, then unpredictable
behavior will occur. Most native systems offer some level of protection by
adding a guard page at the end of each task stack. This mechanism is usually
not enough for dealing properly with stack overflow situations because
a large local variable could “jump” above the guard page.
Furthermore, when the
guard page is hit, there may not be any space left on the stack for executing
the exception propagation code. Enabling stack checking avoids
such situations.</p>
<p>To activate stack checking, compile all units with the <code class="docutils literal notranslate"><span class="pre">gcc</span></code> option
<code class="switch docutils literal notranslate"><span class="pre">-fstack-check</span></code>. For example:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gcc -c -fstack-check package1.adb
</pre></div>
</div>
</div></blockquote>
<p>Units compiled with this option will generate extra instructions to check
that any use of the stack (for procedure calls or for declaring local
variables in declare blocks) does not exceed the available stack space.
If the space is exceeded, then a <code class="docutils literal notranslate"><span class="pre">Storage_Error</span></code> exception is raised.</p>
<p>For declared tasks, the default stack size is defined by the GNAT runtime,
whose size may be modified at bind time through the <code class="docutils literal notranslate"><span class="pre">-d</span></code> bind switch
(<a class="reference internal" href="building_executable_programs_with_gnat.html#switches-for-gnatbind"><span class="std std-ref">Switches for gnatbind</span></a>). Task specific stack sizes may be set using the
<code class="docutils literal notranslate"><span class="pre">Storage_Size</span></code> pragma.</p>
<p>For the environment task, the stack size is determined by the operating system.
Consequently, to modify the size of the environment task please refer to your
operating system documentation.</p>
</div>
<div class="section" id="static-stack-usage-analysis">
<span id="id54"></span><h3><span class="section-number">6.6.2. </span>Static Stack Usage Analysis<a class="headerlink" href="#static-stack-usage-analysis" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-83"></span><p id="index-84">A unit compiled with <code class="docutils literal notranslate"><span class="pre">-fstack-usage</span></code> will generate an extra file
that specifies
the maximum amount of stack used, on a per-function basis.
The file has the same
basename as the target object file with a <code class="file docutils literal notranslate"><span class="pre">.su</span></code> extension.
Each line of this file is made up of three fields:</p>
<ul class="simple">
<li><p>The name of the function.</p></li>
<li><p>A number of bytes.</p></li>
<li><p>One or more qualifiers: <code class="docutils literal notranslate"><span class="pre">static</span></code>, <code class="docutils literal notranslate"><span class="pre">dynamic</span></code>, <code class="docutils literal notranslate"><span class="pre">bounded</span></code>.</p></li>
</ul>
<p>The second field corresponds to the size of the known part of the function
frame.</p>
<p>The qualifier <code class="docutils literal notranslate"><span class="pre">static</span></code> means that the function frame size
is purely static.
It usually means that all local variables have a static size.
In this case, the second field is a reliable measure of the function stack
utilization.</p>
<p>The qualifier <code class="docutils literal notranslate"><span class="pre">dynamic</span></code> means that the function frame size is not static.
It happens mainly when some local variables have a dynamic size. When this
qualifier appears alone, the second field is not a reliable measure
of the function stack analysis. When it is qualified with  <code class="docutils literal notranslate"><span class="pre">bounded</span></code>, it
means that the second field is a reliable maximum of the function stack
utilization.</p>
<p>A unit compiled with <code class="docutils literal notranslate"><span class="pre">-Wstack-usage</span></code> will issue a warning for each
subprogram whose stack usage might be larger than the specified amount of
bytes.  The wording is in keeping with the qualifier documented above.</p>
</div>
<div class="section" id="dynamic-stack-usage-analysis">
<span id="id55"></span><h3><span class="section-number">6.6.3. </span>Dynamic Stack Usage Analysis<a class="headerlink" href="#dynamic-stack-usage-analysis" title="Permalink to this headline">¶</a></h3>
<p>It is possible to measure the maximum amount of stack used by a task, by
adding a switch to <code class="docutils literal notranslate"><span class="pre">gnatbind</span></code>, as:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatbind -u0 file
</pre></div>
</div>
</div></blockquote>
<p>With this option, at each task termination, its stack usage is output on
<code class="file docutils literal notranslate"><span class="pre">stderr</span></code>.
Note that this switch is not compatible with tools like
Valgrind and DrMemory; they will report errors.</p>
<p>It is not always convenient to output the stack usage when the program
is still running. Hence, it is possible to delay this output until program
termination. for a given number of tasks specified as the argument of the
<code class="docutils literal notranslate"><span class="pre">-u</span></code> option. For instance:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatbind -u100 file
</pre></div>
</div>
</div></blockquote>
<p>will buffer the stack usage information of the first 100 tasks to terminate and
output this info at program termination. Results are displayed in four
columns:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Index</span> <span class="o">|</span> <span class="n">Task</span> <span class="n">Name</span> <span class="o">|</span> <span class="n">Stack</span> <span class="n">Size</span> <span class="o">|</span> <span class="n">Stack</span> <span class="n">Usage</span>
</pre></div>
</div>
</div></blockquote>
<p>where:</p>
<ul class="simple">
<li><p><em>Index</em> is a number associated with each task.</p></li>
<li><p><em>Task Name</em> is the name of the task analyzed.</p></li>
<li><p><em>Stack Size</em> is the maximum size for the stack.</p></li>
<li><p><em>Stack Usage</em> is the measure done by the stack analyzer.
In order to prevent overflow, the stack
is not entirely analyzed, and it’s not possible to know exactly how
much has actually been used.</p></li>
</ul>
<p>By default the environment task stack, the stack that contains the main unit,
is not processed. To enable processing of the environment task stack, the
environment variable GNAT_STACK_LIMIT needs to be set to the maximum size of
the environment task stack. This amount is given in kilobytes. For example:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ set GNAT_STACK_LIMIT 1600
</pre></div>
</div>
</div></blockquote>
<p>would specify to the analyzer that the environment task stack has a limit
of 1.6 megabytes. Any stack usage beyond this will be ignored by the analysis.</p>
<p>The package <code class="docutils literal notranslate"><span class="pre">GNAT.Task_Stack_Usage</span></code> provides facilities to get
stack-usage reports at run time. See its body for the details.</p>
</div>
</div>
<div class="section" id="memory-management-issues">
<span id="id56"></span><h2><span class="section-number">6.7. </span>Memory Management Issues<a class="headerlink" href="#memory-management-issues" title="Permalink to this headline">¶</a></h2>
<p>This section describes some useful memory pools provided in the GNAT library
and in particular the GNAT Debug Pool facility, which can be used to detect
incorrect uses of access values (including ‘dangling references’).</p>
<p>It also describes the <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> tool, which can be used to track down
“memory leaks”.</p>
<div class="section" id="some-useful-memory-pools">
<span id="id57"></span><h3><span class="section-number">6.7.1. </span>Some Useful Memory Pools<a class="headerlink" href="#some-useful-memory-pools" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-85"></span><p id="index-86">The <code class="docutils literal notranslate"><span class="pre">System.Pool_Global</span></code> package offers the Unbounded_No_Reclaim_Pool
storage pool. Allocations use the standard system call <code class="docutils literal notranslate"><span class="pre">malloc</span></code> while
deallocations use the standard system call <code class="docutils literal notranslate"><span class="pre">free</span></code>. No reclamation is
performed when the pool goes out of scope. For performance reasons, the
standard default Ada allocators/deallocators do not use any explicit storage
pools but if they did, they could use this storage pool without any change in
behavior. That is why this storage pool is used  when the user
manages to make the default implicit allocator explicit as in this example:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">T1</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Something</span><span class="p">;</span>
 <span class="c">-- no Storage pool is defined for T2</span>

<span class="kr">type</span><span class="p"> </span><span class="n">T2</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Something_Else</span><span class="p">;</span>
<span class="kr">for</span><span class="p"> </span><span class="n">T2</span><span class="na">&#39;Storage_Pool</span> <span class="kr">use</span><span class="p"> </span><span class="n">T1</span><span class="na">&#39;Storage_Pool</span><span class="p">;</span>
<span class="c">-- the above is equivalent to</span>
<span class="kr">for</span><span class="p"> </span><span class="n">T2</span><span class="na">&#39;Storage_Pool</span> <span class="kr">use</span><span class="p"> </span><span class="n">System.Pool_Global.Global_Pool_Object</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">System.Pool_Local</span></code> package offers the <code class="docutils literal notranslate"><span class="pre">Unbounded_Reclaim_Pool</span></code> storage
pool. The allocation strategy is similar to <code class="docutils literal notranslate"><span class="pre">Pool_Local</span></code>
except that the all
storage allocated with this pool is reclaimed when the pool object goes out of
scope. This pool provides a explicit mechanism similar to the implicit one
provided by several Ada 83 compilers for allocations performed through a local
access type and whose purpose was to reclaim memory when exiting the
scope of a given local access. As an example, the following program does not
leak memory even though it does not perform explicit deallocation:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">System.Pool_Local</span><span class="p">;</span>
<span class="k">procedure </span><span class="nf">Pooloc1</span> <span class="kr">is</span><span class="p"></span>
   <span class="k">procedure </span><span class="nf">Internal</span> <span class="kr">is</span><span class="p"></span>
      <span class="kr">type</span><span class="p"> </span><span class="n">A</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Integer</span><span class="p">;</span>
      <span class="n">X</span> <span class="o">:</span> <span class="n">System.Pool_Local.Unbounded_Reclaim_Pool</span><span class="p">;</span>
      <span class="kr">for</span><span class="p"> </span><span class="n">A</span><span class="na">&#39;Storage_Pool</span> <span class="kr">use</span><span class="p"> </span><span class="n">X</span><span class="p">;</span>
      <span class="n">v</span> <span class="o">:</span> <span class="n">A</span><span class="p">;</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="kr">for</span><span class="p"> </span><span class="n">I</span> <span class="kr">in</span><span class="p"> </span> <span class="mi">1</span> <span class="o">..</span> <span class="mi">50</span> <span class="kr">loop</span><span class="p"></span>
         <span class="n">v</span> <span class="o">:=</span> <span class="kr">new</span><span class="p"> </span><span class="n">Integer</span><span class="p">;</span>
      <span class="k">end loop</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">Internal</span><span class="p">;</span>
<span class="kr">begin</span><span class="p"></span>
   <span class="kr">for</span><span class="p"> </span><span class="n">I</span> <span class="kr">in</span><span class="p"> </span> <span class="mi">1</span> <span class="o">..</span> <span class="mi">100</span> <span class="kr">loop</span><span class="p"></span>
      <span class="n">Internal</span><span class="p">;</span>
   <span class="k">end loop</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Pooloc1</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">System.Pool_Size</span></code> package implements the <code class="docutils literal notranslate"><span class="pre">Stack_Bounded_Pool</span></code> used when
<code class="docutils literal notranslate"><span class="pre">Storage_Size</span></code> is specified for an access type.
The whole storage for the pool is
allocated at once, usually on the stack at the point where the access type is
elaborated. It is automatically reclaimed when exiting the scope where the
access type is defined. This package is not intended to be used directly by the
user and it is implicitly used for each such declaration:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">T1</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Something</span><span class="p">;</span>
<span class="kr">for</span><span class="p"> </span><span class="n">T1</span><span class="na">&#39;Storage_Size</span> <span class="kr">use</span><span class="p"> </span><span class="mi">10_000</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="the-gnat-debug-pool-facility">
<span id="id58"></span><h3><span class="section-number">6.7.2. </span>The GNAT Debug Pool Facility<a class="headerlink" href="#the-gnat-debug-pool-facility" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-87"></span><p id="index-88">The use of unchecked deallocation and unchecked conversion can easily
lead to incorrect memory references. The problems generated by such
references are usually difficult to tackle because the symptoms can be
very remote from the origin of the problem. In such cases, it is
very helpful to detect the problem as early as possible. This is the
purpose of the Storage Pool provided by <code class="docutils literal notranslate"><span class="pre">GNAT.Debug_Pools</span></code>.</p>
<p>In order to use the GNAT specific debugging pool, the user must
associate a debug pool object with each of the access types that may be
related to suspected memory problems. See Ada Reference Manual 13.11.</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">type</span><span class="p"> </span><span class="n">Ptr</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Some_Type</span><span class="p">;</span>
<span class="n">Pool</span> <span class="o">:</span> <span class="n">GNAT.Debug_Pools.Debug_Pool</span><span class="p">;</span>
<span class="kr">for</span><span class="p"> </span><span class="n">Ptr</span><span class="na">&#39;Storage_Pool</span> <span class="kr">use</span><span class="p"> </span><span class="n">Pool</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">GNAT.Debug_Pools</span></code> is derived from a GNAT-specific kind of
pool: the <code class="docutils literal notranslate"><span class="pre">Checked_Pool</span></code>. Such pools, like standard Ada storage pools,
allow the user to redefine allocation and deallocation strategies. They
also provide a checkpoint for each dereference, through the use of
the primitive operation <code class="docutils literal notranslate"><span class="pre">Dereference</span></code> which is implicitly called at
each dereference of an access value.</p>
<p>Once an access type has been associated with a debug pool, operations on
values of the type may raise four distinct exceptions,
which correspond to four potential kinds of memory corruption:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GNAT.Debug_Pools.Accessing_Not_Allocated_Storage</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GNAT.Debug_Pools.Accessing_Deallocated_Storage</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GNAT.Debug_Pools.Freeing_Not_Allocated_Storage</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GNAT.Debug_Pools.Freeing_Deallocated_Storage</span></code></p></li>
</ul>
<p>For types associated with a Debug_Pool, dynamic allocation is performed using
the standard GNAT allocation routine. References to all allocated chunks of
memory are kept in an internal dictionary. Several deallocation strategies are
provided, whereupon the user can choose to release the memory to the system,
keep it allocated for further invalid access checks, or fill it with an easily
recognizable pattern for debug sessions. The memory pattern is the old IBM
hexadecimal convention: <code class="docutils literal notranslate"><span class="pre">16#DEADBEEF#</span></code>.</p>
<p>See the documentation in the file g-debpoo.ads for more information on the
various strategies.</p>
<p>Upon each dereference, a check is made that the access value denotes a
properly allocated memory location. Here is a complete example of use of
<code class="docutils literal notranslate"><span class="pre">Debug_Pools</span></code>, that includes typical instances of  memory corruption:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">Gnat.Io</span><span class="p">; </span><span class="kr">use</span><span class="nn"> Gnat.Io;</span><span class="p"></span>
<span class="kr">with</span><span class="nn"> Unchecked_Deallocation;</span><span class="p"></span>
<span class="kr">with</span><span class="nn"> Unchecked_Conversion;</span><span class="p"></span>
<span class="kr">with</span><span class="nn"> GNAT.Debug_Pools;</span><span class="p"></span>
<span class="kr">with</span><span class="nn"> System.Storage_Elements;</span><span class="p"></span>
<span class="kr">with</span><span class="nn"> Ada.Exceptions;</span> <span class="kr">use</span><span class="p"> </span><span class="n">Ada.Exceptions</span><span class="p">;</span>
<span class="k">procedure </span><span class="nf">Debug_Pool_Test</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">type</span><span class="p"> </span><span class="n">T</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">Integer</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">U</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="kr">all</span><span class="p"> </span><span class="n">T</span><span class="p">;</span>

   <span class="n">P</span> <span class="o">:</span> <span class="n">GNAT.Debug_Pools.Debug_Pool</span><span class="p">;</span>
   <span class="kr">for</span><span class="p"> </span><span class="n">T</span><span class="na">&#39;Storage_Pool</span> <span class="kr">use</span><span class="p"> </span><span class="n">P</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">Free</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">Unchecked_Deallocation</span> <span class="o">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">T</span><span class="o">)</span><span class="p">;</span>
   <span class="k">function </span><span class="nf">UC</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">Unchecked_Conversion</span> <span class="o">(</span><span class="n">U</span><span class="p">,</span> <span class="n">T</span><span class="o">)</span><span class="p">;</span>
   <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">:</span> <span class="kr">aliased</span><span class="p"> </span><span class="n">T</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">Info</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">GNAT.Debug_Pools.Print_Info</span><span class="o">(</span><span class="n">Put_Line</span><span class="o">)</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="n">Info</span> <span class="o">(</span><span class="n">P</span><span class="o">)</span><span class="p">;</span>
   <span class="n">A</span> <span class="o">:=</span> <span class="kr">new</span><span class="p"> </span><span class="n">Integer</span><span class="p">;</span>
   <span class="n">B</span> <span class="o">:=</span> <span class="kr">new</span><span class="p"> </span><span class="n">Integer</span><span class="p">;</span>
   <span class="n">B</span> <span class="o">:=</span> <span class="n">A</span><span class="p">;</span>
   <span class="n">Info</span> <span class="o">(</span><span class="n">P</span><span class="o">)</span><span class="p">;</span>
   <span class="n">Free</span> <span class="o">(</span><span class="n">A</span><span class="o">)</span><span class="p">;</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Put_Line</span> <span class="o">(</span><span class="n">Integer</span><span class="na">&#39;Image</span><span class="o">(</span><span class="n">B.all</span><span class="o">))</span><span class="p">;</span>
   <span class="kr">exception</span><span class="p"></span>
      <span class="kr">when</span><span class="p"> </span><span class="n">E</span> <span class="o">:</span> <span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span> <span class="n">Put_Line</span> <span class="o">(</span><span class="s">&quot;raised: &quot;</span> <span class="o">&amp;</span> <span class="n">Exception_Name</span> <span class="o">(</span><span class="n">E</span><span class="o">))</span><span class="p">;</span>
   <span class="kr">end</span><span class="p">;</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Free</span> <span class="o">(</span><span class="n">B</span><span class="o">)</span><span class="p">;</span>
   <span class="kr">exception</span><span class="p"></span>
      <span class="kr">when</span><span class="p"> </span><span class="n">E</span> <span class="o">:</span> <span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span> <span class="n">Put_Line</span> <span class="o">(</span><span class="s">&quot;raised: &quot;</span> <span class="o">&amp;</span> <span class="n">Exception_Name</span> <span class="o">(</span><span class="n">E</span><span class="o">))</span><span class="p">;</span>
   <span class="kr">end</span><span class="p">;</span>
   <span class="n">B</span> <span class="o">:=</span> <span class="n">UC</span><span class="o">(</span><span class="n">A</span><span class="na">&#39;Access</span><span class="o">)</span><span class="p">;</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Put_Line</span> <span class="o">(</span><span class="n">Integer</span><span class="na">&#39;Image</span><span class="o">(</span><span class="n">B.all</span><span class="o">))</span><span class="p">;</span>
   <span class="kr">exception</span><span class="p"></span>
      <span class="kr">when</span><span class="p"> </span><span class="n">E</span> <span class="o">:</span> <span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span> <span class="n">Put_Line</span> <span class="o">(</span><span class="s">&quot;raised: &quot;</span> <span class="o">&amp;</span> <span class="n">Exception_Name</span> <span class="o">(</span><span class="n">E</span><span class="o">))</span><span class="p">;</span>
   <span class="kr">end</span><span class="p">;</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Free</span> <span class="o">(</span><span class="n">B</span><span class="o">)</span><span class="p">;</span>
   <span class="kr">exception</span><span class="p"></span>
      <span class="kr">when</span><span class="p"> </span><span class="n">E</span> <span class="o">:</span> <span class="kr">others</span><span class="p"> </span><span class="o">=&gt;</span> <span class="n">Put_Line</span> <span class="o">(</span><span class="s">&quot;raised: &quot;</span> <span class="o">&amp;</span> <span class="n">Exception_Name</span> <span class="o">(</span><span class="n">E</span><span class="o">))</span><span class="p">;</span>
   <span class="kr">end</span><span class="p">;</span>
   <span class="n">Info</span> <span class="o">(</span><span class="n">P</span><span class="o">)</span><span class="p">;</span>
<span class="k">end </span><span class="nf">Debug_Pool_Test</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>The debug pool mechanism provides the following precise diagnostics on the
execution of this erroneous program:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Debug</span> <span class="n">Pool</span> <span class="n">info</span><span class="p">:</span>
  <span class="n">Total</span> <span class="n">allocated</span> <span class="nb">bytes</span> <span class="p">:</span>  <span class="mi">0</span>
  <span class="n">Total</span> <span class="n">deallocated</span> <span class="nb">bytes</span> <span class="p">:</span>  <span class="mi">0</span>
  <span class="n">Current</span> <span class="n">Water</span> <span class="n">Mark</span><span class="p">:</span>  <span class="mi">0</span>
  <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span><span class="p">:</span>  <span class="mi">0</span>

<span class="n">Debug</span> <span class="n">Pool</span> <span class="n">info</span><span class="p">:</span>
  <span class="n">Total</span> <span class="n">allocated</span> <span class="nb">bytes</span> <span class="p">:</span>  <span class="mi">8</span>
  <span class="n">Total</span> <span class="n">deallocated</span> <span class="nb">bytes</span> <span class="p">:</span>  <span class="mi">0</span>
  <span class="n">Current</span> <span class="n">Water</span> <span class="n">Mark</span><span class="p">:</span>  <span class="mi">8</span>
  <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span><span class="p">:</span>  <span class="mi">8</span>

<span class="n">raised</span><span class="p">:</span> <span class="n">GNAT</span><span class="o">.</span><span class="n">DEBUG_POOLS</span><span class="o">.</span><span class="n">ACCESSING_DEALLOCATED_STORAGE</span>
<span class="n">raised</span><span class="p">:</span> <span class="n">GNAT</span><span class="o">.</span><span class="n">DEBUG_POOLS</span><span class="o">.</span><span class="n">FREEING_DEALLOCATED_STORAGE</span>
<span class="n">raised</span><span class="p">:</span> <span class="n">GNAT</span><span class="o">.</span><span class="n">DEBUG_POOLS</span><span class="o">.</span><span class="n">ACCESSING_NOT_ALLOCATED_STORAGE</span>
<span class="n">raised</span><span class="p">:</span> <span class="n">GNAT</span><span class="o">.</span><span class="n">DEBUG_POOLS</span><span class="o">.</span><span class="n">FREEING_NOT_ALLOCATED_STORAGE</span>
<span class="n">Debug</span> <span class="n">Pool</span> <span class="n">info</span><span class="p">:</span>
  <span class="n">Total</span> <span class="n">allocated</span> <span class="nb">bytes</span> <span class="p">:</span>  <span class="mi">8</span>
  <span class="n">Total</span> <span class="n">deallocated</span> <span class="nb">bytes</span> <span class="p">:</span>  <span class="mi">4</span>
  <span class="n">Current</span> <span class="n">Water</span> <span class="n">Mark</span><span class="p">:</span>  <span class="mi">4</span>
  <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span><span class="p">:</span>  <span class="mi">8</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="the-gnatmem-tool">
<span id="id59"></span><h3><span class="section-number">6.7.3. </span>The <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> Tool<a class="headerlink" href="#the-gnatmem-tool" title="Permalink to this headline">¶</a></h3>
<p id="index-89">The <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> utility monitors dynamic allocation and
deallocation activity in a program, and displays information about
incorrect deallocations and possible sources of memory leaks.
It is designed to work in association with a static runtime library
only and in this context provides three types of information:</p>
<ul class="simple">
<li><p>General information concerning memory management, such as the total
number of allocations and deallocations, the amount of allocated
memory and the high water mark, i.e., the largest amount of allocated
memory in the course of program execution.</p></li>
<li><p>Backtraces for all incorrect deallocations, that is to say deallocations
which do not correspond to a valid allocation.</p></li>
<li><p>Information on each allocation that is potentially the origin of a memory
leak.</p></li>
</ul>
<div class="section" id="running-gnatmem">
<span id="id60"></span><h4><span class="section-number">6.7.3.1. </span>Running <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code><a class="headerlink" href="#running-gnatmem" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> makes use of the output created by the special version of
allocation and deallocation routines that record call information. This allows
it to obtain accurate dynamic memory usage history at a minimal cost to the
execution speed. Note however, that <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> is only supported on
GNU/Linux and Windows.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> command has the form</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmem [ switches ] [ DEPTH ] user_program
</pre></div>
</div>
</div></blockquote>
<p>The program must have been linked with the instrumented version of the
allocation and deallocation routines. This is done by linking with the
<code class="file docutils literal notranslate"><span class="pre">libgmem.a</span></code> library. For correct symbolic backtrace information,
the user program should be compiled with debugging options
(see <a class="reference internal" href="building_executable_programs_with_gnat.html#switches-for-gcc"><span class="std std-ref">Compiler Switches</span></a>). For example to build <code class="file docutils literal notranslate"><span class="pre">my_program</span></code>:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmake -g my_program -largs -lgmem
</pre></div>
</div>
</div></blockquote>
<p>As library <code class="file docutils literal notranslate"><span class="pre">libgmem.a</span></code> contains an alternate body for package
<code class="docutils literal notranslate"><span class="pre">System.Memory</span></code>, <code class="file docutils literal notranslate"><span class="pre">s-memory.adb</span></code> should not be compiled and linked
when an executable is linked with library <code class="file docutils literal notranslate"><span class="pre">libgmem.a</span></code>. It is then not
recommended to use <code class="docutils literal notranslate"><span class="pre">gnatmake</span></code> with switch <code class="switch docutils literal notranslate"><span class="pre">-a</span></code>.</p>
<p>When <code class="file docutils literal notranslate"><span class="pre">my_program</span></code> is executed, the file <code class="file docutils literal notranslate"><span class="pre">gmem.out</span></code> is produced.
This file contains information about all allocations and deallocations
performed by the program. It is produced by the instrumented allocations and
deallocations routines and will be used by <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code>.</p>
<p>In order to produce symbolic backtrace information for allocations and
deallocations performed by the GNAT run-time library, you need to use a
version of that library that has been compiled with the <code class="switch docutils literal notranslate"><span class="pre">-g</span></code> switch
(see <a class="reference internal" href="the_gnat_compilation_model.html#rebuilding-the-gnat-run-time-library"><span class="std std-ref">Rebuilding the GNAT Run-Time Library</span></a>).</p>
<p><code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> must be supplied with the <code class="file docutils literal notranslate"><span class="pre">gmem.out</span></code> file and the executable to
examine. If the location of <code class="file docutils literal notranslate"><span class="pre">gmem.out</span></code> file was not explicitly supplied by
<code class="switch docutils literal notranslate"><span class="pre">-i</span></code> switch, gnatmem will assume that this file can be found in the
current directory. For example, after you have executed <code class="file docutils literal notranslate"><span class="pre">my_program</span></code>,
<code class="file docutils literal notranslate"><span class="pre">gmem.out</span></code> can be analyzed by <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> using the command:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmem my_program
</pre></div>
</div>
</div></blockquote>
<p>This will produce the output with the following format:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmem my_program

Global information
------------------
   Total number of allocations        :  45
   Total number of deallocations      :   6
   Final Water Mark (non freed mem)   :  11.29 Kilobytes
   High Water Mark                    :  11.40 Kilobytes

.
.
.
Allocation Root # 2
-------------------
 Number of non freed allocations    :  11
 Final Water Mark (non freed mem)   :   1.16 Kilobytes
 High Water Mark                    :   1.27 Kilobytes
 Backtrace                          :
   my_program.adb:23 my_program.alloc
.
.
.
</pre></div>
</div>
</div></blockquote>
<p>The first block of output gives general information. In this case, the
Ada construct <code class="docutils literal notranslate"><span class="pre">new</span></code> was executed 45 times, and only 6 calls to an
Unchecked_Deallocation routine occurred.</p>
<p>Subsequent paragraphs display  information on all allocation roots.
An allocation root is a specific point in the execution of the program
that generates some dynamic allocation, such as a <code class="docutils literal notranslate"><span class="pre">new</span></code>
construct. This root is represented by an execution backtrace (or subprogram
call stack). By default the backtrace depth for allocations roots is 1, so
that a root corresponds exactly to a source location. The backtrace can
be made deeper, to make the root more specific.</p>
</div>
<div class="section" id="switches-for-gnatmem">
<span id="id61"></span><h4><span class="section-number">6.7.3.2. </span>Switches for <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code><a class="headerlink" href="#switches-for-gnatmem" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> recognizes the following switches:</p>
<dl class="simple" id="index-90">
<dt><code class="samp docutils literal notranslate"><span class="pre">-q</span></code></dt><dd><p>Quiet. Gives the minimum output needed to identify the origin of the
memory leaks. Omits statistical information.</p>
</dd>
</dl>
<dl class="simple" id="index-91">
<dt><code class="samp docutils literal notranslate"><em><span class="pre">DEPTH</span></em></code></dt><dd><p><code class="docutils literal notranslate"><span class="pre">DEPTH</span></code> is an integer literal (usually between 1 and 10) which controls
the depth of the backtraces defining allocation root. The default value for
DEPTH is 1. The deeper the backtrace, the more precise the localization of
the root. Note that the total number of roots can depend on this
parameter, in other words there may be more roots when the requested
backtrace depth is higher. This parameter must be specified <em>before</em> the
name of the executable to be analyzed, to avoid ambiguity.</p>
</dd>
</dl>
<dl class="simple" id="index-92">
<dt><code class="samp docutils literal notranslate"><span class="pre">-b</span> <em><span class="pre">N</span></em></code></dt><dd><p>This switch has the same effect as just a depth parameter <code class="docutils literal notranslate"><span class="pre">N</span></code>.</p>
</dd>
</dl>
<dl class="simple" id="index-93">
<dt><code class="samp docutils literal notranslate"><span class="pre">-i</span> <em><span class="pre">file</span></em></code></dt><dd><p>Do the <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> processing starting from <code class="file docutils literal notranslate"><span class="pre">file</span></code>, rather than
<code class="file docutils literal notranslate"><span class="pre">gmem.out</span></code> in the current directory.</p>
</dd>
</dl>
<dl class="simple" id="index-94">
<dt><code class="samp docutils literal notranslate"><span class="pre">-m</span> <em><span class="pre">n</span></em></code></dt><dd><p>This switch causes <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> to mask the allocation roots that have less
than n leaks.  The default value is 1. Specifying the value of 0 will allow
examination of even the roots that did not result in leaks.</p>
</dd>
</dl>
<dl class="simple" id="index-95">
<dt><code class="samp docutils literal notranslate"><span class="pre">-s</span> <em><span class="pre">order</span></em></code></dt><dd><p>This switch causes <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> to sort the allocation roots according to the
specified order of sort criteria, each identified by a single letter. The
currently supported criteria are <code class="docutils literal notranslate"><span class="pre">n</span></code>, <code class="docutils literal notranslate"><span class="pre">h</span></code>, and <code class="docutils literal notranslate"><span class="pre">w</span></code> standing respectively for
number of unfreed allocations, high watermark, and final watermark
corresponding to a specific root. The default order is <code class="docutils literal notranslate"><span class="pre">nwh</span></code>.</p>
</dd>
</dl>
<dl class="simple" id="index-96">
<dt><code class="samp docutils literal notranslate"><span class="pre">-t</span></code></dt><dd><p>This switch causes memory allocated size to be always output in bytes.
Default <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> behavior is to show memory sizes less then 1 kilobyte
in bytes, from 1 kilobyte till 1 megabyte in kilobytes and the rest in
megabytes.</p>
</dd>
</dl>
</div>
<div class="section" id="example-of-gnatmem-usage">
<span id="id62"></span><h4><span class="section-number">6.7.3.3. </span>Example of <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> Usage<a class="headerlink" href="#example-of-gnatmem-usage" title="Permalink to this headline">¶</a></h4>
<p>The following example shows the use of <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code>
on a simple memory-leaking program.
Suppose that we have the following Ada program:</p>
<blockquote>
<div><div class="highlight-ada notranslate"><div class="highlight"><pre><span></span><span class="kr">with</span><span class="p"> </span><span class="n">Unchecked_Deallocation</span><span class="p">;</span>
<span class="k">procedure </span><span class="nf">Test_Gm</span> <span class="kr">is</span><span class="p"></span>

   <span class="kr">type</span><span class="p"> </span><span class="n">T</span> <span class="kr">is</span><span class="p"> </span><span class="kr">array</span><span class="p"> </span><span class="o">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">1000</span><span class="o">)</span> <span class="kr">of</span><span class="p"> </span><span class="n">Integer</span><span class="p">;</span>
   <span class="kr">type</span><span class="p"> </span><span class="n">Ptr</span> <span class="kr">is</span><span class="p"> </span><span class="kr">access</span><span class="p"> </span><span class="n">T</span><span class="p">;</span>
   <span class="k">procedure </span><span class="nf">Free</span> <span class="kr">is</span><span class="p"> </span><span class="kr">new</span><span class="p"> </span><span class="n">Unchecked_Deallocation</span> <span class="o">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Ptr</span><span class="o">)</span><span class="p">;</span>
   <span class="n">A</span> <span class="o">:</span> <span class="n">Ptr</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">My_Alloc</span> <span class="kr">is</span><span class="p"></span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">A</span> <span class="o">:=</span> <span class="kr">new</span><span class="p"> </span><span class="n">T</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">My_Alloc</span><span class="p">;</span>

   <span class="k">procedure </span><span class="nf">My_DeAlloc</span> <span class="kr">is</span><span class="p"></span>
      <span class="n">B</span> <span class="o">:</span> <span class="n">Ptr</span> <span class="o">:=</span> <span class="n">A</span><span class="p">;</span>
   <span class="kr">begin</span><span class="p"></span>
      <span class="n">Free</span> <span class="o">(</span><span class="n">B</span><span class="o">)</span><span class="p">;</span>
   <span class="k">end </span><span class="nf">My_DeAlloc</span><span class="p">;</span>

<span class="kr">begin</span><span class="p"></span>
   <span class="n">My_Alloc</span><span class="p">;</span>
   <span class="kr">for</span><span class="p"> </span><span class="n">I</span> <span class="kr">in</span><span class="p"> </span><span class="mi">1</span> <span class="o">..</span> <span class="mi">5</span> <span class="kr">loop</span><span class="p"></span>
      <span class="kr">for</span><span class="p"> </span><span class="n">J</span> <span class="kr">in</span><span class="p"> </span><span class="n">I</span> <span class="o">..</span> <span class="mi">5</span> <span class="kr">loop</span><span class="p"></span>
         <span class="n">My_Alloc</span><span class="p">;</span>
      <span class="k">end loop</span><span class="p">;</span>
      <span class="n">My_Dealloc</span><span class="p">;</span>
   <span class="k">end loop</span><span class="p">;</span>
<span class="kr">end</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<p>The program needs to be compiled with the debugging option and linked with
the <code class="docutils literal notranslate"><span class="pre">gmem</span></code> library:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmake -g test_gm -largs -lgmem
</pre></div>
</div>
</div></blockquote>
<p>Then we execute the program as usual:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ test_gm
</pre></div>
</div>
</div></blockquote>
<p>Then <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> is invoked simply with</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmem test_gm
</pre></div>
</div>
</div></blockquote>
<p>which produces the following output (result may vary on different platforms):</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Global</span> <span class="n">information</span>
<span class="o">------------------</span>
   <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">allocations</span>        <span class="p">:</span>  <span class="mi">18</span>
   <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">deallocations</span>      <span class="p">:</span>   <span class="mi">5</span>
   <span class="n">Final</span> <span class="n">Water</span> <span class="n">Mark</span> <span class="p">(</span><span class="n">non</span> <span class="n">freed</span> <span class="n">mem</span><span class="p">)</span>   <span class="p">:</span>  <span class="mf">53.00</span> <span class="n">Kilobytes</span>
   <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span>                    <span class="p">:</span>  <span class="mf">56.90</span> <span class="n">Kilobytes</span>

<span class="n">Allocation</span> <span class="n">Root</span> <span class="c1"># 1</span>
<span class="o">-------------------</span>
 <span class="n">Number</span> <span class="n">of</span> <span class="n">non</span> <span class="n">freed</span> <span class="n">allocations</span>    <span class="p">:</span>  <span class="mi">11</span>
 <span class="n">Final</span> <span class="n">Water</span> <span class="n">Mark</span> <span class="p">(</span><span class="n">non</span> <span class="n">freed</span> <span class="n">mem</span><span class="p">)</span>   <span class="p">:</span>  <span class="mf">42.97</span> <span class="n">Kilobytes</span>
 <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span>                    <span class="p">:</span>  <span class="mf">46.88</span> <span class="n">Kilobytes</span>
 <span class="n">Backtrace</span>                          <span class="p">:</span>
   <span class="n">test_gm</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">11</span> <span class="n">test_gm</span><span class="o">.</span><span class="n">my_alloc</span>

<span class="n">Allocation</span> <span class="n">Root</span> <span class="c1"># 2</span>
<span class="o">-------------------</span>
 <span class="n">Number</span> <span class="n">of</span> <span class="n">non</span> <span class="n">freed</span> <span class="n">allocations</span>    <span class="p">:</span>   <span class="mi">1</span>
 <span class="n">Final</span> <span class="n">Water</span> <span class="n">Mark</span> <span class="p">(</span><span class="n">non</span> <span class="n">freed</span> <span class="n">mem</span><span class="p">)</span>   <span class="p">:</span>  <span class="mf">10.02</span> <span class="n">Kilobytes</span>
 <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span>                    <span class="p">:</span>  <span class="mf">10.02</span> <span class="n">Kilobytes</span>
 <span class="n">Backtrace</span>                          <span class="p">:</span>
   <span class="n">s</span><span class="o">-</span><span class="n">secsta</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">81</span> <span class="n">system</span><span class="o">.</span><span class="n">secondary_stack</span><span class="o">.</span><span class="n">ss_init</span>

<span class="n">Allocation</span> <span class="n">Root</span> <span class="c1"># 3</span>
<span class="o">-------------------</span>
 <span class="n">Number</span> <span class="n">of</span> <span class="n">non</span> <span class="n">freed</span> <span class="n">allocations</span>    <span class="p">:</span>   <span class="mi">1</span>
 <span class="n">Final</span> <span class="n">Water</span> <span class="n">Mark</span> <span class="p">(</span><span class="n">non</span> <span class="n">freed</span> <span class="n">mem</span><span class="p">)</span>   <span class="p">:</span>  <span class="mi">12</span> <span class="n">Bytes</span>
 <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span>                    <span class="p">:</span>  <span class="mi">12</span> <span class="n">Bytes</span>
 <span class="n">Backtrace</span>                          <span class="p">:</span>
   <span class="n">s</span><span class="o">-</span><span class="n">secsta</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">181</span> <span class="n">system</span><span class="o">.</span><span class="n">secondary_stack</span><span class="o">.</span><span class="n">ss_init</span>
</pre></div>
</div>
</div></blockquote>
<p>Note that the GNAT runtime contains itself a certain number of
allocations that have no  corresponding deallocation,
as shown here for root #2 and root #3.
This is a normal behavior when the number of non-freed allocations
is one, it allocates dynamic data structures that the run time needs for
the complete lifetime of the program. Note also that there is only one
allocation root in the user program with a single line back trace:
test_gm.adb:11 test_gm.my_alloc, whereas a careful analysis of the
program shows that ‘My_Alloc’ is called at 2 different points in the
source (line 21 and line 24). If those two allocation roots need to be
distinguished, the backtrace depth parameter can be used:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gnatmem 3 test_gm
</pre></div>
</div>
</div></blockquote>
<p>which will give the following output:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Global</span> <span class="n">information</span>
<span class="o">------------------</span>
   <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">allocations</span>        <span class="p">:</span>  <span class="mi">18</span>
   <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">deallocations</span>      <span class="p">:</span>   <span class="mi">5</span>
   <span class="n">Final</span> <span class="n">Water</span> <span class="n">Mark</span> <span class="p">(</span><span class="n">non</span> <span class="n">freed</span> <span class="n">mem</span><span class="p">)</span>   <span class="p">:</span>  <span class="mf">53.00</span> <span class="n">Kilobytes</span>
   <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span>                    <span class="p">:</span>  <span class="mf">56.90</span> <span class="n">Kilobytes</span>

<span class="n">Allocation</span> <span class="n">Root</span> <span class="c1"># 1</span>
<span class="o">-------------------</span>
 <span class="n">Number</span> <span class="n">of</span> <span class="n">non</span> <span class="n">freed</span> <span class="n">allocations</span>    <span class="p">:</span>  <span class="mi">10</span>
 <span class="n">Final</span> <span class="n">Water</span> <span class="n">Mark</span> <span class="p">(</span><span class="n">non</span> <span class="n">freed</span> <span class="n">mem</span><span class="p">)</span>   <span class="p">:</span>  <span class="mf">39.06</span> <span class="n">Kilobytes</span>
 <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span>                    <span class="p">:</span>  <span class="mf">42.97</span> <span class="n">Kilobytes</span>
 <span class="n">Backtrace</span>                          <span class="p">:</span>
   <span class="n">test_gm</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">11</span> <span class="n">test_gm</span><span class="o">.</span><span class="n">my_alloc</span>
   <span class="n">test_gm</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">24</span> <span class="n">test_gm</span>
   <span class="n">b_test_gm</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">52</span> <span class="n">main</span>

<span class="n">Allocation</span> <span class="n">Root</span> <span class="c1"># 2</span>
<span class="o">-------------------</span>
 <span class="n">Number</span> <span class="n">of</span> <span class="n">non</span> <span class="n">freed</span> <span class="n">allocations</span>    <span class="p">:</span>   <span class="mi">1</span>
 <span class="n">Final</span> <span class="n">Water</span> <span class="n">Mark</span> <span class="p">(</span><span class="n">non</span> <span class="n">freed</span> <span class="n">mem</span><span class="p">)</span>   <span class="p">:</span>  <span class="mf">10.02</span> <span class="n">Kilobytes</span>
 <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span>                    <span class="p">:</span>  <span class="mf">10.02</span> <span class="n">Kilobytes</span>
 <span class="n">Backtrace</span>                          <span class="p">:</span>
   <span class="n">s</span><span class="o">-</span><span class="n">secsta</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">81</span>  <span class="n">system</span><span class="o">.</span><span class="n">secondary_stack</span><span class="o">.</span><span class="n">ss_init</span>
   <span class="n">s</span><span class="o">-</span><span class="n">secsta</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">283</span> <span class="o">&lt;</span><span class="n">system__secondary_stack___elabb</span><span class="o">&gt;</span>
   <span class="n">b_test_gm</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">33</span>   <span class="n">adainit</span>

<span class="n">Allocation</span> <span class="n">Root</span> <span class="c1"># 3</span>
<span class="o">-------------------</span>
 <span class="n">Number</span> <span class="n">of</span> <span class="n">non</span> <span class="n">freed</span> <span class="n">allocations</span>    <span class="p">:</span>   <span class="mi">1</span>
 <span class="n">Final</span> <span class="n">Water</span> <span class="n">Mark</span> <span class="p">(</span><span class="n">non</span> <span class="n">freed</span> <span class="n">mem</span><span class="p">)</span>   <span class="p">:</span>   <span class="mf">3.91</span> <span class="n">Kilobytes</span>
 <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span>                    <span class="p">:</span>   <span class="mf">3.91</span> <span class="n">Kilobytes</span>
 <span class="n">Backtrace</span>                          <span class="p">:</span>
   <span class="n">test_gm</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">11</span> <span class="n">test_gm</span><span class="o">.</span><span class="n">my_alloc</span>
   <span class="n">test_gm</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">21</span> <span class="n">test_gm</span>
   <span class="n">b_test_gm</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">52</span> <span class="n">main</span>

<span class="n">Allocation</span> <span class="n">Root</span> <span class="c1"># 4</span>
<span class="o">-------------------</span>
 <span class="n">Number</span> <span class="n">of</span> <span class="n">non</span> <span class="n">freed</span> <span class="n">allocations</span>    <span class="p">:</span>   <span class="mi">1</span>
 <span class="n">Final</span> <span class="n">Water</span> <span class="n">Mark</span> <span class="p">(</span><span class="n">non</span> <span class="n">freed</span> <span class="n">mem</span><span class="p">)</span>   <span class="p">:</span>  <span class="mi">12</span> <span class="n">Bytes</span>
 <span class="n">High</span> <span class="n">Water</span> <span class="n">Mark</span>                    <span class="p">:</span>  <span class="mi">12</span> <span class="n">Bytes</span>
 <span class="n">Backtrace</span>                          <span class="p">:</span>
   <span class="n">s</span><span class="o">-</span><span class="n">secsta</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">181</span> <span class="n">system</span><span class="o">.</span><span class="n">secondary_stack</span><span class="o">.</span><span class="n">ss_init</span>
   <span class="n">s</span><span class="o">-</span><span class="n">secsta</span><span class="o">.</span><span class="n">adb</span><span class="p">:</span><span class="mi">283</span> <span class="o">&lt;</span><span class="n">system__secondary_stack___elabb</span><span class="o">&gt;</span>
   <span class="n">b_test_gm</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">33</span>   <span class="n">adainit</span>
</pre></div>
</div>
</div></blockquote>
<p>The allocation root #1 of the first example has been split in 2 roots #1
and #3, thanks to the more precise associated backtrace.</p>
</div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../gnat_ugn.html">
              <img class="logo" src="../_static/adacore_transparent.png" alt="Logo"/>
            </a></p>
  <h3><a href="../gnat_ugn.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6. GNAT and Program Execution</a><ul>
<li><a class="reference internal" href="#running-and-debugging-ada-programs">6.1. Running and Debugging Ada Programs</a><ul>
<li><a class="reference internal" href="#the-gnat-debugger-gdb">6.1.1. The GNAT Debugger GDB</a></li>
<li><a class="reference internal" href="#running-gdb">6.1.2. Running GDB</a></li>
<li><a class="reference internal" href="#introduction-to-gdb-commands">6.1.3. Introduction to GDB Commands</a></li>
<li><a class="reference internal" href="#using-ada-expressions">6.1.4. Using Ada Expressions</a></li>
<li><a class="reference internal" href="#calling-user-defined-subprograms">6.1.5. Calling User-Defined Subprograms</a></li>
<li><a class="reference internal" href="#using-the-next-command-in-a-function">6.1.6. Using the <em>next</em> Command in a Function</a></li>
<li><a class="reference internal" href="#stopping-when-ada-exceptions-are-raised">6.1.7. Stopping When Ada Exceptions Are Raised</a></li>
<li><a class="reference internal" href="#ada-tasks">6.1.8. Ada Tasks</a></li>
<li><a class="reference internal" href="#debugging-generic-units">6.1.9. Debugging Generic Units</a></li>
<li><a class="reference internal" href="#remote-debugging-with-gdbserver">6.1.10. Remote Debugging with gdbserver</a></li>
<li><a class="reference internal" href="#gnat-abnormal-termination-or-failure-to-terminate">6.1.11. GNAT Abnormal Termination or Failure to Terminate</a></li>
<li><a class="reference internal" href="#naming-conventions-for-gnat-source-files">6.1.12. Naming Conventions for GNAT Source Files</a></li>
<li><a class="reference internal" href="#getting-internal-debugging-information">6.1.13. Getting Internal Debugging Information</a></li>
<li><a class="reference internal" href="#stack-traceback">6.1.14. Stack Traceback</a><ul>
<li><a class="reference internal" href="#non-symbolic-traceback">6.1.14.1. Non-Symbolic Traceback</a></li>
<li><a class="reference internal" href="#symbolic-traceback">6.1.14.2. Symbolic Traceback</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pretty-printers-for-the-gnat-runtime">6.1.15. Pretty-Printers for the GNAT runtime</a></li>
</ul>
</li>
<li><a class="reference internal" href="#profiling">6.2. Profiling</a><ul>
<li><a class="reference internal" href="#profiling-an-ada-program-with-gprof">6.2.1. Profiling an Ada Program with gprof</a><ul>
<li><a class="reference internal" href="#compilation-for-profiling">6.2.1.1. Compilation for profiling</a></li>
<li><a class="reference internal" href="#program-execution">6.2.1.2. Program execution</a></li>
<li><a class="reference internal" href="#running-gprof">6.2.1.3. Running gprof</a></li>
<li><a class="reference internal" href="#interpretation-of-profiling-results">6.2.1.4. Interpretation of profiling results</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#improving-performance">6.3. Improving Performance</a><ul>
<li><a class="reference internal" href="#performance-considerations">6.3.1. Performance Considerations</a><ul>
<li><a class="reference internal" href="#controlling-run-time-checks">6.3.1.1. Controlling Run-Time Checks</a></li>
<li><a class="reference internal" href="#use-of-restrictions">6.3.1.2. Use of Restrictions</a></li>
<li><a class="reference internal" href="#optimization-levels">6.3.1.3. Optimization Levels</a></li>
<li><a class="reference internal" href="#debugging-optimized-code">6.3.1.4. Debugging Optimized Code</a></li>
<li><a class="reference internal" href="#inlining-of-subprograms">6.3.1.5. Inlining of Subprograms</a></li>
<li><a class="reference internal" href="#floating-point-operations">6.3.1.6. Floating Point Operations</a></li>
<li><a class="reference internal" href="#vectorization-of-loops">6.3.1.7. Vectorization of loops</a></li>
<li><a class="reference internal" href="#other-optimization-switches">6.3.1.8. Other Optimization Switches</a></li>
<li><a class="reference internal" href="#optimization-and-strict-aliasing">6.3.1.9. Optimization and Strict Aliasing</a></li>
<li><a class="reference internal" href="#aliased-variables-and-optimization">6.3.1.10. Aliased Variables and Optimization</a></li>
<li><a class="reference internal" href="#atomic-variables-and-optimization">6.3.1.11. Atomic Variables and Optimization</a></li>
<li><a class="reference internal" href="#passive-task-optimization">6.3.1.12. Passive Task Optimization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#text-io-suggestions">6.3.2. <code class="docutils literal notranslate"><span class="pre">Text_IO</span></code> Suggestions</a></li>
<li><a class="reference internal" href="#reducing-size-of-executables-with-unused-subprogram-data-elimination">6.3.3. Reducing Size of Executables with Unused Subprogram/Data Elimination</a><ul>
<li><a class="reference internal" href="#about-unused-subprogram-data-elimination">6.3.3.1. About unused subprogram/data elimination</a></li>
<li><a class="reference internal" href="#compilation-options">6.3.3.2. Compilation options</a></li>
<li><a class="reference internal" href="#example-of-unused-subprogram-data-elimination">6.3.3.3. Example of unused subprogram/data elimination</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#overflow-check-handling-in-gnat">6.4. Overflow Check Handling in GNAT</a><ul>
<li><a class="reference internal" href="#background">6.4.1. Background</a></li>
<li><a class="reference internal" href="#management-of-overflows-in-gnat">6.4.2. Management of Overflows in GNAT</a></li>
<li><a class="reference internal" href="#specifying-the-desired-mode">6.4.3. Specifying the Desired Mode</a></li>
<li><a class="reference internal" href="#default-settings">6.4.4. Default Settings</a></li>
<li><a class="reference internal" href="#implementation-notes">6.4.5. Implementation Notes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performing-dimensionality-analysis-in-gnat">6.5. Performing Dimensionality Analysis in GNAT</a></li>
<li><a class="reference internal" href="#stack-related-facilities">6.6. Stack Related Facilities</a><ul>
<li><a class="reference internal" href="#stack-overflow-checking">6.6.1. Stack Overflow Checking</a></li>
<li><a class="reference internal" href="#static-stack-usage-analysis">6.6.2. Static Stack Usage Analysis</a></li>
<li><a class="reference internal" href="#dynamic-stack-usage-analysis">6.6.3. Dynamic Stack Usage Analysis</a></li>
</ul>
</li>
<li><a class="reference internal" href="#memory-management-issues">6.7. Memory Management Issues</a><ul>
<li><a class="reference internal" href="#some-useful-memory-pools">6.7.1. Some Useful Memory Pools</a></li>
<li><a class="reference internal" href="#the-gnat-debug-pool-facility">6.7.2. The GNAT Debug Pool Facility</a></li>
<li><a class="reference internal" href="#the-gnatmem-tool">6.7.3. The <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> Tool</a><ul>
<li><a class="reference internal" href="#running-gnatmem">6.7.3.1. Running <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code></a></li>
<li><a class="reference internal" href="#switches-for-gnatmem">6.7.3.2. Switches for <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code></a></li>
<li><a class="reference internal" href="#example-of-gnatmem-usage">6.7.3.3. Example of <code class="docutils literal notranslate"><span class="pre">gnatmem</span></code> Usage</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="gnat_utility_programs.html"
                        title="previous chapter"><span class="section-number">5. </span>GNAT Utility Programs</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="platform_specific_information.html"
                        title="next chapter">Platform-Specific Information</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/gnat_ugn/gnat_and_program_execution.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="platform_specific_information.html" title="Platform-Specific Information"
             >next</a> |</li>
        <li class="right" >
          <a href="gnat_utility_programs.html" title="5. GNAT Utility Programs"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../gnat_ugn.html">GNAT User&#39;s Guide for Native Platforms 2021 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">6. </span>GNAT and Program Execution</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2008-2021, Free Software Foundation.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>